<!DOCTYPE html>
<html  xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head th:include="_header_include::frag(~{::title},~{},~{})">
    <title>发布公告</title>
</head>

<body>
<div id="form" class="mainPadding" style="display: none;">
    <el-breadcrumb separator="/" class="elBreadcrumb marginB20">
        <el-breadcrumb-item>Home</el-breadcrumb-item>
        <el-breadcrumb-item>系统管理</el-breadcrumb-item>
        <el-breadcrumb-item><a href="JavaScript:void(0)" data-url="b.html">公告管理</a></el-breadcrumb-item>
    </el-breadcrumb>
    <!--<p style="text-indent: 2em;line-height: 20px">发布公告</p>-->
    <el-form :model="annForm"  :rules="rules" ref="annForm" label-width="100px" class="demo-annForm" >
        <el-form-item label="公告标题" prop="title"  style="width: 60%;">
            <el-input v-model="annForm.title" type="text" maxlength="100" size="small"></el-input>
        </el-form-item>

        <el-form-item label="公告接收" prop="type" >
            <el-checkbox-group v-model="annForm.type">
                <el-checkbox label="1" name="type">站内公告通知</el-checkbox>
                <!--<el-checkbox label="2" name="type">短信</el-checkbox>-->
            </el-checkbox-group>
        </el-form-item>

        <el-form-item  label="接收范围">
                <el-col :span="5">
                    <el-form-item  prop="redio" >
                    <el-radio-group v-model="annForm.radio" @change="redioChange">
                    <el-radio  label="0">系统全用户</el-radio>
                    <el-radio  label="1">指定组织</el-radio>
                    </el-radio-group>
                    </el-form-item>
                </el-col>
                <el-col :span="6">
                    <el-form-item prop="org" id="org" style="display: none">
                    <el-input v-model="annForm.org"   size="small"  readonly placeholder="请选择指定组织">
                        <el-button slot="append"  @click="selectOrgs">选择组织</el-button> <!--icon="el-icon-search"-->
                    </el-input>
                    </el-form-item>
                </el-col>
        </el-form-item>

        <el-form-item label="公告内容" prop="content"  style="width: 60%;">
            <el-input type="textarea" v-model="annForm.content"
                      :autosize="{ minRows: 10, maxRows: 50}" maxlength="500"></el-input>
        </el-form-item>

        <el-form-item style="width:60%; text-align:center;">
            <el-button type="primary" @click="submitForm('annForm')" :disabled="isDisabled">提交</el-button>
            <el-button @click="reListPage">取消</el-button>
        </el-form-item>
    </el-form>
    <el-dialog :visible.sync="OraTreeMuliCheckDialog" title="选择组织"  width="30%" >
        <div style="height: 300px;overflow-y:auto;overflow-x:auto;">
            <el-tree
                    :data="dataTree"
                    node-key="id"
                    :default-expanded-keys="expandedKeys"
                    :default-checked-keys="multipleSelection"
                    :check-strictly="true"
                    ref="tree"
                    show-checkbox
                    highlight-current
                    :expand-on-click-node=false
                    @check="handleSelectionChange"
                    class="leftTree">
            </el-tree>    <!-- @check-change="handleCheckChange"-->
        </div>
        <span slot="footer" class="dialog-footer" align="center">
            <el-button type="primary" @click="returnCheckNodekeys">提 交</el-button>
            <el-button @click="closeOraTreeMultiCheck">取 消</el-button>
        </span>
    </el-dialog>
</div>

<div th:include="_footer_include :: #jsLib"></div>

<script>
    Array.prototype.remove = function(val) {
        var index = this.indexOf(val);
        if (index > -1) {
            this.splice(index, 1);
        }
    };

    var vm = new Vue({
        el:'#form',
        data:{
            isDisabled:false,
            expandedKeys:[],
            dataTree:[],
            OraTreeMuliCheckDialog: false,
            multipleSelection:[],
            multipleSelectionName:[],
            annForm: {
                title: "",
                type: ["1"],
                content:"",
                radio:"0",
                org:""
            },
            rules: {
                title: [
                    { required: true, message: '标题不能为空', trigger: 'blur' },
                    { min: 1, max: 100, message: '长度在 1 到  100 个字符', trigger: 'blur' }
                ],
                type: [
                    { type: 'array', required: true, message: '请至少选择一个接收方式', trigger: 'change' }
                ],
                redio: [ // 默认选中则一定不会为空
                ],
                content: [
                    { required: true, message: '公告内容不能为空', trigger: 'blur' },
                    { min: 1, max: 500, message: '长度在 1 到 500 个字符', trigger: 'blur' }
                ]
            },

        },
        methods:{
            reListPage:function(){
                window.location.href = '/ann/annPublishPage'
            },
            selectOrgs:function(){
                console.log("--------选择组织结构---多选-------------")
                if(vm.annForm.radio!=1){
                    vm.$message( {type: 'warning',message:'接收范围为：指定组织，才能选择组织机构！'});
                    return false
                }
            //  打开 组织机构多选框
                vm.OraTreeMuliCheckDialog = true;
                var param = {};
                axios.post("/organization/organization/query", param).then(function (response) {
                    console.log(response.data)
                    vm.expandedKeys = [];
                    vm.dataTree = response.data.data;
                    for(var i=0;i<vm.dataTree.length;i++){
                        var curNode = vm.dataTree[i];
                        vm.expandedKeys.push(curNode.id);
                        var childs = curNode.children;
                        if(childs){
                            for(var j=0;j<childs.length;j++){
                                var curChildNode = childs[j];
                                vm.expandedKeys.push(curChildNode.id);
                            }
                        }
                    }
                }).catch(function (error) { console.log(error);});
            },
            handleCheckChange(currentNode,isCheck,childsCheck){
                console.log("bababbababababababbabababab")
            },
            handleSelectionChange(currentNode,allCheckNodes) {//选择节点的事件
                console.log(currentNode)
                var flag = true;
                // this.multipleSelection
                var v_selection = allCheckNodes.checkedKeys;  // 获取已经勾选的id
                var v_selectName= [];
                var nodes = allCheckNodes.checkedNodes;
                for(var i = 0 ; i < nodes.length ; i++){   //获取已经勾选的name
                    v_selectName.push(nodes[i].label)
                }


               var childsSeting=function(vnode){
                    for(var i = 0 ; i < vnode.children.length;i++){
                        v_selection.remove(vnode.children[i].id)
                        v_selectName.remove(vnode.children[i].label)
                        v_selection.push(vnode.children[i].id)
                        v_selectName.push(vnode.children[i].label)
                        if(vnode.children[i].children) {
                            childsSeting(vnode.children[i])
                        }
                    }
                }

                //遍历放入子节点
                for(var i = 0 ; i < nodes.length ; i++){
                    if(currentNode.id==nodes[i].id){
                        flag = false;
                        if(currentNode.children) {
                            childsSeting(currentNode)
                        }
                    }
                }

                var childsRemoving=function(vnode){
                    for(var i = 0 ; i < vnode.children.length;i++){
                        v_selection.remove(vnode.children[i].id)
                        v_selectName.remove(vnode.children[i].label)
                        if(vnode.children[i].children) {
                            childsRemoving(vnode.children[i])
                        }
                    }
                }

                //遍历移除子节点
                if(flag){
                    var id =  "";
                    var label = "";
                    if(currentNode.children){
                        childsRemoving(currentNode)
                    }
                }

                this.multipleSelection = v_selection
                this.multipleSelectionName = v_selectName
                console.log(this.multipleSelection)
                console.log(this.multipleSelectionName)
                //设置勾选
                this.$refs.tree.setCheckedNodes(v_selection);
            },
            returnCheckNodekeys(){
                console.log(this.multipleSelection.length)
                if( this.multipleSelection.length ==0){
                    this.$message({type:"warning",message:"请选择组织结构"})
                    return false;
                }
                var names = this.multipleSelectionName.join(',')
                console.log(names)
                vm.annForm.org = names
                this.OraTreeMuliCheckDialog = false
            },
            redioChange:function(val){

                if(val==0){//全体用户
                    console.log("选择了全体用户")
                    document.getElementById("org").setAttribute('style', 'display:none');
                    vm.multipleSelection =[];
                    vm.multipleSelectionName = [];
                }else{//指定组织:多选
                    document.getElementById("org").setAttribute('style', 'display:block');
                    console.log("选择了指定组织")
                }
            },
            submitForm(formName) {
                console.log()
                if(vm.annForm.radio==1&&vm.annForm.org==""){
                    vm.$message.error('请选择指定组织');
                    return false;
                }
                this.$refs[formName].validate((valid) => {
                    if (valid) {
                        vm.isDisabled = true;
                        var formData = vm.annForm;
                        var param={};
                        param.title = formData.title;
                        param.content = formData.content;
                        if(formData.radio==0){
                            param.orgId = 0;
                        }else{
                            param.orgId = 1;
                            param.orgids = this.multipleSelection;
                        }
                        console.log(formData.type.length)
                        console.log(formData.type)
                        if(formData.type.length == 2){
                            param.type = 0;
                        }else{
                            param.type = formData.type[0];
                        }

                        console.log("=---P----_---P----=")
                        console.log(param)


                        axios.post("/ann/publishAnn", param)
                            .then(function (response) {
                                if(response.data.code==0){
                                    vm.$message({type: 'success',message:'提交成功',duration:2000,onClose:function(){
                                        window.location.href = '/ann/annlistPage'
                                    }});
                                }else{
                                    vm.$message.error(response.data.msg);
                                }
                            })
                            .catch(function (error) {
                                console.log(error);
                            });

                    } else {
                        console.log('数据未通过校验！');
                        return false;
                    }
                });
            },
            resetForm(formName) {
                this.$refs[formName].resetFields();
            },
            closeOraTreeMultiCheck(){
                this.OraTreeMuliCheckDialog = false
            }
        },
        created(){
            console.info("create method");
           // this.getFormData();
        },
        mounted(){
            console.info("mounted method");
            document.getElementById('form').style.display = 'block';
        }
    });

</script>
<style>
    .el-button{
        /*background: #cccccc;*/
    }
    .el-button--primary {
       /* background-color: #6f7180;
        border: #6f7180;*/
    }
    .el-dialog__header {
        background-color: #cccccc;
    }
    .el-dialog__footer {
        text-align: center;
    }

</style>
</body>

</html>