<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  xmlns:th="http://www.thymeleaf.org" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<head th:replace="_header_include::frag(~{::title},~{::style},~{})">
    <title>后台管理系统</title>
    <meta charset="UTF-8">
    <!-- import CSS -->
    <link rel="stylesheet" href="css/element-ui.css">
    <link rel="stylesheet" href="css/base.css">
    <style>
    </style>
</head>
<body>
<div id="optimizeClueManagement" class="optimizeClueManagement mainPadding" style="display: none;">
    <el-breadcrumb separator="/" class="elBreadcrumb marginB20">
        <el-breadcrumb-item>Home</el-breadcrumb-item>
        <el-breadcrumb-item>充值管理</el-breadcrumb-item>
        <el-breadcrumb-item>公司占比设置</el-breadcrumb-item>
    </el-breadcrumb>  
    <div class="mainSearchBg">
        <el-row>
            <el-form :model="form" label-width="100px" class="demo-dynamic">
                <el-table
                    ref="multipleTable"
                    tooltip-effect="dark"
                    style="width: 100%"
                    border
                    :data="form.dataTable"
                    @selection-change="handleSelectionChange"
                >
                    <!-- <el-table-column align="center" type="selection" width="55"></el-table-column> -->
                    <el-table-column align="center" type="index" label="序号"  width="55"></el-table-column>
                    <el-table-column align="center" prop="merchantUserName" label="商家名称"></el-table-column>    
                    <el-table-column align="center" prop="companyNames" label="分公司"></el-table-column>
                    <el-table-column align="center" label="消费占比">
                        <template slot-scope="scope">
                            <el-form-item v-for="item in scope.row.inputValArr" style="width: 50px;float: left;margin-right: 10px;">
                                <el-input v-model="item.val" maxLength="3" style="width: 40px;float: left;margin-right: 7px;"></el-input><span>{{item.index}}</span>
                            </el-form-item>
                            <el-button size="mini" type="success" @click="update(scope.row,scope.row.id)" v-if="scope.row.isShowBtn">修改比例</el-button>
                        </template>
                    </el-table-column>
                </el-table>
            </el-form>
        </el-row>
    </div>
</div>
</body>
<!-- import Vue before Element -->
<div th:include="_footer_include :: #jsLib"></div>

<!-- import common js-->
<script th:inline="javascript">
    var merchantUserList=[[${groupList}]];//商户集合
    var ocmVM = new Vue({
        el: '#optimizeClueManagement',
        data: function() {
            return {                
                multipleSelection: [],//选择行
                pager:{
                  total: 0,
                  currentPage: 1,
                  pageSize: 20,
                },
                form: {
                    dataTable: [],
                },
                formLabelWidth: '120px',
                dataTable: [],
                merchantUserListOptions:merchantUserList,
            }        	  
        },
        methods: {
            gotoSetting(){
                window.location.href='/merchant/consumeRecord/initSingleMerchant?mainAccountId';
            },
            clickRow(row){
                this.$refs.multipleTable.toggleRowSelection(row)
            },
            handleSelectionChange(val) {//选择节点的事件
                // console.log(val)
                this.multipleSelection = val;
            },
            handleStart(index, row) {
                console.log(index, row);
            },
            handleForbid(index, row) {
                console.log(index, row);
            }, 
            //修改比例
            update(row,id) {
                console.log(row)
                
            },
            searchTable() {
            	var param ={};
                axios.post('/merchant/monthConsumeStatistics/getPercentageSettingList', param)
                .then(function (response) {
                    console.log(response)
                    var result =  response.data.data;
                    console.log(result)
                    function getValList(item) {
                        var name1List = item.companyNames;
                        if(name1List){
                            name1List=name1List.split(",");                        
                        }else{
                            name1List=[];
                        }
                        var inputValList = item.proportion
                        if(inputValList){
                        inputValList=inputValList.split(",");
                        }else{
                            inputValList=[]
                        }
                        return name1List.map((item, index) => {
                            var obj = {};
                            obj.name = item;
                            if(inputValList.length>0){
                                obj.val = inputValList[index]; 
                            }else{
                                obj.val=""
                            }
                        
                            if(name1List.length>index+1){
                                obj.index = ":";
                            }else{
                                obj.index = "";
                            }                        
                            return obj;
                      });
                    }
                    function handleData(dataTable) {
                      // var res = JSON.parse(JSON.stringify(dataTable));
                      // res.forEach(item => {
                      dataTable.forEach(item => {  
                        item.inputValArr = getValList(item)
                      });
                      // return res;
                      return dataTable;
                    }
                    console.log(handleData(result))
                    ocmVM.form.dataTable=handleData(result);
                    // 有分公司显示修改比例
                    for(i=0;i<ocmVM.form.dataTable.length;i++){
                        ocmVM.form.dataTable[i].isShowBtn=false;
                        if(ocmVM.form.dataTable[i].companyNames){
                            ocmVM.form.dataTable[i].isShowBtn=true;
                        }
                    }
                })
                .catch(function (error) {
                     console.log(error);
                });
                
            },

        },
        created(){
            var localVal=localStorage.getItem('allChangePageSize')?parseInt(localStorage.getItem('allChangePageSize')):'';
            if(localVal){this.pager.pageSize = localVal;}
            // console.info("create method");
            this.searchTable();
        },
        mounted(){
            document.getElementById('optimizeClueManagement').style.display = 'block';
        }
  })
</script>
</html>