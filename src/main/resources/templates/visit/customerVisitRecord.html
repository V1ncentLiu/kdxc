<!DOCTYPE html>
<html>
<head th:include="_header_include::frag(~{::title},~{},~{})">
    <title>客户到访记录</title>
    <style>
        button a{color:#fff!important;}
    </style>
</head>
<body>
<div id="customerVisitRecord" class="customerVisitRecord mainPadding" style="display: none;">  
    <el-breadcrumb separator="/" class="elBreadcrumb marginB20">
        <el-breadcrumb-item>Home</el-breadcrumb-item>
        <el-breadcrumb-item>商务管理</el-breadcrumb-item>
        <el-breadcrumb-item>客户到访记录</el-breadcrumb-item>
    </el-breadcrumb>
    <el-row class="marginB10">
    	<el-tabs type="card" v-model="activeName" @tab-click="handleClick" >
			<el-tab-pane label="到访记录" name="first"></el-tab-pane>
			<el-tab-pane label="未到访记录" name="second"></el-tab-pane>
		</el-tabs>
       <shiro:hasPermission name=" aggregation:visitRecord:reject">
        <el-button type="primary" @click="OpenRejectVisitRecordDialog">驳回</el-button>
        </shiro:hasPermission>
         <shiro:hasPermission name=" aggregation:visitRecord:pass">
                <el-button type="success" @click="pass">审核通过</el-button>
         </shiro:hasPermission>
    </el-row>
    <el-row class="marginB10 greybg padding20" style="padding-bottom: 0">        
        <el-form :inline="true" :model="form" ref="form">
            <el-form-item label="">
                <el-select v-model="form.projectId" placeholder="考察项目" style="width: 100%;" clearable>
                    <el-option
                        v-for="item in projectList"
                        :key="item.id"
                        :label="item.projectName"
                        :value="item.id">
                    </el-option>
                </el-select>
            </el-form-item> 
            <el-form-item label="">  
                <el-select v-model="form.busGroupId" placeholder="商务小组" style="width: 100%;" clearable>
                    <el-option
                        v-for="item in businessGroupList"
                        :key="item.id"
                        :label="item.name"
                        :value="item.id">
                    </el-option>
                </el-select>
            </el-form-item>    
            <el-form-item label="">  
                <el-select v-model="form.busManagerId" placeholder="商务经理" style="width: 100%;" clearable>
                    <el-option
                        v-for="item in busManagerList"
                        :key="item.id"
                        :label="item.name"
                        :value="item.id">
                    </el-option>
                </el-select>
            </el-form-item>   
            <el-form-item label="">  
                <el-select v-model="form.signProvince" placeholder="签约省份" style="width: 100%;" clearable>
                    <el-option
                        v-for="item in proviceList"
                        :key="item.id"
                        :label="item.name"
                        :value="item.name">
                    </el-option>
                </el-select>
            </el-form-item>   
            <el-form-item label="">  
                <el-select v-model="form.status" placeholder="到访有效性" style="width: 100%;" clearable>
                    <el-option
                        v-for="item in visitEffStatusOpt"
                        :key="item.value"
                        :label="item.label"
                        :value="item.value">
                    </el-option>
                </el-select>
            </el-form-item>   
            <el-form-item label="">  
                <el-select v-model="form.isSign" placeholder="是否签约" style="width: 100%;" clearable>
                    <el-option
                        v-for="item in signStatusOpt"
                        :key="item.value"
                        :label="item.label"
                        :value="item.value">
                    </el-option>
                </el-select>
            </el-form-item>            
            <el-form-item label="到访时间:">
                <el-date-picker
                    style="width: 100%;"
                    v-model="form.visitStartTime"
                    type="datetime"
                    placeholder="选择日期时间">
                </el-date-picker>
            </el-form-item>
            <el-form-item label="——">
                <el-date-picker
                    style="width: 100%;"
                    v-model="form.visitEndTime"
                    type="datetime"
                    placeholder="选择日期时间">
                </el-date-picker>
            </el-form-item>
            <el-form-item label="">  
                <el-select v-model="form.companyId" placeholder="考察公司" style="width: 100%;" clearable>
                    <el-option
                        v-for="item in companyList"
                        :key="item.id"
                        :label="item.name"
                        :value="item.id">
                    </el-option>
                </el-select>
            </el-form-item> 
            <el-form-item label="">
                <el-input v-model="form.customerName" placeholder="客户姓名"></el-input>
            </el-form-item>
            <el-button type="primary" @click="initCustomerVisitRecord">搜索</el-button>               
        </el-form>       
    </el-row>
    <el-row>
        <el-table 
            ref="multipleTable"
            tooltip-effect="dark"
            style="width: 100%"
            height="800px"
            border
            @selection-change="handleSelectionChange"
            v-loading="loading"
            :data="dataTable" 
            >
            <el-table-column align="center" type="selection" width="55"></el-table-column>
            <el-table-column align="center" prop="serialNum" label="序号" width="55"></el-table-column>
            <el-table-column align="center" prop="customerName" label="客户姓名"></el-table-column>  
            <el-table-column align="center" prop="projectName" label="考察项目" width="100"></el-table-column>
            <el-table-column align="center" prop="companyName" label="考察公司"></el-table-column>
            <el-table-column align="center" prop="vistitTime" label="到访时间"></el-table-column>
            <el-table-column align="center" prop="vistitStoreType" label="到访店铺类型" width="120" :formatter="getSignShopTypeText"></el-table-column>
            <el-table-column align="center" prop="visitType" label="到访类型" :formatter="getVisitTypeText"></el-table-column>
            <el-table-column align="center" prop="visitCity" label="来访城市"></el-table-column> 
            <el-table-column align="center" prop="signProvince" label="预签约省份" width="100"></el-table-column> 
            <el-table-column align="center" prop="signCity" label="预签约城市" width="100"></el-table-column>   
            <el-table-column align="center" prop="signDistrict" label="预签约区／县" width="120"></el-table-column>
            <el-table-column align="center" prop="businessGroupName" label="商务小组"></el-table-column> 
            <el-table-column align="center" prop="businessManagerName" label="商务经理" width="100"></el-table-column>
            <el-table-column align="center" prop="teleGroupName" label="电销组"></el-table-column> 
            <el-table-column align="center" prop="teleSaleName" label="创业顾问"></el-table-column> 
            <el-table-column align="center" prop="isSign" label="是否签约" width="100">
                <template slot-scope="scope">
                 <span v-if="scope.row.isSign===0">
                            否&nbsp;<el-button @click="notSignedReasonClick(scope.row)" type="text">未签约原因</el-button>
                 </span>
                 <span v-else-if="scope.row.isSign===1">
                         是
                    </span>
                </template>
            </el-table-column>
             <el-table-column align="center" prop="createTime" label="创建时间"></el-table-column> 
               <el-table-column align="center" prop="visitCount" label="到访批次" :formatter="getVisitNumText"></el-table-column> 
            <el-table-column align="center" prop="status" label="到访有效性" width="100">
                <template slot-scope="scope">
                 <span v-if="scope.row.status===0">
                    驳回&nbsp;<el-button @click="reasonClick(scope.row)" type="text">驳回原因</el-button>
                     </span>
                               <span v-else-if="scope.row.status===1">
                          待审核
                    </span>
                              <span v-else-if="scope.row.status===2">
                         有效
                    </span> 
                </template>
            </el-table-column>
              
            
        </el-table>
          <table-pagination :pager="pager" @change="initCustomerVisitRecord"></table-pagination>
    </el-row>
    <!-- dialog -->
    <!-- 驳回处理 -->
    <el-dialog title="提示" :visible.sync="dialogFormVisible">
        <el-form :model="dialogForm" ref="dialogForm" :rules="dialogRules">            
            <div class="fs16 marginB20">确定要将此 {{signRecordArrTitle}} 到访记录驳回吗？</div>
            <el-form-item label="驳回原因：" label-width="100px" prop="reason">
                <el-input
                    type="textarea"
                    :rows="4"
                    placeholder="请输入驳回原因"
                    maxLength="100"
                    v-model="dialogForm.reason">
                </el-input>
            </el-form-item>
            <div class="f-tar">最多100字</div>
        </el-form>
        <div slot="footer" class="dialog-footer">
            <el-button type="primary" @click="submitDialogForm('dialogForm')">确 定</el-button>
            <el-button @click="dialogFormVisible = false" >取 消</el-button>
        </div>
    </el-dialog>
    <!-- 驳回原因 -->
    <el-dialog title="驳回原因" :visible.sync="reasonDialog">           
        <div class="fs16 marginB20" >{{rebutReason}} </div>
    </el-dialog>
    <!-- 未签约原因 -->
    <el-dialog title="未签约原因" :visible.sync="notSignedReasonDialog">           
        <div class="fs16 marginB20" >{{notSignReason}}</div>
    </el-dialog>
</div>
</body>
<!-- import Vue before Element -->
<div th:include="_footer_include :: #jsLib"></div>
<script th:inline="javascript">
    var projectList = [[${projectList}]];
    var busManagerList = [[${busManagerList}]];
    var businessGroupList = [[${businessGroupList}]];
    var proviceList = [[${proviceList}]];
    var companyList = [[${companyList}]];
</script>
<script>
  var customerVisitRecordVm =   new Vue({
        el: '#customerVisitRecord',
        data: function() {
            return {
            	activeName: 'first',//tabs:到访记录
            	loading:true,
                dialogFormVisible:false,
                notSignedReasonDialog:false,
                reasonDialog:false,
                form: {
                	projectId:'',
                	busGroupId:'',
                	busManagerId:'',
                	signProvince:'',
                	companyId:'',
                	visitStartTime:'',
                	visitEndTime:'',
                	status:'',
                	cutomerName:'',
                	isSign:''
                },
                formLabelWidth: '150px',
                dataTable: [],
                visitEffStatusOpt: [{
                    value: 0,
                    label: '无效'
                }, {
                    value: 1,
                    label: '待审核'
                }, {
                    value: 2,
                    label: '有效'
                }],
                signStatusOpt: [{
                    value: 0,
                    label: '否'
                }, {
                    value: 1,
                    label: '是'
                }],
                recordTable:[],
                dialogForm:{
                    reason:''
                },
                dialogRules:{
                    reason: [
                        { required: true, message: '请输入驳回原因', trigger: 'blur' }
                    ]
                },
                pager:{//
                    total: 0,
                    currentPage: 1,
                    pageSize: 20,
                },
                projectList:projectList,
                busManagerList:busManagerList,
                businessGroupList:businessGroupList,
                proviceList:proviceList,
                companyList:companyList,
                rebutReason:'',//驳回原因
                multipleSelection:[],
                signRecordArrTitle:'',
                notSignReason:'',//未签约原因
            }        	  
        },
        methods: {
             handleClick(tab, event) {  //到访或者未到访tab切换
                if(tab.name=='first'){
                	window.location.href="/visit/visit/customerVisitRecord.html";
                }else{
                	window.location.href="/visit/visit/customerNoVisitRecord.html";
                }
             },
            submitDialogForm(formName) {
                this.$refs[formName].validate((valid) => {
                    if (valid) {
                      
                    	var param ={}; 
                        var rows = this.multipleSelection;
                        var idArr = new Array();
                        for(var i=0;i<rows.length;i++){
                            var curRow = rows[i];
                           idArr.push(curRow.id);
                        }
                        param.idList = idArr;
                        param.rebutReason = this.dialogForm.reason;
                        axios.post('/visit/visitRecord/rejectVisitRecord', param)
                        .then(function (response) {
                            var resData = response.data;
                            if(resData.code=='0'){
                            	customerVisitRecordVm.dialogForm.reason='';
                                customerVisitRecordVm.dialogFormVisible = false;
                                customerVisitRecordVm.$message({message:'操作成功',type:'success',duration:2000,onClose:function(){
                                	customerVisitRecordVm.initCustomerVisitRecord();
                                }});
                            }else{
                            	customerVisitRecordVm.$message({message:resData.msg,type:'error'});
                                console.error(resData);
                            }
                        
                        })
                        .catch(function (error) {
                             console.log(error);
                        }).then(function(){
                        });
                    	
                    	
                    	
                    	
                    } else {
                        return false;
                    }
                });
            },
            notSignedReasonClick(row) {//未签约原因
                console.log(row);
                this.notSignReason=row.notSignReason;
                this.notSignedReasonDialog=true;
            },
            reasonClick(row) {//驳回原因
                console.log(row);
                this.rebutReason =row.rebutReason;
                this.reasonDialog=true;
            },
            pass(){//审核通过
                var rows = this.multipleSelection;
                if(rows.length<1){
                    this.$message({
                       message: '请选择数据',
                       type: 'warning'
                     });
                    return;
                }
                
                var title = "";
                var idArr = new Array();
                var isPass = true;
                for(var i=0;i<rows.length;i++){
                    var curRow = rows[i];
                    if(curRow.status!=1){
                        this.$message({message:'只允许审核待审核的数据',type:'warning'});
                        isPass=false;
                        break;
                    }
                    title += "【"+curRow.serialNum+""+curRow.customerName+"】 ";
                    idArr.push(curRow.id);
                }
                if(!isPass){
                    return;
                }
            	
                this.$confirm('确定要将此 '+title+' 到访记录定为有效吗？', '提示', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                    type: 'warning'
                }).then(() => {
                    var param={};
                    param.idList = idArr;
                   
                    axios.post('/visit/visitRecord/passAuditSignOrder', param)
                    .then(function (response) {
                        var resData = response.data;
                        if(resData.code=='0'){
                        	customerVisitRecordVm.dialogFormVisible = false;
                        	customerVisitRecordVm.$message({message:'操作成功',type:'success',duration:2000,onClose:function(){
                        		customerVisitRecordVm.initCustomerVisitRecord();
                            }});
                        }else{
                        	customerVisitRecordVm.$message({message:resData.msg,type:'error'});
                            console.error(resData);
                        }
                    
                    })
                    .catch(function (error) {
                         console.log(error);
                    }).then(function(){
                    });
                }).catch(() => {
                    this.$message({
                        type: 'info',
                        message: '已取消审核'
                    });          
                });
            },
            initCustomerVisitRecord(){//初始列表
            	   
                var startTime = this.form.visitStartTime;
                var endTime = this.form.visitEndTime;
                var startTimestamp = Date.parse(new Date(startTime));
               if(endTime){
                   var endTimestamp = new Date(endTime);
                    if(startTimestamp> endTimestamp){
                        this.$message({
                            message: '开始时间不能大于结束时间',
                            type: 'warning'
                          });
                        return;
                    }
               }
                 var param = this.form;
                 param.pageNum=this.pager.currentPage;
                 param.pageSize=this.pager.pageSize;
                 axios.post('/visit/visitRecord/listVisitRecord',param)
                 .then(function (response) {
                     var data =  response.data
                     if(data.code=='0'){
                        var resData = data.data;
                        customerVisitRecordVm.dataTable= resData.data;
                      //3.分页组件
                        customerVisitRecordVm.pager.total= resData.total;
                        customerVisitRecordVm.pager.currentPage = resData.currentPage;
                        customerVisitRecordVm.pager.pageSize = resData.pageSize;
                         
                     }else{
                         customerVisitRecordVm.$message({message:data.msg,type:'error'});
                         console.error(data);
                     }
                 
                 })
                 .catch(function (error) {
                      console.log(error);
                 }).then(function(){
                     customerVisitRecordVm.loading=false;
                 });
            	
            },
            OpenRejectVisitRecordDialog(){//驳回
            	debugger;
            	   this.signRecordArrTitle='';
                   var rows = this.multipleSelection;
                   if(rows.length<1){
                       this.$message({
                          message: '请选择数据',
                          type: 'warning'
                        });
                       return;
                   }
                   var title = "";
                   for(var i=0;i<rows.length;i++){
                       var curRow = rows[i];
                       title += "【"+curRow.serialNum+""+curRow.customerName+"】";
                   }
                   this.signRecordArrTitle=title;
                   
                   this.dialogFormVisible=true;
            },
            reasonClick(row) {//驳回原因
                console.log(row);
               this.rebutReason = row.rebutReason;
                this.reasonDialog=true;
            },
            getSignShopTypeText(row, column, value, index){
                var valText="";
                if(value==1){
                    valText="创业店";
                }else if(value==2){
                    valText="标准店";
                }else if(value==3){
                    valText="白金店";
                }else if(value==4){
                    valText="旗舰店";
                }else if(value==5){
                    valText="区域代理";
                }
                return valText;
            },
            getVisitTypeText(row, column, value, index){
            	var valText="";
                if(value==1){
                    valText="预约来访";
                }else if(value==2){
                    valText="慕名来访";
                }else if(value==3){
                    valText="临时来访";
                }
                return valText;
            },handleSelectionChange(val){
                this.multipleSelection = val;
            },
            getVisitNumText(row, column, value, index){
            	var valText="";
                if(value==1){
                    valText="首次到访";
                }else if(value==2){
                    valText="二次来访";
                }else if(value>=3){
                    valText="多次来访";
                }
                return valText;
            }

        },
        mounted(){
            document.getElementById('customerVisitRecord').style.display = 'block';
        },
        created(){
        	this.initCustomerVisitRecord();
        }
    })
</script>
</html>