<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:th="http://www.thymeleaf.org">
<head th:include="_header_include::frag(~{::title},~{},~{})">
    <title>组织机构管理</title>
    <style>
        .organizationManage .leftBox{/*width: 200px;*/height: auto;border:1px solid #ebeef5;min-height: 480px;}
        .organizationManage .leftTitle{background:#ebeef5;text-indent: 20px;height: 40px;line-height: 40px;}
        .organizationManage .leftTree{padding:10px;}
        .organizationManage .rightTitle{background:#ebeef5;text-indent: 20px;height: 40px;line-height: 40px;}
    </style>
</head>
<body>
<div id="organizationManage" class="organizationManage mainPadding">  
    <el-breadcrumb separator="/" class="elBreadcrumb marginB20">
        <el-breadcrumb-item>Home</el-breadcrumb-item>
        <el-breadcrumb-item>系统管理</el-breadcrumb-item>
        <el-breadcrumb-item><a href="JavaScript:void(0)" data-url="b.html">组织机构管理</a></el-breadcrumb-item>
    </el-breadcrumb>
    <el-row :gutter="20">
        <el-col :xs="12" :sm="7" :md="5" :lg="3" :xl="3">
            <div class="leftBox">
                <div class="leftTitle fs16">组织机构列表</div>
                <el-tree
                    :data="dataTree"              
                    node-key="id"
                   
                    ref="tree"
                    highlight-current
                    @node-click="clickOrgNode"
                    @selection-change="handleSelectionChange"
                    class="leftTree">
                </el-tree>
            </div>            
        </el-col>
        <el-col :xs="12" :sm="17" :md="19" :lg="21" :xl="21">
            <el-row class="marginB10">
                <el-col :xs="12" :sm="16" :md="16" :lg="18" :xl="12">
                    <el-button type="primary" @click="addChildOrg"><i class="el-icon-plus"></i> 添加下一级组织</el-button>
                    <el-button type="primary" @click="modifyChildOrg">修改</el-button>
                    <el-button type="primary" @click="deleteFun">删除</el-button>
                </el-col>
                <el-col :xs="12" :sm="8" :md="8" :lg="6" :xl="12">
                    <el-input placeholder="按照组织名称进行查询" class="input-with-select" v-model="inputOrgName">                        
                    <el-button slot="append" icon="el-icon-search" @click="getQuery"></el-button>
                    </el-input>
                </el-col>
            </el-row>
            <el-row class="rightTitle fs16"> {{form.parentName}} 下一级组织</el-row>
            <el-row>
                <el-table 
                    ref="multipleTable"
                    tooltip-effect="dark"
                    empty-text="当前组织无下级组织"
                    style="width: 100%"
                    @selection-change="handleSelectionChange"
                    border
                    :data="dataTable" 
                    >
                    <el-table-column align="center" type="selection" width="55"></el-table-column> 
                     <!-- <el-table-column prop="date" label="全选" width="180"></el-table-column>  -->
                    <el-table-column align="center" prop="name" label="组织名称"></el-table-column>
                    <el-table-column align="center" prop="staffNum" label="组内成员（人）"></el-table-column>
                    <el-table-column align="center" prop="remark" label="备注"></el-table-column>
                </el-table>
                 <table-pagination :pager="pager" @change="getQuery"></table-pagination>
            </el-row>
        </el-col>
    </el-row>
    <!-- dialog -->
    <el-dialog title="添加下级组织" :visible.sync="dialogFormVisible">
        <el-form :model="form"  ref="ruleForm" :rules="rules">
            <el-form-item label="上级组织：" :label-width="formLabelWidth" prop="parentName">
                   {{form.parentName}}
            </el-form-item> 
            <el-form-item label="组织名称：" :label-width="formLabelWidth" prop="name">
                <el-input v-model="form.name" autocomplete="off" maxlength="30"   placeholder="组织名称"></el-input>
            </el-form-item>
            <el-form-item label="组织备注：" :label-width="formLabelWidth" prop="remark">
                <el-input
                      type="textarea"
                      :rows="4"
                      maxlength="200"
                      placeholder="填写备注信息,最大200字符"
                      v-model="form.remark">
                </el-input>
                <!-- <p>200字</p> -->
            </el-form-item>
        </el-form>
        <div slot="footer" class="dialog-footer">
            <el-button @click="cancelForm('ruleForm')">取 消</el-button>
            <el-button type="primary" @click="submitForm('ruleForm')">确 定</el-button>
        </div>
    </el-dialog>
</div>
</body>
<!-- import common js-->
<div th:include="_footer_include :: #jsLib"></div>
<script th:inline="javascript">

    var orgData=[[${orgData}]];

   var orgVM =  new Vue({
        el: '#organizationManage',
        data: function() {
            return {
                dataTree: orgData,//组织结构tree
                dataTable:[],
                multipleSelection: [],
                dialogFormVisible: false,
                form: {
                    name: '',
                    remark: '',
                    parentName:'',
                    id:''
                },
                oldName:'',//旧的组织机构，更新时使用 
                formLabelWidth: '120px',
                pager:{
                    total: 0,
                    currentPage: 1,
                    pageSize: 20,
                },
                selectedNode:null,//当前的orgParentId
                rules:{
                	 name: [
                         { required: true, message: '组织名称不能为空',trigger:'blur'},
                         { validator:function(rule,value,callback){
                        	 var id = orgVM.form.id;
                        	 var name = orgVM.oldName;
                        	 if(id&& value==name){
                        		 callback();
                        	 }
                               var param = {'name':value};
                        	    axios.post('/organization/organization/queryOrgByParam',param)
                                .then(function (response) {
                                    var data =  response.data
                                    if(data.code=='0'){
                                        var resData = data.data;
                                        if(resData){
                                        	callback(new Error("组织名称已存在"));
                                        }else{
                                        	callback();
                                        }
                                        
                                    }else{
                                    	 callback(new Error("查询组织名称是否唯一报错"));
                                    }
                                })
                                .catch(function (error) {
                                  console.log(error);
                                })
                                .then(function () {
                                  // always executed
                                });
                               
                        },trigger: 'blur'}
                     ]
                },
                inputOrgName:'',//搜索框 组织名称
                multipleSelection:[],//选择的列
            }             
        },
        methods: {
            toggleSelection(rows) {
                if (rows) {
                    rows.forEach(row => {
                        this.$refs.multipleTable.toggleRowSelection(row);
                    });
                } else {
                  this.$refs.multipleTable.clearSelection();
                }
            },
            handleSelectionChange(val) {
                this.multipleSelection = val;
            },
            deleteFun() {//点击删除组织机构
            	var rows = this.multipleSelection;
            	if(rows.length==0){
                    this.$message({
                       message: '请选择一条数据进行修改',
                       type: 'warning'
                     });
                    return;
                }
                var rowIds = [];
                for(var i=0;i<rows.length;i++){
                    rowIds.push(rows[i].id)
                }
                var param  = {idList:rowIds}
                axios.post('/organization/organization/queryOrgByParentId',param)
                .then(function (response) {
                    var data =  response.data;
                    var msgInfo = "";
                    var btnText="";
                    var isDelete=false;
                    if(data.code=='0'){
                        var resData = data.data;
                        if(resData){
                            msgInfo='本组织已经关联到用户，需要将组织下用户转移后，方可进行组织的删除操作！';
                            btnText="知道了"
                        }else{
                           msgInfo='删除组织后此组织信息将不存在，确认删除吗';
                           btnText="确认";
                           isDelete=true;
                        }
                        
                        orgVM.$alert(msgInfo, '消息提醒', {
                            confirmButtonText: btnText,
                            showClose:false,
                             callback: action => {
                                   if(isDelete){
                                       //删除
                                	   axios.post('/organization/organization/delete',param)
                                       .then(function (response) {
                                           var data =  response.data;
                                           if(data.code=='0'){
                                               var resData = data.data;
                                               var delText="";
                                               if(resData){
                                            	   delText="删除成功";
                                               }else{
                                                   delText="删除失败"
                                               }
                                               
                                               orgVM.$message({
                                                   message: delText,
                                                   type: 'warning'
                                                 });
                                               
                                           }else{
                                        	   orgVM.$message({
                                                   message: "接口调用失败",
                                                   type: 'warning'
                                                 }); 
                                           }
                                       })
                                       .catch(function (error) {
                                         console.log(error);
                                       })
                                       .then(function () {
                                    	   orgVM.initOrgTree();
                                           orgVM.getQuery();
                                       });
                                       
                                   }
                                 
                            } 
                        });

                        
                        
                        
                    }else{
                        
                    }
                    
                  
                }).catch(function (error) {
                  console.log(error);
                })
                .then(function () {
                  // always executed
                });
                
            	
            	
            
            },
            clickOrgNode(data,node,obj){
            	this.selectedNode = data;
            	this.form.parentName=data.label;
            	this.getQuery();
            },
            getQuery(){
                this.initTableData();
            },
            initTableData(){
                var pageSize = this.pager.pageSize;
                var pageNum = this.pager.currentPage;
                var param = {};
                var  parentId = this.selectedNode.id;
                if(!parentId){
                	parentId=62923235;
                }
                param.parentId = parentId;
                param.name = this.inputOrgName;
                axios.post('/organization/organization/queryOrgDataByParam?pageNum='+pageNum+"&pageSize="+pageSize,param)
                    .then(function (response) {
                        var data =  response.data
                        if(data.code=='0'){
                        	var resData = data.data;
                        	orgVM.dataTable= resData.data;
                            //3.分页组件
                            orgVM.pager.total= resData.total;
                            orgVM.pager.currentPage = resData.currentPage;
                            orgVM.pager.pageSize = resData.pageSize;
                        }
                        
                       
                    })
                    .catch(function (error) {
                      console.log(error);
                    })
                    .then(function () {
                      // always executed
                    });  
            },
            addChildOrg(){
            	var curData = this.selectedNode;
            	if(!curData){
            		this.$message({
                        message: '请选择一个上级',
                        type: 'warning'
                      });
                     return;
            	}
            
            	this.dialogFormVisible = true;
            },
            submitForm(formName) {
                this.$refs[formName].validate((valid) => {
                  if (valid) {
                     var param=this.form;
                     param.parentId=this.selectedNode.id;
                 
                     
                    axios.post('/organization/organization/saveOrUpdate', param)
                    .then(function (response) {
                    	var resData = response.data;
                    	if(resData.code=='0'){
                    	    orgVM.$message('操作成功');
                    	    orgVM.cancelForm(formName);
                    	    orgVM.dialogFormVisible = false;
                    	    orgVM.initOrgTree();
                    	    orgVM.getQuery();
                    	}else{
                    		orgVM.$message('操作失败');
                    	}
                    	
                    	
                    
                    })
                    .catch(function (error) {
                         console.log(error);
                    });
                     
                  } else {
                    return false;
                  }
                });
              },
              cancelForm(formName) {
                  this.$refs[formName].resetFields();
              },
              initOrgTree(){//刷新根节点tree
            	  axios.post('/organization/organization/query',{})
                  .then(function (response) {
                      var data =  response.data
                      if(data.code=='0'){
                          orgVM.dataTree= data.data;
                          
                      }
                      
                     
                  })
                  .catch(function (error) {
                    console.log(error);
                  })
                  .then(function () {
                    // always executed
                  }); 
            	  
              },
              handleSelectionChange(val) {//选择节点的事件
                  console.info(val);
                  this.multipleSelection = val;
              },
              modifyChildOrg(){//点击修改按钮时
            	  var rows = this.multipleSelection;
                  if(rows.length!=1){
                      this.$message({
                         message: '请选择一条数据进行修改',
                         type: 'warning'
                       });
                      return;
                  }
                 var parentName =  orgVM.form.parentName;
                  var param={id:rows[0].id};
                  //根据id获取数据
                  axios.post('/organization/organization/queryOrgById',param)
                  .then(function (response) {
                      var data =  response.data;
                      if(data.code=='0'){
                          orgVM.form= data.data;
                          orgVM.form.parentName=parentName;
                          //把当前的值存在临时变量里，当修改时，旧值和新值对比
                          orgVM.oldName = data.data.name;
                      }
                      
                     
                  })
                  .catch(function (error) {
                    console.log(error);
                  })
                  .then(function () {
                    // always executed
                  }); 
                  
                  
                  this.dialogFormVisible = true;
            	 
              }
              
              
              
        },
        created(){
        	
        	
        }//created方法 结束
    })
</script>
</html>