<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org">
<head th:replace="_header_include::frag(~{::title},~{::style},~{})">
    <title>公共客户资源</title>
    <style>
        button a{color:#fff!important;}
        .formItem,.formItem .el-form-item__content{width:100%}
    </style>
</head>
<body>

<div id="mainDiv"  class="mainPadding">
    <template>
        <el-breadcrumb separator="/" class="elBreadcrumb marginB20">
            <el-breadcrumb-item>Home</el-breadcrumb-item>
            <el-breadcrumb-item>电销中心</el-breadcrumb-item>
            <el-breadcrumb-item><a href="JavaScript:void(0)">公共客户资源</a></el-breadcrumb-item>
        </el-breadcrumb>

        <el-row type="flex" class="row-bg" justify="start">
            <el-button type="primary" @click="openAllocation">分配资源</el-button>
            <el-button type="primary" @click="openTrans">转移资源</el-button>
            <el-button type="primary" @click="openRelease">释放记录</el-button>
            <el-button type="primary" @click="openBack">资源还原</el-button>
            <el-button type="primary" @click="openTrackingDialog">跟进记录</el-button>
        </el-row>


        <el-row class="marginB10 greybg padding20" style="padding-bottom: 0;" >
            <el-form :inline="true" :model="queryForm" class="demo-form-inline" ref="queryForm" >
            <el-row :gutter="20" >
                <el-col :span="3">
                    <el-form-item class="formItem" prop="releaseReason">
                        <el-select v-model="queryForm.releaseReason" placeholder="释放原因" width="100" clearable>
                            <el-option v-for="item in reasonArr" :key="item.value" :label="item.name" :value="item.value"></el-option>
                        </el-select>
                    </el-form-item>
                </el-col>
                <el-col :span="3">
                    <el-select v-model="queryForm.customerStatus" placeholder="客户状态" width="100" clearable>
                        <el-option v-for="item in cusStatusArr" :key="item.value" :label="item.name" :value="item.value"></el-option>
                    </el-select>
                </el-col>
                <el-col :span="3">
                    <el-select v-model="queryForm.teleGorupId" placeholder="电销组" width="100" clearable>
                        <el-option v-for="item in teleketGroupArr" :key="item.id" :label="item.name" :value="item.id"></el-option>
                    </el-select>
                </el-col>
                <el-col :span="3">
                    <el-select v-model="queryForm.teleSaleId" placeholder="创业顾问" width="100" clearable>
                        <el-option v-for="item in teleketSaleArr" :key="item.id" :label="item.name" :value="item.id"></el-option>
                    </el-select>
                </el-col>
                <el-col :span="3">
                    <el-input  v-model="queryForm.project" placeholder="项目名称"></el-input>
                </el-col>
                <el-col :span="3">
                    <el-select v-model="queryForm.isRepetition" placeholder="是否重单" width="100" clearable>
                        <el-option v-for="item in repeatArr" :key="item.value" :label="item.name" :value="item.value"></el-option>
                    </el-select>
                </el-col>
            </el-row>
            <el-row :gutter="20" >
                <el-col :span="6">
                    <el-form-item label="创建时间">
                        <el-date-picker v-model="queryForm.createTime1" type="datetime" placeholder="选择日期时间"></el-date-picker>
                        <span>-</span>
                        <el-date-picker v-model="queryForm.createTime2" type="datetime" placeholder="选择日期时间"></el-date-picker>
                    </el-form-item>
                </el-col>
                <el-col :span="6">
                    <el-form-item label="释放时间">
                        <el-date-picker v-model="queryForm.releaseTime1" type="datetime" placeholder="选择日期时间"></el-date-picker>
                        <span>-</span>
                        <el-date-picker v-model="queryForm.releaseTime2" type="datetime" placeholder="选择日期时间"></el-date-picker>
                    </el-form-item>
                </el-col>
                <el-col :span="3">
                    <el-input  v-model="queryForm.searchWord" placeholder="搜索词"></el-input>
                </el-col>
                <el-col :span="3">
                    <el-input v-model="queryForm.phone" placeholder="客户手机号"></el-input>
                </el-col>
                <el-col :span="3">
                    <el-button type="primary" @click="initList">搜索</el-button>
                </el-col>
            </el-row>
            <el-row :gutter="20" >
                <el-col :span="3">
                    <el-form-item class="formItem" prop="type">
                        <el-select v-model="queryForm.type" placeholder="资源类型" width="100" clearable>
                            <el-option v-for="item in typeArr" :key="item.value" :label="item.name" :value="item.value"></el-option>
                        </el-select>
                    </el-form-item>
                </el-col>
                <el-col :span="3">
                    <el-form-item class="formItem" prop="category">
                        <el-select v-model="queryForm.category" placeholder="资源类别" width="100" clearable>
                            <el-option v-for="item in categoryArr" :key="item.value" :label="item.name" :value="item.value"></el-option>
                        </el-select>
                    </el-form-item>
                </el-col>
                <el-col :span="3">
                    <el-input  v-model="queryForm.address" placeholder="地区"></el-input>
                </el-col>
            </el-row>
            </el-form>
        </el-row>

        <el-table :data="tableData"  style="width: 100%" tooltip-effect="light"  ref="multipleTable"
                  @selection-change="handleSelectionChange" >
            <el-table-column type="selection" width="55" prop="clueid"> </el-table-column>
            <el-table-column prop="cusName" label="客户姓名"  align="center" show-overflow-tooltip></el-table-column>
            <el-table-column prop="phone" label="手机号" align="center" show-overflow-tooltip></el-table-column>
            <el-table-column prop="cusLevel" label="客户级别"  align="center"></el-table-column>
            <el-table-column prop="customerStatus" label="客户状态" align="center" show-overflow-tooltip></el-table-column>
            <el-table-column prop="" label="重复手机号"  align="center" show-overflow-tooltip></el-table-column>
            <el-table-column prop="" label="跟进记录"  align="center" show-overflow-tooltip>

            </el-table-column>
            <el-table-column prop="address" label="地址" align="center" show-overflow-tooltip></el-table-column>
            <el-table-column prop="createTime" label="创建时间" align="center" ></el-table-column>
            <el-table-column prop="project" label="项目名称" align="center" ></el-table-column>
            <el-table-column prop="searchWord" label="搜索词" align="center" ></el-table-column>
            <el-table-column prop="teleDirector" label="电销总监" align="center" ></el-table-column>
            <el-table-column prop="teleSale" label="电销创业顾问" align="center" ></el-table-column>
            <el-table-column prop="orgName" label="电销组" align="center" ></el-table-column>
            <el-table-column prop="releaseTime" label="释放时间" align="center" ></el-table-column>
            <el-table-column prop="releaseReason" label="释放原因" align="center" ></el-table-column>
        </el-table>
    </template>
    <table-pagination :pager="pager"  @change="initList"></table-pagination>

    <el-dialog title="分配资源"  :visible.sync="allocationDialogFormVisible"  width="20%">
        <template>
        <el-form :model="allocation" ref="allocation" :rules="allorules"  class="demo-form-inline">
            <el-form-item label="电销创业顾问"  :label-width="formLabelWidth"  prop="saleid">
                <el-select v-model="allocation.teleSaleId" placeholder="组内电销组员工" width="100" clearable>
                    <el-option v-for="item in teleketSaleArr" :key="item.id" :label="item.name" :value="item.id"></el-option>
                </el-select>
            </el-form-item>
        </el-form>
        <div slot="footer" class="dialog-footer">
            <el-button type="primary" @click="allocationSubmit">提交</el-button>
            <el-button @click="allocationDialogFormVisible = false">取消</el-button>
        </div>
        </template>
    </el-dialog>


    <!--
        同事业部组名：
            总监姓名
    -->
    <el-dialog title="转移资源"  :visible.sync="transDialogFormVisible"  width="20%">
        <template>
            <el-form :model="trans" ref="trans" :rules="transrules">
                <el-form-item label="电销总监"  :label-width="formLabelWidth"  prop="director"  width="100%">
                    <el-select v-model="trans.director" placeholder="同事业部的总监" clearable>
                        <el-option v-for="item in teleketDirectorArr" :key="item.id" :label="item.name" :value="item.id"></el-option>
                    </el-select>
                </el-form-item>
            </el-form>
            <div slot="footer" class="dialog-footer">
                <el-button type="primary" @click="transSubmit">提交</el-button>
                <el-button @click="transDialogFormVisible = false">取消</el-button>
            </div>
        </template>
    </el-dialog>

    <!--释放记录-->
    <el-dialog title="释放记录"  :visible.sync="releaseDialogFormVisible"  width="40%">
        <template>
            <el-form :model="release" ref="release"   class="demo-form-inline">
                <el-row :gutter="20">
                    <el-col  :span="7"> <el-input  v-model="release.customerName" placeholder="客户姓名"></el-input> </el-col>
                    <el-col  :span="7"> <el-input  v-model="release.releaseReason" placeholder="释放原因"></el-input> </el-col>
                    <el-col  :span="7"> <el-input  v-model="release.releaseUserName" placeholder="释放人电销顾问姓名"></el-input> </el-col>
                    <el-col  :span="3">  <el-button  type="primary" @click="releaseInitList">搜索</el-button> </el-col>
                </el-row>
            </el-form>
            <el-table :data="tableReData"  style="width: 100%" tooltip-effect="light"  ref="releaseTable">
                <el-table-column prop="xh" label="序号" width="80"  align="center" show-overflow-tooltip></el-table-column>
                <el-table-column prop="customerName" label="客户姓名" align="center" show-overflow-tooltip></el-table-column>
                <el-table-column prop="projectName" label="项目"  align="center"></el-table-column>
                <el-table-column prop="releaseTime" label="释放时间" align="center" show-overflow-tooltip></el-table-column>
                <el-table-column prop="releaseReasonValue" label="释放原因"  align="center" show-overflow-tooltip></el-table-column>
                <el-table-column prop="realeseUserName" label="释放人姓名"  align="center" show-overflow-tooltip></el-table-column>
            </el-table>
            <table-pagination :pager="releasePager"  @change="releaseInitList"></table-pagination>
        </template>
    </el-dialog>

  <!--  <el-dialog title="跟进记录"  :visible.sync="trackingDialogVisible"  width="50%">
        <template>
            <el-table :data="tableReData"  style="width: 100%" tooltip-effect="light"  ref="releaseTable">
                <el-table-column prop="xh" label="序号" width="80"  align="center" show-overflow-tooltip></el-table-column>
                <el-table-column prop="callTime" label="拨打时间" align="center" show-overflow-tooltip></el-table-column>
                <el-table-column prop="customerStatus" label="客户状态"  align="center"></el-table-column>
                <el-table-column prop="isCall" label="是否接通" align="center" show-overflow-tooltip></el-table-column>
                <el-table-column prop="resourceStatus" label="资源有效性"  align="center" show-overflow-tooltip></el-table-column>
                <el-table-column prop="invitationStatus" label="是否邀约"  align="center" show-overflow-tooltip></el-table-column>
                <el-table-column prop="focusPoint" label="客户关注点"  align="center" show-overflow-tooltip></el-table-column>
                <el-table-column prop="visitStatus" label="是否继续回访"  align="center" show-overflow-tooltip></el-table-column>
                <el-table-column prop="nextVisitTime" label="下次回访时间"  align="center" show-overflow-tooltip></el-table-column>
                <el-table-column prop="createUserName" label="创建人"  align="center" show-overflow-tooltip></el-table-column>
            </el-table>
        </template>
    </el-dialog>-->

    <dialog-tracking :param="trackingParam"></dialog-tracking>


</div>

<!-- import common js-->
<div th:include="_footer_include :: #jsLib"></div>
<!--<script th:src="@{/js/excel/xlsx.min.js}" src="../static/js/excel/xlsx.min.js"></script>-->
<script th:inline="javascript">
    <!--电销组-->
    var dzList=[[${dzList}]];
    var dxgwList=[[${dxgwList}]];
    var dxzjList = [[${dxzjList}]]
    // 查询 模块
    var mainDivVM = new Vue({
        el: '#mainDiv',
        data: {
            allocationDialogFormVisible:false,
            releaseDialogFormVisible:false,
            transDialogFormVisible:false,
            formLabelWidth:"150px",
            tableData:[],
            tableReData:[],
            categoryArr:[],
            typeArr:[],
            reasonArr:[],
            cusStatusArr:[],
            teleketGroupArr:dzList,
            teleketSaleArr:dxgwList,
            teleketDirectorArr:dxzjList,
            repeatArr:[{value:0,name:'是'},{value:1,name:'否'}],
            orgLeafOptions:[],
            multipleSelection:[],
            queryForm:{
                releaseReason:"",
                customerStatus:"",
                teleGorupId:"",
                teleSaleId:"",
                project:"",
                isRepetition:"",
                createTime1:"",
                createTime2:"",
                releaseTime1:"",
                releaseTime2:"",
                searchWord:"",
                phone:"",
                type:"",
                category:"",
                address:""
            },
            release:{
                customerName:"",
                releaseReason:"",
                releaseUserName:""
            },
            allocation:{
                teleSaleId:""
            },
            trans:{
                director:""
            },
            transrules:{
                director: [
                    {required: true, message: '请选择电销总监', trigger: 'blur'},
                ],
            },
            allorules:{
                saleid: [
                    {required: true, message: '请选择电销顾问', trigger: 'blur'},
                ],
            },
            pager:{
                total: 0,
                currentPage: 1,
                pageSize: 20,
            },
            releasePager:{
                total: 0,
                currentPage: 1,
                pageSize: 20,
            },
            trackingParam:{
                trackingDialogVisible:false,
                tableData:[]
            },
        },
        methods: {
            openTrackingDialog(cid){
                var param = {};
                param.clueId = 1
                axios.post('/aggregation/tracking/queryList', param)
                    .then(function (response) {
                        console.log(response.data)
                        if (response.data.code == 0) {
                            mainDivVM.trackingParam.tableData = response.data.data
                            mainDivVM.trackingParam.trackingDialogVisible = true;
                        } else {
                            mainDivVM.$message.error(response.data.msg);
                        }
                    }).catch(function (error) {
                    console.log(error);
                });

            },
            allocationSubmit(){
                this.$refs['allocation'].validate((valid) => {
                    if (valid) {
                        axios.post('/aggregation/publiccustomer/allocationResource', param)
                            .then(function (response) {
                                console.log(response.data)
                                if (response.data.code == 0) {
                                    mainDivVM.$message({
                                        type: 'success', message: '资源分配成功!', duration: 2000, onClose: function () {
                                            mainDivVM.initList();
                                            mainDivVM.allocationDialogFormVisible = false;
                                        }
                                    });
                                } else {
                                    mainDivVM.$message.error(response.data.msg);
                                }
                            }).catch(function (error) {
                            console.log(error);
                        });
                    } else {
                        console.log('数据未通过校验！');
                        return false;
                    }
                })
            },
            transSubmit(){
                this.$refs['trans'].validate((valid) => {
                    if (valid) {
                        axios.post('/aggregation/publiccustomer/transferOfResource', param)
                            .then(function (response) {
                                console.log(response.data)
                                if (response.data.code == 0) {
                                    mainDivVM.$message({
                                        type: 'success', message: '资源转移成功!', duration: 2000, onClose: function () {
                                            mainDivVM.initList();
                                            mainDivVM.transDialogFormVisible = false;
                                        }
                                    });
                                } else {
                                    mainDivVM.$message.error(response.data.msg);
                                }
                            }).catch(function (error) {
                            console.log(error);
                        });
                    } else {
                        console.log('数据未通过校验！');
                        return false;
                    }
                })
            },
            openAllocation(){
                if(this.multipleSelection.length==0){
                    this.$message({message: '请选择分配资源', type: 'warning'});
                    return false;
                }
                this.allocationDialogFormVisible = true
            },
            openTrans(){
                if(this.multipleSelection.length==0){
                    this.$message({message: '请选择转移资源', type: 'warning'});
                    return false;
                }
                this.transDialogFormVisible = true
            },
            releaseInitList(){
                var param = this.release;
                param.pageSize = this.releasePager.pageSize;
                param.pageNum =  this.releasePager.currentPage;
                axios.post('/aggregation/releaserecord/queryPageList',param).then(function (response) {
                    if(null===response||response.data==null||response.data.code!='0'){
                        if(response.data.code!='0'){
                            mainDivVM.$message({message: response.data.msg, type: 'warning'});
                        }
                        return false;
                    }else{
                        mainDivVM.tableReData =response.data.data.data;
                        mainDivVM.releasePager.currentPage= response.data.data.currentPage;
                        mainDivVM.releasePager.total= response.data.data.total;
                        mainDivVM.releasePager.pageSize =  response.data.data.pageSize;
                    }
                })
            },
            openRelease(){
                //查询释放记录
                this.releaseInitList()
                this.releaseDialogFormVisible = true
            },
            openBack(){
                if(this.multipleSelection.length==0){
                    this.$message({message: '请选择还原资源', type: 'warning'});
                    return false;
                }else{
                    var rows = this.multipleSelection;
                    var names = "";
                    for(var i=0;i<rows.length;i++){
                        names = names + '['+rows[i].cusName+']';
                    }
                    var str = '确定要还原'+names+'客户吗?';
                    this.$confirm(str, '提示', {confirmButtonText: '确定', cancelButtonText: '取消', type: 'warning'}).then(() => {
                        var rowIds = [];
                        for(var i=0;i<rows.length;i++){
                            rowIds.push(rows[i].clueid)
                        }
                        var param={};
                        param.cliueIdsList = rowIds;
                        axios.post('/aggregation/publiccustomer/resourceReduction', param)
                            .then(function (response) {
                                queryFormVM.$message({type: 'success', message: '确定还原!',duration:2000,onClose:function(){
                                        paginationVm.initList();
                                    }});
                            })
                            .catch(function (error) {
                                queryFormVM.$message.error(error);
                                console.log(error);
                            });
                    }).catch(() => {
                        this.$message({type: 'info', message: '已取消还原'});
                    });
                }
            },
            handleSelectionChange(val) {
                this.multipleSelection = val;
            },
            resetForm(formName) {
                if( mainDivVM.$refs[formName]) {
                    mainDivVM.$refs[formName].resetFields();
                }
            },
            initList(){
                var param = this.queryForm;
                param.pageSize = this.pager.pageSize;
                param.pageNum =  this.pager.currentPage;
                axios.post('/aggregation/publiccustomer/queryPage',param).then(function (response) {
                    if(null===response||response.data==null||response.data.code!='0'){
                        if(response.data.code!='0'){
                            mainDivVM.$message({message: response.data.msg, type: 'warning'});
                        }
                        return false;
                    }else{
                        mainDivVM.tableData =response.data.data.data;
                        mainDivVM.pager.currentPage= response.data.data.currentPage;
                        mainDivVM.pager.total= response.data.data.total;
                        mainDivVM.pager.pageSize =  response.data.data.pageSize;
                    }
                })
            },
        },
        created(){
            this.initList();
            //初始资源类别数据
            var  param={};
            param.groupCode="clueCategory";
            axios.post('/dictionary/DictionaryItem/dicItemsByGroupCode',param).then(function (response) {
                console.log(response.data.data)
                mainDivVM.categoryArr=response.data.data;
            });
            //初始化资源类型数据
            param={};
            param.groupCode="clueType";
            axios.post('/dictionary/DictionaryItem/dicItemsByGroupCode',param).then(function (response) {
                console.log(response.data.data)
                mainDivVM.typeArr=response.data.data;
            });
            // 初始化释放原因
            param={};
            param.groupCode="releaseReason";
            axios.post('/dictionary/DictionaryItem/dicItemsByGroupCode',param).then(function (response) {
                console.log(response.data.data)
                mainDivVM.reasonArr=response.data.data;
            });
            //初始化客户状态
            param={};
            param.groupCode="customerStatus";
            axios.post('/dictionary/DictionaryItem/dicItemsByGroupCode',param).then(function (response) {
                console.log(response.data.data)
                mainDivVM.cusStatusArr=response.data.data;
            });

            // 初始化table数据

        }
    });

</script>
<style>

    .dialog-footer{
        text-align: center;
    }
    .el-table th {
        font-weight: bolder;
    }
    .el-input__inner{
    //   width: 200px;
    }
    .el-button--danger:focus, .el-button--danger:hover{
        background: #6f7180;
        border: #6f7180;
    }
    .el-button--danger{
        background: #6f7180;
        border: #6f7180;
    }
</style>
</body>
</html>