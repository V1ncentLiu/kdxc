<!DOCTYPE html>
<html>
<head th:include="_header_include::frag(~{::title},~{},~{})">
    <title>退款确认</title>
</head>
<body>
<div id="maindiv" class="maindiv mainPadding" style="display: none;">  
    <el-breadcrumb separator="/" class="elBreadcrumb marginB20">
        <el-breadcrumb-item>Home</el-breadcrumb-item>
        <el-breadcrumb-item>财务管理</el-breadcrumb-item>
        <el-breadcrumb-item>退款确认</el-breadcrumb-item>
    </el-breadcrumb>
    <el-row class="marginB10">
        <el-button type="primary" @click="openSign">退款确认</el-button>
        <el-button type="primary" @click="openRejectRefundDialog">驳回</el-button>
        <el-button type="primary" @click="openMarkRefundDialog">标记已退款</el-button>
    </el-row>
    <el-row class="marginB10 greybg padding20" style="padding-bottom: 0">        
        <el-form :inline="true" :model="form" ref="form">
            <el-form-item label="">
                <el-select v-model="form.busAreaId" placeholder="商务大区" style="width: 100%;" clearable @change="changeBusArea" @clear="clearBusAreaList" >
                    <el-option
                        v-for="item in busAreaList"
                        :key="item.id"
                        :label="item.name"
                        :value="item.id">
                    </el-option>
                </el-select>
            </el-form-item> 
            <el-form-item label="">  
                <el-select v-model="form.busGroupId" placeholder="签单商务组" style="width: 100%;" clearable @change="changeBusGroup" @clear="clearBusGroupList">
                    <el-option
                        v-for="item in busGroupList"
                        :key="item.id"
                        :label="item.name"
                        :value="item.id">
                    </el-option>
                </el-select>
            </el-form-item>    
            <el-form-item label="">  
                <el-select v-model="form.busManagerId" placeholder="签单商务经理" style="width: 100%;" clearable>
                    <el-option
                        v-for="item in busManagerList"
                        :key="item.id"
                        :label="item.name"
                        :value="item.id">
                    </el-option>
                </el-select>
            </el-form-item> 
            <el-form-item label="">  
                <el-select v-model="form.signShopType" placeholder="签约店型" style="width: 100%;" clearable>
                    <el-option
                        v-for="item in vistitStoreTypeArr"
                        :key="item.value"
                        :label="item.name"
                        :value="item.value">
                    </el-option>
                </el-select>
            </el-form-item>   
            <el-form-item label="">  
                <el-select v-model="form.status" placeholder="处理状态" style="width: 100%;" clearable>
                    <el-option
                        v-for="item in statusList"
                        :key="item.value"
                        :label="item.name"
                        :value="item.value">
                    </el-option>
                </el-select>
            </el-form-item>   
            <el-form-item label="">  
                <el-select v-model="form.teleDeptId" placeholder="电销事业部" style="width: 100%;" clearable @change="changeTeleDept" @clear="clearTeleDeptList">
                    <el-option
                        v-for="item in teleDeptList"
                        :key="item.id"
                        :label="item.name"
                        :value="item.id">
                    </el-option>
                </el-select>
            </el-form-item>  
            <el-form-item label="">  
                <el-select v-model="form.teleGroupId" placeholder="电销组" style="width: 100%;" clearable @change="changeTeleGroup" @clear="clearTeleGroupList">
                    <el-option
                        v-for="item in teleGroupIdList"
                        :key="item.id"
                        :label="item.name"
                        :value="item.id">
                    </el-option>
                </el-select>
            </el-form-item>   
            <el-form-item label="">  
                <el-select v-model="form.teleId" placeholder="创业顾问" style="width: 100%;" clearable>
                    <el-option
                        v-for="item in teleIdList"
                        :key="item.id"
                        :label="item.name"
                        :value="item.id">
                    </el-option>
                </el-select>
            </el-form-item>  
            <el-form-item label="">  
                <el-select v-model="form.signProvince" placeholder="签约省份" style="width: 100%;" clearable>
                    <el-option
                        v-for="item in proviceList"
                        :key="item.id"
                        :label="item.name"
                        :value="item.name">
                    </el-option>
                </el-select>
            </el-form-item>  
            <el-form-item label="">  
                <el-select v-model="form.signType" placeholder="签约类型" style="width: 100%;" clearable>
                    <el-option
                        v-for="item in signTypeList"
                        :key="item.value"
                        :label="item.label"
                        :value="item.value">
                    </el-option>
                </el-select>
            </el-form-item>                
            <el-form-item label="">
                <el-input v-model="form.customerName" placeholder="客户姓名"></el-input>
            </el-form-item>
            <el-form-item label="">
                <el-input v-model="form.phone" placeholder="客户手机号"></el-input>
            </el-form-item>            
            <el-form-item label="">
                <el-input v-model="form.signNo" placeholder="签约单编号"></el-input>
            </el-form-item>
            <el-form-item label="退款时间:">
                <el-date-picker
                    style="width: 100%;"
                    v-model="form.startTime"
                    type="datetime"
                    placeholder="选择日期时间">
                </el-date-picker>
            </el-form-item>
            <el-form-item label="—">
                <el-date-picker
                    style="width: 100%;"
                    v-model="form.endTime"
                    type="datetime"
                    placeholder="选择日期时间">
                </el-date-picker>
            </el-form-item>            
            <el-button type="primary" @click="searchTable()">搜索</el-button>
        </el-form>       
    </el-row>
    <!-- 表格 -->
    <el-row>
        <el-table 
            ref="tableData"
            tooltip-effect="dark"
            border
            :data="tableData"
            @selection-change="handleSelectionChange" 
            >
            <el-table-column align="center" type="selection"></el-table-column>
            <el-table-column align="center" type="index" label="序号"></el-table-column>
            <el-table-column align="center" prop="signNo" label="签约单编号"></el-table-column>
            <el-table-column align="center" prop="customerName" label="客户姓名"></el-table-column>
            <el-table-column align="center" prop="cusAmount" label="退款客户金额"></el-table-column>
            <el-table-column align="center" prop="companyAmount" label="退换餐饮公司金额"></el-table-column>
            <el-table-column align="center" prop="refundTime" label="退款时间"></el-table-column>
            <el-table-column align="center" prop="" label="退款图片">
                <template slot-scope="scope">
                    <el-button @click="download(scope.row)" type="text">下载图片</el-button>
                </template>
            </el-table-column>
            <el-table-column align="center" prop="reason" label="返款原因">
                <template slot-scope="scope">
                    <el-button @click="showReason1(scope.row)" type="text">查看原因</el-button>
                </template>
            </el-table-column>
            <el-table-column align="center" prop="applyTime" label="申请退款时间"></el-table-column>
            <el-table-column align="center" prop="status" label="处理状态">
                <template slot-scope="scope">
                
                    <div v-if="scope.row.status == '2'">
                                已驳回 
                        <el-button @click="showReason(scope.row)" type="text" class="bluecolor">驳回原因</el-button>
                    </div>
                    <div v-else-if="scope.row.status == '1'">待处理</div>
                    <div v-else-if="scope.row.status == '3'">确认退款</div>
                    <div v-else-if="scope.row.status == '4'">已退款</div>
                    <div v-else-if="scope.row.status == '5'">标记退款结束</div>
                </template>
            </el-table-column>
            <el-table-column align="center" prop="signProjectName" label="签约项目"></el-table-column>
            <el-table-column align="center" prop="signType" label="签约类型">
                <template slot-scope="scope">
                    <div v-if="scope.row.signType == '1'">一次性全款</div>
                    <div v-else-if="scope.row.signType == '2'">先付定金</div>
                </template>
            </el-table-column>
            <el-table-column align="center" prop="signTime" label="签约时间"></el-table-column>
            <el-table-column align="center" prop="" label="付款明细">
                <template slot-scope="scope">
                    <el-button @click="showDetail(scope.row)" type="text">查看明细</el-button>
                </template>
            </el-table-column>
            <el-table-column align="center" prop="signShopType" label="签约店型" :formatter="getSignShopTypeText"></el-table-column>
            <el-table-column align="center" prop="amountReceivable" label="应收金额"></el-table-column>
            <el-table-column align="center" prop="firstToll" label="路费"></el-table-column>
            <el-table-column align="center" prop="preferentialAmount" label="优惠金额"></el-table-column>
            <el-table-column align="center" prop="giveAmount" label="赠送金额"></el-table-column>
            <el-table-column align="center" prop="idCard" label="客户身份证号"></el-table-column>
            <el-table-column align="center" prop="phone" label="手机号"></el-table-column>
            <el-table-column align="center" prop="signProvince" label="签约省份"></el-table-column>
            <el-table-column align="center" prop="signCity" label="签约城市"></el-table-column>
            <el-table-column align="center" prop="signDictrict" label="签约区／县"></el-table-column>
            <el-table-column align="center" prop="busAreaName" label="商务大区"></el-table-column>
            <el-table-column align="center" prop="busGroupName" label="商务小组"></el-table-column>
            <el-table-column align="center" prop="busManagerName" label="商务经理"></el-table-column>
            <el-table-column align="center" prop="teleCompanyName" label="电销分公司"></el-table-column>
            <el-table-column align="center" prop="teleDeptName" label="电销事业部"></el-table-column>
            <el-table-column align="center" prop="teleGroupName" label="电销组"></el-table-column>
            <el-table-column align="center" prop="teleSaleName" label="创业顾问"></el-table-column>
            <el-table-column align="center" prop="isRemoteSign" label="是否远程签约" :formatter="getIsRemoteSign"></el-table-column>
            <el-table-column align="center" prop="createName" label="退款申请人"></el-table-column>
        </el-table>
         <table-pagination :pager="pager" @change="searchTable"></table-pagination>
    </el-row>
    <!-- 驳回编辑 -->
    <el-dialog :title="editRejectTitle" :visible.sync="dialogFormVisible" width="870px">
        <el-form :model="dialogForm" ref="dialogForm" :rules="dialogRules">           
            <el-form-item label="驳回人员：" :label-width="formLabelWidth" prop="person">
                {{dialogForm.auditUserName}}
            </el-form-item>
            <el-form-item label="驳回时间：" :label-width="formLabelWidth" prop="rejectTime">
                {{dialogForm.rejectTime}}
            </el-form-item>
            <el-form-item label="驳回原因：" :label-width="formLabelWidth" prop="reason" class="redcolor">
                {{dialogForm.rejectReason}}
            </el-form-item>
            <el-form-item label="退款客户金额：" :label-width="formLabelWidth" prop="cusAmount">
                <el-input v-model="dialogForm.cusAmount" placeholder="" style="width:50%" maxlength="10"></el-input>
            </el-form-item>
            <el-form-item  prop="settingStatus" label="" :label-width="formLabelWidth">
                  <div v-if="dialogForm.settingStatus == 1">
                                                                当前项目为给品牌商结算
                 </div> 
                   
            </el-form-item>
            <el-form-item label="退款时间：" :label-width="formLabelWidth" prop="refundTime">
                <el-date-picker
                    style="width: 50%;"
                    v-model="dialogForm.refundTime"
                    type="datetime"
                    placeholder="选择日期时间">
                </el-date-picker>
            </el-form-item>
            <el-form-item label="上传图片：" :label-width="formLabelWidth" prop="drawbackTime">
                <el-upload
                    class="upload-demo"
                    action="https://jsonplaceholder.typicode.com/posts/"
                    :on-preview="handlePreview"
                    :on-remove="handleRemove"
                    multiple
                    :limit="3"
                    :on-exceed="handleExceed"
                    :file-list="fileList">
                    <el-button size="small" type="primary">点击上传</el-button>
                    <div slot="tip" class="el-upload__tip">只能上传jpg/png文件，且不超过500kb</div>
                </el-upload>
            </el-form-item>
            <el-form-item label="退款原因：" :label-width="formLabelWidth" prop="reason">
                <el-input
                    type="textarea"
                    :rows="3"
                    placeholder=""
                    maxLength="100"
                    v-model="dialogForm.reason" 
                    style="width: 80%;">
                </el-input>
            </el-form-item>
        </el-form>
        <div slot="footer" class="dialog-footer">
            <el-button type="primary" @click="submitDialogForm('dialogForm')" :disabled="confirmBtnDisabled">确 定</el-button>
            <el-button @click="dialogFormVisible = false" >取 消</el-button>
        </div>
    </el-dialog>
    <!-- 驳回原因 -->
    <el-dialog title="驳回原因" :visible.sync="reasonDialog">           
        <div class="fs16 marginB20" >{{rejectReason}}</div>
    </el-dialog>
    <!-- 返款原因 -->
    <el-dialog title="返款原因" :visible.sync="reasonDialog1">           
        <div class="fs16 marginB20" >{{reason}}</div>
    </el-dialog>
    
    <!-- 下载图片 dialog 开始 -->
        <el-dialog title="下载图片" :visible.sync="downloadDialogVisible" width="870px">
            <ol>
                <li v-for="(item,index) in imgList"  >
                 <!--  <a @click="downloadImg(item.imgUrl,index)">上传图片{{index+1}}</a> -->
                 <a href="http://huiju-dev.oss-cn-beijing.aliyuncs.com/aggregation/Mb2idx7TFp.png" download="devin.png">下载图片</a>
                 <a :href="item.imgUrl" download="">上传图片{{index+1}}</a>
                </li>
              </ol> 
              <!-- <a v-for="(item,index) in imgList"  @click="downloadImg(item.url,index)">上传图片{{index+1}}</a> -->
       </el-dialog>
    <!-- 下载图片dialog 结束 -->
    
     <!-- 驳回处理 -->
    <el-dialog title="提示" :visible.sync="rejectRefundDialogVisible">
        <el-form :model="rejectRefundDialogForm" ref="rejectRefundDialogForm" :rules="rejectRefundDialogRules">            
            <div class="fs16 marginB20">确定要将此【{{sigNoTitle}}】退款申请驳回吗？</div>
            <el-form-item label="驳回原因：" label-width="100px" prop="reason">
                <el-input
                    type="textarea"
                    :rows="4"
                    placeholder="请输入驳回原因"
                    maxLength="100"
                    v-model="rejectRefundDialogForm.rejectReason">
                </el-input>
            </el-form-item>
            <div class="f-tar">最多100字</div>
        </el-form>
        <div slot="footer" class="dialog-footer">
            <el-button type="primary" @click="submitRejectRefundDialogForm('rejectRefundDialogForm')">确 定</el-button>
            <el-button @click="rejectRefundDialogVisible = false" >取 消</el-button>
        </div>
    </el-dialog>
    <!-- 驳回处理结束 -->
</div>
</body>
<!-- import Vue before Element -->
<div th:include="_footer_include :: #jsLib"></div>
<script th:src="@{/js/custom/callrecord/download.js?v=1.0.0}"></script>
<script>    
    var mainDivVM = new Vue({
        el: '#maindiv',
        data: function() {
            return {
                  pager:{//pager
                      total: 0,
                      currentPage: 1,
                      pageSize: 20,
                  },
                fileList: [],
                dialogFormVisible:false,//驳回编辑
                reasonDialog:false,//驳回原因
                downloadDialogVisible:false,//下载图片dialog
                rejectReason:'',//退款原因
                reason:'',//返款原因
                reasonDialog1:false,//返款原因
                imgList:[],
                multipleSelection: [],//选择行
                editRejectTitle:'',//驳回编辑头部
                confirmBtnDisabled:false,//提交按钮 禁用
                rejectRefundDialogVisible:false,//驳回
                sigNoTitle:'',//驳回dialog title
                rejectRefundDialogForm:{
                	
                },
                rejectRefundDialogRules:{
                	rejectReason: [
                        { required: true, message: '请输入驳回原因', trigger: 'blur' }
                    ]
                },
                form: {
                    busAreaId:'',
                    busGroupId:'',
                    busManagerId:'',
                    signProvince:'',
                    signType:'',
                    phone:'',
                    signNo:'',
                    customerName:'',
                    startTime:'',
                    endTime:'',
                    teleDeptId:'',
                    teleGroupId:'',
                    teleId:''
                },
                formLabelWidth: '150px',
                tableData: [],
                dataTable: [],
                options: [],
                busAreaList:[],//商务大区
                busGroupList:[],//签单商务组
                busManagerList:[],//商务经理
                teleDeptList:[],//电销事业部
                teleGroupIdList:[],
                teleIdList:[],
                vistitStoreTypeArr:[],//签约店型
                statusList:[
                    {
                        value: 1,
                        name: '退款确认中'
                    }, {
                        value: 2,
                        name: '已驳回'
                    }, {
                        value: 3,
                        name:'确认退款'
                    }, {
                        value: 4,
                        name: '已退款'
                    }, {
                        value: 5,
                        name: '标记退款结束'
                    }
                    
                ],//处理状态
                proviceList:[],
                signTypeList: [{
                    value: 1,
                    label: '一次性全款'
                }, {
                    value: 2,
                    label: '先交订金'
                }],
                dialogForm:{
                    cusAmount:'',
                    refundTime:'',
                    reason:''
                },
                dialogRules:{
                    reason : [
                        { required: true, message: '请输入退款原因', trigger: 'blur' }
                    ],
                    refundTime : [
                        { required: true, message: '请选择退款时间', trigger: 'blur' }
                    ],
                    cusAmount: [
                        { required: true, message: '请输入退款客户金额', trigger: 'blur' }
                    ],
                    
                }
            }             
        },
        methods: {
            submitDialogForm(formName) {//驳回提交验证
                mainDivVM.confirmBtnDisabled=true;
                this.$refs[formName].validate((valid) => {
                    if (valid) {
                        var param = this.dialogForm;
                        axios.post('/financing/refund/editRejectRefundInfo',param)
                        .then(function (response) {
                            var data =  response.data
                            if(data.code=='0'){
                                mainDivVM.$message({message:'操作成功',type:'success',duration:2000,onClose:function(){
                                    mainDivVM.dialogFormVisible=false;
                                    mainDivVM.searchTable();
                                  }});
                               
                            }else{
                                mainDivVM.$message({message:'操作失败',type:'error'});
                                console.error(data);
                            }
                        
                        })
                        .catch(function (error) {
                             console.log(error);
                        }).then(function(){
                              mainDivVM.confirmBtnDisabled=false;
                        });
                        
                        
                    } else {
                        console.log('error submit!!');
                        mainDivVM.confirmBtnDisabled=false;
                    }
                });
            },
            openSign(){//打开标记退款结束
                var rows = this.multipleSelection;
                if(rows.length==0){
                    this.$message({
                        message: '请选择数据',
                        type: 'warning'
                    });
                    return;
                }else{
                    var isPass = true;
                    var idList = new Array();
                    for(var i=0;i<rows.length;i++){
                        var curRow = rows[i];
                        if(curRow.status!=1){
                            this.$message({message:'只允许操作待处理数据',type:'warning'});
                            isPass=false;
                            break;
                        }
                        idList.push(curRow.id);
                      }
                    
                     if(!isPass){
                         return;
                     }
                    
                    
                    
                    this.$confirm('确认通过此退款申请？', '确认通过', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(() => {
                         var param={};
                         param.idList = idList;
                         axios.post('/financing/refund/updateRefundConfirm',param)
                         .then(function (response) {
                             var data =  response.data
                             if(data.code=='0'){
                                 mainDivVM.$message({message:'操作成功',type:'success',duration:2000,onClose:function(){
                                     mainDivVM.searchTable();
                                   }});
                                
                             }else{
                                 mainDivVM.$message({message:'操作失败',type:'error'});
                                 console.error(data);
                             }
                         
                         })
                         .catch(function (error) {
                              console.log(error);
                         }).then(function(){
                         });
                       
                    }).catch(() => {
                        this.$message({
                            type: 'info',
                            message: '已取消操作'
                        });          
                    });
                }
            },
            handleSelectionChange(val) {//选择节点的事件
                console.log(val)
                this.multipleSelection = val;
            }, 
            searchTable() { 
                var starTime=this.form.startTime;
                var endTime=this.form.endTime;
                if(endTime){
                    if(starTime>endTime){
                        this.$message({
                            message: '开始时间不能大于结束时间',
                            type: 'warning'
                        });
                        return;
                    }
                }
                var param = this.form;
                param.pageNum=this.pager.currentPage;
                param.pageSize=this.pager.pageSize;
                axios.post('/financing/refund/listRefundConfirm',param)
                .then(function (response) {
                    var data =  response.data
                    if(data.code=='0'){
                       var resData = data.data;
                       mainDivVM.tableData= resData.data;
                     //3.分页组件
                       mainDivVM.pager.total= resData.total;
                       mainDivVM.pager.currentPage = resData.currentPage;
                       mainDivVM.pager.pageSize = resData.pageSize;
                        
                    }else{
                        mainDivVM.$message({message:'初始化列表错误',type:'error'});
                        console.error(data);
                    }
                
                })
                .catch(function (error) {
                     console.log(error);
                }).then(function(){
                });
                
                
            },
            showReason(row){//驳回原因
                this.rejectReason='';
                this.reasonDialog=true
                this.rejectReason = row.rejectReason;
                
            },
            showReason1(row){//返款原因
                this.reason = '';
                this.reasonDialog1=true
                this.reason = row.reason;
            },
            editDialog(row){//驳回编辑
                //this.dialogForm = {};
                
                var param={};
                param.id=row.id;
                axios.post('/financing/refund/queryRefundInfoById',param)
                .then(function (response) {
                      var result =  response.data;
                      if(result.code=='0'){
                          var table=result.data;
                          mainDivVM.dialogForm= table;
                          var imgList =  table.imgList;
                          var imgShowList = new Array();
                          for(var i=0;i<imgList.length;i++){
                              var curImg = imgList[i];
                              var img={};
                              img.name="上传文件"+(i+1);
                              img.url = curImg.imgUrl;
                              img.id=curImg.id;
                              imgShowList.push(img);
                          }
                          mainDivVM.editRejectTitle = "编辑驳回（"+table.signNo+"）签约单退款申请";
                          mainDivVM.fileList=imgShowList;
                          mainDivVM.dialogFormVisible=true;
                      }else{
                          console.error(response);
                      }
                      
                })
                .catch(function (error) {
                     console.log(error);
                });
                
            },
            handlePreview(file){
                
            },
            handleRemove(file,fileList){
                 var param = {};
                 var idList = new Array();
                 idList.push(file.id)
                 param.idList = idList;
                 axios.post('/financing/refund/deleteImgByIdList',param)
                 .then(function (response) {
                       var result =  response.data;
                       if(result.code=='0'){
                           mainDivVM.$message({message:'删除成功',type:'success'});
                       }else{
                           console.error(response);
                           mainDivVM.$message({message:result.msg,type:'error'});
                       }
                       
                 })
                 .catch(function (error) {
                      console.log(error);
                 });
                 
            },
            initSelect(){
                this.initBusAreaSelect();
                this.initSignShopTypeSelect();
                this.initSignProvinceSelect();
                this.initTeleDeptId();
            },
            initBusAreaSelect(){//商务大区下拉框
                 axios.post('/organization/organization/queryBusinessAreaList', {})
                 .then(function (response) {
                       var result =  response.data;
                       if(result.code=='0'){
                           var table=result.data;
                           mainDivVM.busAreaList= table;
                       }else{
                           console.error(response);
                       }
                       
                 })
                 .catch(function (error) {
                      console.log(error);
                 });
            },
            changeBusArea(selectedValue){//改变商务大区
                this.clearBusAreaList();
                if(!selectedValue){
                    return;
                }
                var param ={};
                param.id = selectedValue;
                axios.post('/organization/organization/queryBusGroupListByParentId', param)
                .then(function (response) {
                      var result =  response.data;
                      var table=result.data;
                      mainDivVM.busGroupList= table;
                })
                .catch(function (error) {
                     console.log(error);
                });
            },
            changeBusGroup(selectedValue){//改变商务组
                this.clearBusGroupList();
                if(!selectedValue){
                    return;
                }
                var param ={};
                param.id = selectedValue;
                axios.post('/organization/organization/queryBusManagerByOrgId', param)
                .then(function (response) {
                      var result =  response.data;
                      var table=result.data;
                      mainDivVM.busManagerList= table;
                })
                .catch(function (error) {
                     console.log(error);
                });
            },
            clearBusAreaList(){
                this.busGroupList=[];
                this.form.busGroupId='';
                this.clearBusGroupList();
                
            },
            clearBusGroupList(){
                 this.busManagerList=[];
                 this.form.busManagerId='';
            },
            initSignShopTypeSelect(){//签约店型
                var param={};
                param.groupCode="vistitStoreType";
                axios.post('/dictionary/DictionaryItem/dicItemsByGroupCode',param).then(function (response) {
                    mainDivVM.vistitStoreTypeArr=response.data.data;
                });
            },
            initSignProvinceSelect(){
                axios.post('/visit/visitRecord/getSignProvince', {})
                .then(function (response) {
                      var result =  response.data;
                      if(result.code=='0'){
                          var table=result.data;
                          mainDivVM.proviceList= table;
                      }else{
                          console.error(response);
                      }
                      
                })
                .catch(function (error) {
                     console.log(error);
                });  
            },
            getSignShopTypeText(row, column, value, index){
                var valText="";
                if(value==1){
                    valText="创业店";
                }else if(value==2){
                    valText="标准店";
                }else if(value==3){
                    valText="白金店";
                }else if(value==4){
                    valText="旗舰店";
                }else if(value==5){
                    valText="区域代理";
                }
                return valText;
            },
            getIsRemoteSign(row, column, value, index){
                 var valText="";
                 if(value==0){
                     valText="否";
                 }else if(value==1){
                     valText="是";
                 }
                 return valText;
            },
            download(row){//下载图片
                this.downloadDialogVisible=true;
                var id = row.id;
                var param = {};
                param.id = id;
                axios.post('/financing/refund/listImgById', param)
                .then(function (response) {
                    var resData = response.data;
                    if(resData.code=='0'){
                        mainDivVM.imgList = resData.data;
                        //var data = resData.data;
                        /* var imgHtml = "";
                        for(var i=0;i<data.length;i++){
                            var curImg = data[i];
                            imgHtml+='<a href="'+curImg.imgUrl+'" download="上传图片'+(i+1)+'">上传图片'+(i+1)+'</a>';
                        }
                        mainDivVM.imgHtml=imgHtml; */
                    }else{
                        mainDivVM.$message({message:'查询图片失败',type:'error'});
                        console.error(resData);
                    }
                
                })
                .catch(function (error) {
                     console.log(error);
                }).then(function(){
                    
                });
            },
            downloadImg(url,index){
                var urlArr = url.split(".");
                //download(url, "上传图片"+(index+1)+"."+urlArr[urlArr.length-1], "image/*");
            /*  var x=new XMLHttpRequest();
                x.open("GET", url, true);
                x.responseType = 'blob';
                x.onload=function(e){
                    download(x.response, "上传图片"+(index+1)+"."+urlArr[urlArr.length-1], "image/*");
                    }
                x.send(); */
                
            },
            initTeleDeptId(){//电销事业部
                axios.post('/organization/organization/queryTeleDeptList', {})
                .then(function (response) {
                      var result =  response.data;
                      if(result.code=='0'){
                          var table=result.data;
                          mainDivVM.teleDeptList= table;
                      }else{
                          console.error(response);
                      }
                      
                })
                .catch(function (error) {
                     console.log(error);
                });
            },
            changeTeleDept(selectedValue){//电销事业部
                this.clearTeleDeptList();
                if(!selectedValue){
                    return;
                }
                var param ={};
                param.id = selectedValue;
                axios.post('/organization/organization/queryTeleGroupListByParentId', param)
                .then(function (response) {
                      var result =  response.data;
                      var table=result.data;
                      mainDivVM.teleGroupIdList= table;
                })
                .catch(function (error) {
                     console.log(error);
                });
            },
            changeTeleGroup(selectedValue){//改变电销组
                this.clearTeleGroupList();
                if(!selectedValue){
                    return;
                }
                var param ={};
                param.id = selectedValue;
                axios.post('/organization/organization/queryTeleSaleByOrgId', param)
                .then(function (response) {
                      var result =  response.data;
                      var table=result.data;
                      mainDivVM.teleIdList= table;
                })
                .catch(function (error) {
                     console.log(error);
                });
            },
            clearTeleDeptList(){
                this.teleGroupIdList=[];
                this.form.teleGroupId='';
                this.clearTeleGroupList();
                
            },
            clearTeleGroupList(){
                 this.teleIdList=[];
                 this.form.teleId='';
            },
            openRejectRefundDialog(){//驳回退款
            	 var rows = this.multipleSelection;
                 if(rows.length==0){
                     this.$message({
                         message: '请选择数据',
                         type: 'warning'
                     });
                     return;
                 }else{
                     var isPass = true;
                     var titleArr = new Array();
                     for(var i=0;i<rows.length;i++){
                         var curRow = rows[i];
                         if(curRow.status!=1){
                             this.$message({message:'只允许操作待处理数据',type:'warning'});
                             isPass=false;
                             break;
                         }
                         titleArr.push(curRow.signNo);
                       }
                     
                      if(!isPass){
                          return;
                      }
                      
                      this.sigNoTitle= titleArr.join("，");
                      this.rejectRefundDialogForm.reason='';
                      this.rejectRefundDialogVisible =true;
                 }
            },
            submitRejectRefundDialogForm(formName){//提交驳回原因
                this.$refs[formName].validate((valid) => {
                    if (valid) {
                        var param ={};  
                        var rows = this.multipleSelection;
                        if(rows.length==0){
                        	this.$message({message: '请选择数据',type: 'warning'});
                        	return;
                        }
                        var idArr = new Array();
                        var isPass = true;
                        for(var i=0;i<rows.length;i++){
                            var curRow = rows[i];
                            if(curRow.status!=1){
                                this.$message({message:'只允许操作待处理数据',type:'warning'});
                                isPass=false;
                                break;
                            }
                           idArr.push(curRow.id);
                        }
                        if(!isPass){
                            return;
                        }
                        
                        
                        param.idList = idArr;
                        param.rebutReason = this.rejectRefundDialogForm.rejectReason;
                        axios.post('/financing/refund/rejectRefund', param)
                        .then(function (response) {
                            var resData = response.data;
                            if(resData.code=='0'){
                            	mainDivVM.rejectRefundDialogForm.rejectReason='';
                                mainDivVM.rejectRefundDialogVisible = false;
                                mainDivVM.$message({message:'操作成功',type:'success',duration:2000,onClose:function(){
                                	  mainDivVM.searchTable();
                                }});
                            }else{
                            	mainDivVM.$message({message:resData.msg,type:'error'});
                                console.error(resData);
                            }
                        
                        })
                        .catch(function (error) {
                             console.log(error);
                        }).then(function(){
                        });

                        
                    } else {
                        console.log('error submit!!');
                        return false;
                    }
                });
            },
            openMarkRefundDialog(){
            	var rows = this.multipleSelection;
                if(rows.length==0){
                    this.$message({
                        message: '请选择数据',
                        type: 'warning'
                    });
                    return;
                }else{
                    var isPass = true;
                    var idList = new Array();
                    for(var i=0;i<rows.length;i++){
                        var curRow = rows[i];
                        if(curRow.status!=3){
                            this.$message({message:'只允许操作退款确认数据',type:'warning'});
                            isPass=false;
                            break;
                        }
                        idList.push(curRow.id);
                      }
                    
                     if(!isPass){
                         return;
                     }
                     
                     this.$confirm('确认标记为已退款吗？', '确认通过', {
                         confirmButtonText: '确定',
                         cancelButtonText: '取消',
                         type: 'warning'
                     }).then(() => {
                          var param={};
                          param.idList = idList;
                          axios.post('/financing/refund/markRefund',param)
                          .then(function (response) {
                              var data =  response.data
                              if(data.code=='0'){
                                  mainDivVM.$message({message:'操作成功',type:'success',duration:2000,onClose:function(){
                                      mainDivVM.searchTable();
                                    }});
                                 
                              }else{
                                  mainDivVM.$message({message:'操作失败',type:'error'});
                                  console.error(data);
                              }
                          
                          })
                          .catch(function (error) {
                               console.log(error);
                          }).then(function(){
                          });
                        
                     }).catch(() => {
                         this.$message({
                             type: 'info',
                             message: '已取消操作'
                         });          
                     });
                    
                }
            }
          
        },
        created(){            
            this.searchTable();
            this.initSelect();
        },
        mounted(){
            document.getElementById('maindiv').style.display = 'block';
        }
    })
</script>
</html>