<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  xmlns:th="http://www.thymeleaf.org" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<head th:replace="_header_include::frag(~{::title},~{},~{})">
    <title>后台管理系统</title>
    <style>
        button a{color:#fff!important;}
    </style>
</head>
<body>
<div id="clueManage" class="clueManage mainPadding" style="display: none;">  
    <el-breadcrumb separator="/" class="elBreadcrumb marginB20">
        <el-breadcrumb-item>Home</el-breadcrumb-item>
        <el-breadcrumb-item>财务管理</el-breadcrumb-item>
        <el-breadcrumb-item>对账结算确认</el-breadcrumb-item>
    </el-breadcrumb>
    
    <el-row class="marginB20">
    		<el-button type="primary" @click="dialogFormVisible = true"><i class="el-icon-menu"></i>选择列</el-button>
    		<shiro:hasPermission name="financing:reconciliationConfirmManager:reconciliation">
		        <el-button type="success" @click="reconciliationConfirm">对账确认</el-button>
		    </shiro:hasPermission>
    		<shiro:hasPermission name="financing:reconciliationConfirmManager:settlement">
		        <el-button type="warning" @click="settlementConfirm">结算确认</el-button>
		    </shiro:hasPermission>
	  </el-row>
    <div class="mainSearchBg">        
        <div class="mainSearchFormBox">
    	      <el-form :inline="true" :model="searchForm" class="demo-form-inline mainSearchForm" ref="searchForm"> 
      				  <el-form-item label="商务大区:"  prop="busAreaId">
      				    <el-select v-model="searchForm.busAreaId" clearable filterable  placeholder="商务大区">
      				      <el-option
      					      v-for="item in busAreaOptions"
      					      :key="item.id"
      					      :label="item.name"
      					      :value="item.id">
      					    </el-option>
      				    </el-select>
      				  </el-form-item>
      				  <el-form-item label="签单商务组:"  prop="busGroupId">
      				    <el-select v-model="searchForm.busGroupId" clearable filterable placeholder="签单商务组">
      				      <el-option
      					      v-for="item in busGroupOptions"
      					      :key="item.id"
      					      :label="item.name"
      					      :value="item.id">
      					    </el-option>
      				    </el-select>
      				  </el-form-item>
      				  <el-form-item label="签单商务经理:"  prop="busSaleId">
        				    <el-select v-model="searchForm.busSaleId" clearable filterable placeholder="签单商务经理">
          				      <el-option
          					      v-for="item in busSaleOptions"
          					      :key="item.id"
          					      :label="item.name"
          					      :value="item.id">
          					    </el-option>
        				    </el-select>
      				  </el-form-item>
                <el-form-item label="签约时间:">
                    <el-date-picker  v-model="searchForm.startTime" format="yyyy-MM-dd HH:mm" type="datetime" placeholder="选择日期"></el-date-picker>
                </el-form-item>
                <el-form-item label="—" class="widthauto">
                    <el-date-picker  v-model="searchForm.endTime" format="yyyy-MM-dd HH:mm" type="datetime" placeholder="选择日期"></el-date-picker>
                </el-form-item>
                <el-row v-show="isShow">
          				  <el-form-item label="处理状态:"  prop="status">
            				    <el-select v-model="searchForm.status" clearable placeholder="处理状态">
              				      <el-option
              					      v-for="item in statusOptions"
              					      :key="item.value"
              					      :label="item.name"
              					      :value="item.value">
              					    </el-option>
            				    </el-select>
          				  </el-form-item>
            			  <el-form-item label="签约项目:"  prop="signProjectId">
            			    <el-select v-model="searchForm.signProjectId" clearable filterable placeholder="签约项目">
            			      <el-option
            				      v-for="item in projectOptions"
            				      :key="item.id"
            				      :label="item.projectName"
            				      :value="item.id">
            				    </el-option>
            			    </el-select>
            			  </el-form-item>
              		  <el-form-item label="客户姓名:" prop="cusName">
              			  <el-input v-model="searchForm.cusName" placeholder="客户姓名" class="input-with-select"></el-input>
              		  </el-form-item>
                    <el-form-item label="付款时间:">
                        <el-date-picker  v-model="searchForm.payStartTime" format="yyyy-MM-dd HH:mm" type="datetime" placeholder="选择日期"></el-date-picker>
                    </el-form-item>
                    <el-form-item label="—" class="widthauto">
                        <el-date-picker  v-model="searchForm.payEndTime" format="yyyy-MM-dd HH:mm" type="datetime" placeholder="选择日期"></el-date-picker>
                    </el-form-item>
          				  <el-form-item label="电销事业部:"  prop="teleDeptId">
          				    <el-select v-model="searchForm.teleDeptId" clearable filterable  placeholder="电销事业部">
          				      <el-option
          					      v-for="item in teleDeptOptions"
          					      :key="item.id"
          					      :label="item.name"
          					      :value="item.id">
          					    </el-option>
          				    </el-select>
          				  </el-form-item>
          				  <el-form-item label="电销组:"  prop="teleGorupId">
          				    <el-select v-model="searchForm.teleGorupId" clearable filterable  placeholder="电销组">
          				      <el-option
          					      v-for="item in teleGorupOptions"
          					      :key="item.id"
          					      :label="item.name"
          					      :value="item.id">
          					    </el-option>
          				    </el-select>
          				  </el-form-item>
          				  <el-form-item label="创业顾问:"  prop="teleSaleId">
          				    <el-select v-model="searchForm.teleSaleId" clearable filterable placeholder="创业顾问">
          				      <el-option
          					      v-for="item in teleSaleOptions"
          					      :key="item.id"
          					      :label="item.name"
          					      :value="item.id">
          					    </el-option>
          				    </el-select>
          				  </el-form-item>
            			  <el-form-item label="签约省份:"  prop="signProvince">
            			    <el-select v-model="searchForm.signProvince" clearable filterable  placeholder="签约省份">
            			      <el-option
            				      v-for="item in provinceOptions"
            				      :key="item.name"
            				      :label="item.name"
            				      :value="item.name">
            				    </el-option>
            			    </el-select>
            			  </el-form-item>
          				  <el-form-item label="付款类型:"  prop="payType">
          				    <el-select v-model="searchForm.payType" clearable placeholder="付款类型">
          				      <el-option
          					      v-for="item in payTypeOptions"
          					      :key="item.value"
          					      :label="item.name"
          					      :value="item.value">
          					    </el-option>
          				    </el-select>
          				  </el-form-item>
              		  <el-form-item label="客户手机号:" prop="phone">
              			    <el-input v-model="searchForm.phone" placeholder="客户手机号" class="input-with-select"></el-input>
              		  </el-form-item>
              		  <el-form-item label="结算单编号:" prop="statementNo">
              			    <el-input v-model="searchForm.statementNo" placeholder="结算单编号" class="input-with-select"></el-input>
              		  </el-form-item>
              		  <el-form-item label="签约单编号:" prop="signNo">
              			  <el-input v-model="searchForm.signNo" placeholder="签约单编号" class="input-with-select"></el-input>
              		  </el-form-item>
                </el-row>
                <div class="mainSearchBtnBox">
          		      <el-button type="primary" @click="searchTable()" class="searchBtn">搜索</el-button>
                    <el-button type="info" class="searchBtn">取消</el-button>
                    <span style="color: #5c6be8;cursor: pointer;margin:0 10px;" @click="toogleClick">更多搜索<i class="el-icon-arrow-down greycolor paddingL6"></i>
                </div>
        	  </el-form>
        </div>
      	<div class="fs16 marginB20">已结算佣金总计：<span style="color:red;"> {{count}}元</span></div>
        <el-row>
            <el-table  ref="multipleTable" tooltip-effect="dark" border  @selection-change="handleSelectionChange"
                style="width: 100%"  :data="dataTable" >
               <el-table-column align="center" type="selection" label="全选" width="55"></el-table-column>
               <el-table-column align="center" type="index" label="序号" width="55"></el-table-column>
               
               <el-table-column align="center" :key="item.fieldCode" :prop="item.fieldCode" :label="item.displayName" width="80"
    	         v-for="(item,key,index) in tableColums" v-if="item.fieldCode == 'isDoubt'">
    	               <template slot-scope="scope">
               		  	<div v-if="scope.row.isDoubt === 1">
                            <el-button type="text" size="small" @click="viewDoubt(scope.row)">
                            	查看疑意
                            </el-button>
                        </div>
                    </template>
    	        </el-table-column>
                <el-table-column align="center" :key="item.fieldCode" :prop="item.fieldCode" :label="item.displayName" :width="item.width"
    	         	v-else>
    	        </el-table-column>
            </el-table>
            <table-pagination :pager="pager" @change="searchTable"></table-pagination>
        </el-row>
    </div>
    <!--查看疑意-->
    <el-dialog title="查看疑意" :visible.sync="viewDoubtVisable"
               width="50%">
        <template>
            <el-form :model="viewDoubtForm" ref="viewDoubtForm">
                <el-form-item label="" :required="true">
                    <div class="lineFeed">{{viewDoubtForm.doubtRemark}}</div>
                </el-form-item>
            </el-form>
        </template>
    </el-dialog>
    
    <el-dialog title="自定义列" :visible.sync="dialogFormVisible">
	  <el-form :model="form">
	    
		  <el-form-item label="列名" prop="type">
		    <el-checkbox-group v-model="form.type">
		      <el-checkbox :label="item.sortNum+'_'+item.fieldCode+'_'+item.displayName+'_'+item.id"  name="type" :key="item.fieldCode"  v-for="(item,index) in  allTableColums ">
		          {{item.displayName}}
		      </el-checkbox>
		  
		     </el-checkbox-group>
		  </el-form-item>
	    
	  </el-form>
	  
	  <div slot="footer" class="dialog-footer">
	    <el-button @click="dialogFormVisible = false">取 消</el-button>
	    <el-button type="primary" @click="confirmColumn">确 定</el-button>
	  </div>
	</el-dialog>
</div>
<!-- import common js-->
<div th:include="_footer_include :: #jsLib"></div>
</body>
<script th:inline="javascript">
var busAreaList=[[${busAreaList}]];//商务大区
var busGroupList=[[${busGroupList}]];//商务组
var busSaleList=[[${busSaleList}]];//商务经理
var teleDeptList=[[${teleDeptList}]];//电销事业部
var teleGroupList=[[${teleGroupList}]];//电销组
var teleSaleList=[[${teleSaleList}]];//创业顾问
var provinceList=[[${provinceList}]];//省份
var projectList=[[${projectList}]];//项目
var fieldList=[[${fieldList}]];//自定义字段
var userFieldList=[[${userFieldList}]];//用户自定义字段
var vistitStoreTypeList=[[${vistitStoreTypeList}]];//签约店型
var clueVM = new Vue({
        el: '#clueManage',
        data: {
          isShow:false,
      		searchForm: {
	       		busAreaId: '',
	       		busGroupId: '',
	       		busSaleId: '',
	       		status: '',
	       		signProjectId: '',
	       		cusName: '',
	       		teleDeptId: '',
	       		teleGorupId: '',
	       		teleSaleId: '',
	       		signProvince: '',
	       		payType: '',
	       		phone: '',
	       		startTime: '',
	       		endTime: '',
	       		payStartTime: '',
	       		payEndTime: '',
	       		statementNo: '',
	       		signNo: ''
            },
            viewDoubtForm: {
            	doubtRemark: ''
            },
            count:0,
            dataTable:[],
            allTableColums:[],
            tableColums:[],
            dialogFormVisible: false,
            form: {
	          	type: [],
	        },
            busAreaOptions:busAreaList,
            busGroupOptions:busGroupList,
            busSaleOptions:busSaleList,
            teleDeptOptions:teleDeptList,
            teleGorupOptions:teleGroupList,
            teleSaleOptions:teleSaleList,
            provinceOptions:provinceList,
            projectOptions:projectList,
            statusOptions:[{
            	value:1,
            	name:"未提交对账"
            },{
            	value:2,
            	name:"待处理"
            },{
            	value:3,
            	name:"已对账"
            },{
            	value:4,
            	name:"已结算"
            }],
            payTypeOptions:[{
            	value:1,
            	name:"全款"
            },{
            	value:2,
            	name:"定金"
            },{
            	value:3,
            	name:"追加定金"
            },{
            	value:4,
            	name:"尾款"
            }],
            pager:{
                total: 0,
                currentPage: 1,
                pageSize: 20,
            },
            allocationFormRules: {
            	saleId: [
                    { required: true, message: '请选择商务经理', trigger: 'change' }
                ]
              },
            transferFormRules: {
            	saleId: [
                    { required: true, message: '请选择商务经理', trigger: 'change' }
                ]
              },
            multipleSelection:[],
            viewDoubtVisable:false,
            formLabelWidth: '150px',
            formLabelWidth1: '120px',
        },
        methods: {
        	searchTable() {
                var param ={};
                var startTime = this.searchForm.startTime;
                var endTime = this.searchForm.endTime;
                var payStartTime = this.searchForm.payStartTime;
                var payEndTime = this.searchForm.payEndTime;
            	var vilad=false;
                if(startTime&&endTime&&startTime> endTime){
                	vilad=true;
                }
                if(payStartTime&&payEndTime&&payStartTime> payEndTime){
                	vilad=true;
                }
                if(vilad){
                	this.$message({
                        message: '开始时间不能大于结束时间',
                        type: 'warning'
                      });
                    return;
                }
                param.startTime = startTime;
                param.endTime = endTime;
                param.payStartTime = payStartTime;
                param.payEndTime = payEndTime;
                param.pageSize = this.pager.pageSize;
                param.pageNum = this.pager.currentPage;
                param.busAreaId = this.searchForm.busAreaId;
                param.busGroupId = this.searchForm.busGroupId;
                param.busSaleId = this.searchForm.busSaleId;
                param.status = this.searchForm.status;
                param.signProjectId = this.searchForm.signProjectId;
                param.cusName = this.searchForm.cusName;
                param.teleDeptId = this.searchForm.teleDeptId;
                param.teleGorupId = this.searchForm.teleGorupId;
                param.teleSaleId = this.searchForm.teleSaleId;
                param.signProvince = this.searchForm.signProvince;
                param.payType = this.searchForm.payType;
                param.phone = this.searchForm.phone;
                param.signNo = this.searchForm.signNo;
                param.statementNo = this.searchForm.statementNo;
                
                //列表只查询正常数据，取消删除数据不查询
                //param.delFalg = this.searchForm.delFalg;
                console.info(param);
                axios.post('/financing/reconciliationConfirm/list', param)
                .then(function (response) {
                      var result =  response.data;
                      console.info(result);
                      var table=result.data;
                      clueVM.pager.total =  table.total;
                      clueVM.pager.currentPage = table.currentPage;
                      //查询已结算佣金总计
                      axios.post('/financing/reconciliationConfirm/sumCommissionMoney', param)
                      .then(function (response) {
                            var result =  response.data;
                            console.info(result);
                            clueVM.count= result.data;
                      })
                      .catch(function (error) {
                           console.log(error);
                      });
                      
                      var data= table.data;
                      for(var i=0;i<data.length;i++){
                    	  data[i].status=clueVM.transformStatus(null,null,data[i].status,null);
                    	  data[i].signType=clueVM.transformSignType(null,null,data[i].signType,null);
                    	  data[i].signShopType=clueVM.transformSignShopType(null,null,data[i].signShopType,null);
                    	  data[i].payType=clueVM.transformPayType(null,null,data[i].payType,null);
                    	  data[i].payMode=clueVM.transformStatus(null,null,data[i].payMode,null);
                    	  data[i].isRemoteSign=clueVM.transformSex(null,null,data[i].isRemoteSign,null);
                    	  if(data[i].ratio){
	                    	  data[i].ratio=data[i].ratio+"%";
                    	  }
                      }
                      clueVM.dataTable= data;
                })
                .catch(function (error) {
                     console.log(error);
                });
                
              },
              //选择行
              handleSelectionChange(val) {
                  this.multipleSelection = val;
              },
              handleSizeChange(val) {
                  //下拉框  每页 10,20条切换 调用
                     console.log(`每页 ${val} 条`);
                  this.pageSize = val;
                  this.initTableData(1);
               },
               handleCurrentChange(val) {
                   //点击 页码
                 console.log(`当前页: ${val}`);
                 this.initTableData(val);
               },
               //是否转换方法
               transformSex(row, column, cellValue, index) {
                 var text="";
                 if(cellValue=="1"){
                   text="是"
                 }else if(cellValue=="0"){
                   text="否"
                 }
                 return text;
               },
               //签约类型转换方法
               transformSignType(row, column, cellValue, index) {
                 var text="";
                 if(cellValue=="1"){
                   text="一次性全款"
                 }else if(cellValue=="2"){
                   text="先交定金"
                 }
                 return text;
               },
               //付款类型转换方法
               transformPayType(row, column, cellValue, index) {
                 var text="";
                 if(cellValue=="1"){
                   text="全款"
                 }else if(cellValue=="2"){
                   text="定金"
                 }else if(cellValue=="3"){
                   text="追加定金"
                 }else if(cellValue=="4"){
                   text="尾款"
                 }
                 return text;
               },
               //付款方式转换方法
               transformPayMode(row, column, cellValue, index) {
                 var text="";
                 if(cellValue=="1"){
                   text="现金"
                 }else if(cellValue=="2"){
                   text="POS"
                 }else if(cellValue=="3"){
                   text="转账"
                 }
                 return text;
               },
               //处理状态转换方法
               transformStatus(row, column, cellValue, index) {
                 var text="";
                 if(cellValue=="2"){
                   text="待处理";
                 }else if(cellValue=="3"){
                   text="已对账";
                 }else if(cellValue=="4"){
                   text="已结算";
                 }else{
                   text="未提交对账";
                 }
                 return text;
               },
               //店型转换方法
               transformSignShopType(row, column, cellValue, index) {
             	  var text="";
             	  if(vistitStoreTypeList){
 	                  for(var i=0;i<vistitStoreTypeList.length;i++){
 	                		if(cellValue==vistitStoreTypeList[i].value){
 	                			text=vistitStoreTypeList[i].name;
 	                		}
 	                	}
             	  }
                   return text;
               },
              
               //对账确认
               reconciliationConfirm() {
           	       var rows = this.multipleSelection;
            	   if(rows.length==0){
                       this.$message({
                          message: '请至少选择一条数据',
                          type: 'warning'
                        });
                       return;
                   }
   	           	   var idList = [];
   	               for(var i=0;i<rows.length;i++){
   	            	  if(rows[i].status!='待处理'){
             		    this.$message({
                            message: '只允许操作待处理状态的数据',
                            type: 'warning'
                          });
                         return;
             	      }
   	            	   var curRow = rows[i];
   	            	   idList.push(curRow.accountId);
   	               }
   	            this.$confirm('确认手工操作为已对账吗？', '提示', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                    type: 'warning'
                }).then(() => {
                	//对账确认
	            	var param  = {};
   	           	  	param.idList=idList;
                     axios.post('/financing/reconciliationConfirm/reconciliationConfirm',param)
                      .then(function (response) {
                          var data =  response.data;
                          if(data.code=='0'){
                          	clueVM.$message({message:'对账成功',type:'success',duration:1000,onClose:function(){
                          		clueVM.allocationVisible = false;
                          		clueVM.searchTable();
                      	    }});
                          }else{
                          	clueVM.$message({
                                  message: "接口调用失败",
                                  type: 'error'
                                }); 
                          }
                      })
                      .catch(function (error) {
                        console.log(error);
                      })
                      .then(function () {
                      	
                      });
                }).catch(() => {
                       
                });
	            	
               },
               //结算确认
               settlementConfirm() {
            	   var rows = this.multipleSelection;
            	   if(rows.length==0){
                       this.$message({
                          message: '请至少选择一条数据',
                          type: 'warning'
                        });
                       return;
                   }
   	           	   var idList = [];
   	               for(var i=0;i<rows.length;i++){
   	            		if(rows[i].status!='已对账'){
             		    this.$message({
                            message: '只允许操作已对账状态的数据',
                            type: 'warning'
                          });
                         return;
             	      }
   	            	   var curRow = rows[i];
   	            	   idList.push(curRow.accountId);
   	               }
   	            this.$confirm('确认手工操作为已结算吗？', '提示', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                    type: 'warning'
                }).then(() => {
                	//结算确认
	            	var param  = {};
   	           	  	param.idList=idList;
                     axios.post('/financing/reconciliationConfirm/settlementConfirm',param)
                      .then(function (response) {
                          var data =  response.data;
                          if(data.code=='0'){
                          	clueVM.$message({message:'结算成功',type:'success',duration:1000,onClose:function(){
                          		clueVM.allocationVisible = false;
                          		clueVM.searchTable();
                      	    }});
                          }else{
                          	clueVM.$message({
                                  message: "接口调用失败",
                                  type: 'error'
                                }); 
                          }
                      })
                      .catch(function (error) {
                        console.log(error);
                      })
                      .then(function () {
                      	
                      });
                }).catch(() => {
                       
                });
               },
               viewDoubt(row) {
                   // 查看疑意
                   clueVM.viewDoubtVisable = true;
                   clueVM.viewDoubtForm.doubtRemark = row.doubtRemark;
               },
               confirmColumn(){
                 	//处理用户选择的列
                 	console.info(this.form.type);
                 	if(this.form.type.length==0){
               		this.$message({
                           message: "请至少保留一列",
                           type: 'error'
                         }); 
               		return;
               	}
                 	this.dialogFormVisible = false;
                 	var customerShowColun = [];
                 	var customerColumn = this.form.type;
                 	customerColumn.sort(this.sortNumber);//对选择的列排序
                 	var idList=[];
                 	for(var i=0;i<customerColumn.length;i++){
                 		var curItem = customerColumn[i];
                 		var itemArr = curItem.split("_");
                 		var obj = {};
                 		obj.fieldCode=itemArr[1];
                 		obj.displayName=itemArr[2];
                 		customerShowColun.push(obj);
                 		idList.push(itemArr[3])
                 	}
                 	this.tableColums = customerShowColun;
                 	var param ={};
                   param.fieldIdList = idList;
                   param.menuCode = "financing:reconciliationConfirmManager";
                   console.info(param);
                   if(idList.length!=0){
   	                axios.post('/customfield/customField/saveUserField', param)
   	                .then(function (response) {
   	                	
   	                })
   	                .catch(function (error) {
   	                     console.log(error);
   	                });
                   }
                 },
                 initColumn(){
                 	//初始化table 列 和 用户自定义列
                 	this.allTableColums = fieldList;
                 	if(userFieldList.length!=0){
                 		var type=[];
                     	for(var i=0;i<userFieldList.length;i++){
                     		type.push(userFieldList[i].sortNum+'_'+userFieldList[i].fieldCode+'_'+userFieldList[i].displayName+'_'+userFieldList[i].fieldId)
                    	}
   	              	this.form.type = type;
   	              	this.confirmColumn();
                 	}else{
                 		var type=[];
                     	for(var i=0;i<fieldList.length;i++){
                     		type.push(fieldList[i].sortNum+'_'+fieldList[i].fieldCode+'_'+fieldList[i].displayName+'_'+fieldList[i].id)
                    	}
   	              	this.form.type = type;
   	              	this.confirmColumn();
                 	}
                 	
                },
                sortNumber(a,b) {
                    //对数组中元素，按照数字 从小到大 排序
                    return a.split("_")[0] - b.split("_")[0];
                },
                toogleClick(){
                    if(this.isShow){
                        this.isShow=false
                    }else{
                        this.isShow=true
                    }          
                },
        },
        created(){
            console.info("create method");
            this.initColumn();
            this.searchTable();
           
        },
        mounted(){
           console.info("mounted method");
           document.getElementById('clueManage').style.display = 'block';
        }
    })
    
</script>
</html>