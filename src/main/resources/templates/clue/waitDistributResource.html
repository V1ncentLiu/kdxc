<!DOCTYPE html>
<html>
<head th:include="_header_include::frag(~{::title},~{},~{})">
<title>待分发资源</title>
<meta charset="UTF-8">
<!-- import CSS -->
<link rel="stylesheet" href="css/element-ui.css">
<link rel="stylesheet" href="css/base.css">
<style>
.dialogForm .el-form-item {
	margin-bottom: 5px;
}
</style>
</head>
<body>
	<div id="waitDistributResource"
		class="waitDistributResource mainPadding" style="display: none;">
		<el-breadcrumb separator="/" class="elBreadcrumb marginB20">
		<el-breadcrumb-item>Home</el-breadcrumb-item> <el-breadcrumb-item>线索管理</el-breadcrumb-item>
		<el-breadcrumb-item>待分发资源池</el-breadcrumb-item> </el-breadcrumb>
		<el-row class="marginB10"> 
            <el-button type="primary" @click="dialogChooseList = true"><i class="el-icon-menu"></i>选择列</el-button>
            <shiro:hasPermission name="waitDistributResource:distribute">
		        <el-button type="success" @click="editFun">自动分发</el-button> 
            </shiro:hasPermission>			
		</el-row>
		<el-row class="marginB10 greybg padding20" style="padding-bottom: 0">
		<el-form :inline="true" :model="form" ref="form"> <el-form-item
			label="创建时间:"> <el-date-picker style="width: 100%;"
			v-model="form.starTime" type="datetime" placeholder="选择日期时间">
		</el-date-picker> </el-form-item> <el-form-item label="——"> <el-date-picker
			style="width: 100%;" v-model="form.endTime" type="datetime"
			placeholder="选择日期时间"> </el-date-picker> </el-form-item> <el-form-item label="">
		<el-select v-model="form.resourceProject" placeholder="资源项目" clearable >
		<el-option v-for="item in proSelectArr" :key="item.id"
			:label="item.projectName" :value="item.id"> </el-option> </el-select> </el-form-item> <el-form-item
			label=""> <el-select v-model="form.resourcePerson"
			placeholder="资源专员" clearable > <el-option
			v-for="item in userListArr" :key="item.id" :label="item.name"
			:value="item.id"> </el-option> </el-select> </el-form-item> <el-form-item label="">
		<el-input v-model="form.customName" placeholder="客户姓名"></el-input> </el-form-item> <el-form-item
			label=""> <el-input v-model="form.resourceId"
			placeholder="线索ID"></el-input> </el-form-item> <el-form-item label="">
		<el-select v-model="form.medium" placeholder="媒介" clearable > <el-option
			v-for="item in mediumArry" :key="item.value" :label="item.name"
			:value="item.value"> </el-option> </el-select> </el-form-item> <el-form-item label="">
		<el-select v-model="form.category" placeholder="资源类别" clearable >
		<el-option v-for="item in categoryArr" :key="item.value"
			:label="item.name" :value="item.value"> </el-option> </el-select> </el-form-item> <el-form-item
			label="">
			<el-select v-model="form.industryCategory"
			placeholder="行业类别" clearable > <el-option
			v-for="item in industryCategoryArr" :key="item.value"
			:label="item.name" :value="item.value"> </el-option> </el-select> </el-form-item> <el-form-item
			label=""> <el-input v-model="form.email"
			placeholder="邮箱"></el-input> </el-form-item> <el-form-item label="">
		<el-input v-model="form.qq" placeholder="QQ" maxLength="20"
			@keyup.native="number"></el-input> </el-form-item> <el-form-item label="">
		<el-input v-model="form.phone" placeholder="手机号" maxLength="11"
			@keyup.native="number1"></el-input> </el-form-item> <el-button icon="el-icon-search" type="primary"
			@click="initTableData">搜索</el-button> </el-form> </el-row>
		<el-row> 
		<el-table ref="tableData" tooltip-effect="dark"
			style="width: 100%" border :data="tableData"
			@row-dblclick="rowDblClick"
			@selection-change="handleSelectionChange">
		<el-table-column align="center" prop="clueId" type="selection" width="55"></el-table-column> 
		<el-table-column align="center" type="index" label="序号" width="55"></el-table-column> 
		<el-table-column align="center" :key="item.fieldCode" :prop="item.fieldCode" :label="item.displayName" :width="item.width"
	         v-for="(item,key,index) in tableColums" >
	        </el-table-column>
		</el-table> <table-pagination :pager="pager" @change="initTableData"></table-pagination>
		</el-row>
		<!-- dialog -->
		<el-dialog title="线索详细信息" :visible.sync="dialogFormVisible">
		<el-form :model="dialogForm" ref="dialogForm"
			class="marginB20 dialogForm">
		<div class="fs16 redcolor marginB20">线索ID：{{basic.id}}</div>
		<div class="borderbox padding20">
			<el-row> 
				<el-col :span="12"> 
					<el-form-item label="客户姓名：" :label-width="formLabelWidth"> {{customer.cusName}} </el-form-item> 
				</el-col> 
				<el-col :span="12"> 
					<el-form-item label="手机号：" :label-width="formLabelWidth"> {{customer.phone}} </el-form-item>
				</el-col>
			</el-row>
			<el-row> <el-col :span="12"> <el-form-item
				label="微信：" :label-width="formLabelWidth"> {{customer.wechat}}<span>/二维码</span>
			</el-form-item> </el-col> <el-col :span="12"> <el-form-item label="邮箱："
				:label-width="formLabelWidth"> {{customer.email}}</el-form-item> </el-col> </el-row>
			<el-row> <el-col :span="12"> <el-form-item
				label="QQ：" :label-width="formLabelWidth"> {{customer.qq}}
			</el-form-item> </el-col> <el-col :span="12"> <el-form-item label="资源类型："
				:label-width="formLabelWidth">{{basic.typeName}}</el-form-item> </el-col> </el-row>
			<el-row> <el-col :span="12"> <el-form-item
				label="资源项目：" :label-width="formLabelWidth">  {{basic.projectName}} </el-form-item> </el-col> <el-col
				:span="12"> <el-form-item label="资源类别："
				:label-width="formLabelWidth"> {{basic.categoryName}}</el-form-item> </el-col> </el-row>
			<el-row> <el-col :span="12"> <el-form-item
				label="媒介：" :label-width="formLabelWidth"> {{basic.sourceName}} </el-form-item> </el-col> <el-col
				:span="12"> <el-form-item label="搜索词："
				:label-width="formLabelWidth"> {{basic.searchWord}} </el-form-item> </el-col> </el-row>
			<el-row> <el-col :span="12"> <el-form-item
				label="行业类别：" :label-width="formLabelWidth"> {{basic.industryCategoryName}}  </el-form-item> </el-col> <el-col
				:span="12"> <el-form-item label="留言时间："
				:label-width="formLabelWidth"> {{basic.messageTime}} </el-form-item> </el-col> </el-row>
			<el-row> <el-col :span="24"> <el-form-item
				label="留言重点：" :label-width="formLabelWidth">
			 {{basic.messagePoint}}</el-form-item> </el-col> </el-row>
		</div>
		</el-form> </el-dialog>
        <!-- 自定义列 -->
        <!-- 选择列 -->
    <el-dialog title="选择列" :visible.sync="dialogChooseList">
	  <el-form :model="fieldFrom">
	    
		  <el-form-item label="列名" prop="type">
		    <el-checkbox-group v-model="fieldFrom.type">
		      <el-checkbox :label="item.sortNum+'_'+item.fieldCode+'_'+item.displayName+'_'+item.id"  name="type" :key="item.fieldCode"  v-for="(item,index) in  allTableColums ">
		          {{item.displayName}}
		      </el-checkbox>
		     </el-checkbox-group>
		  </el-form-item>
	    
	  </el-form>
	  
	  <div slot="footer" class="dialog-footer">
	    <el-button @click="dialogChooseList = false">取 消</el-button>
	    <el-button type="primary" @click="confirmColumn">确 定</el-button>
	  </div>
	</el-dialog>
	</div>
</body>
<div th:include="_footer_include :: #jsLib"></div>
<script th:inline="javascript">
var proSelect=[[${proSelect}]];
var userList=[[${userList}]];
var fieldList=[[${fieldList}]];//自定义字段
var userFieldList=[[${userFieldList}]];//用户自定义字段
var wdrVM = new Vue({
        el: '#waitDistributResource',
        data: function() {
            return {
                dialogFormVisible: false,
                multipleSelection: [],//选择行
                form: {
                    starTime:'',
                    endTime:'',
                    resourceProject:'',
                    resourcePerson:'',
                    customName:'',
                    resourceId:'',
                    medium:'',
                    resourceType:'',
                    tradeType:'',
                    email:'',
                    qq:'',
                    phone:'',
                },
                pager:{ 
                    total: 0,
                    currentPage: 1,
                    pageSize: 20,
                },
                dialogForm:{},
                formLabelWidth: '120px',
                industryCategoryArr:[],
                categoryArr:[],
                mediumArry:[],
                tableData: [],             
                options: [],
                proSelectArr:proSelect,
                userListArr:userList,
                customer:"",
                basic:'',
                dialogChooseList: false,
                allTableColums:[],//自定义列
                tableColums:[],
                fieldFrom: {
 	               type: []
 	             },
            }        	  
        },
        methods: {
        	 initTableData(){
                 var param = {};
                 var pageSize = this.pager.pageSize;
                 var pageNum = this.pager.currentPage;
             var starTime=this.form.starTime;
             var endTime=this.form.endTime;
             if(starTime&&endTime&&starTime> endTime){
                 this.$message({
                   message: '开始时间不能大于结束时间',
                   type: 'warning'
                 });
                 return;
               }
                 param.pageNum=pageNum;
                 param.pageSize=pageSize;
                 param.createTimeStart=this.form.starTime;
                 param.createTimeEnd=this.form.endTime;
                 param.projectId=this.form.resourceProject; 
                 param.operationId=this.form.resourcePerson;
                 param.cusName=this.form.customName;
                 param.clueId=this.form.resourceId;
                 param.source=this.form.medium;
                 param.category=this.form.category;
                 param.industryCategory=this.form.industryCategory;
                 param.qq=this.form.qq;
                 param.email=this.form.email;
                 param.phone=this.form.phone;
     		    axios.post('/exetend/agendaTaskManager/queryPageAgendaTask',param).then(function (response) {
     				if(!response){
     					wdrVM.$message({
	                        message: "接口调用失败",
	                        type: 'error'
	                      }); 
						return ;
					}
     				var resobj= response.data;
					if(!resobj){
						wdrVM.$message({
	                        message: "接口调用失败",
	                        type: 'error'
	                      }); 
						return ;
					} 
					if(resobj.code!='0'){
						wdrVM.$message({
	                        message: "接口调用失败",
	                        type: 'error'
	                      }); 
						return ;
					}
     		    	var pageData=resobj.data;
     		    	wdrVM.pager.total=pageData.total;
     		    	wdrVM.pager.currentPage = pageData.currentPage;
     		    	wdrVM.pager.pageSize = pageData.pageSize;
     		    	wdrVM.tableData =pageData.data; 	
     			})
         	},
            handleSelectionChange(val) {//选择节点的事件
                console.log(val)
                this.multipleSelection = val;
            }, 
            submitForm(formName){//表格搜索
                var starTime=this.form.starTime;
                var endTime=this.form.endTime;
                if(endTime){
                    if(starTime>endTime){
                        this.$message({
                            message: '开始时间不能大于结束时间',
                            type: 'warning'
                        });
                        return;
                    }
                }
            },
            //双击行处理
            rowDblClick(row, column, event){//双击查看详情
             var  param={};
             param.clueId=row.clueId;
     		  axios.post('/exetend/agendaTaskManager/customerInfoView',param).then(function (response) {
     				if(!response){
     					wdrVM.$message({
	                        message: "接口调用失败",
	                        type: 'error'
	                      }); 
						return ;
					}
     				var resobj= response.data;
					if(!resobj){
						wdrVM.$message({
	                        message: "接口调用失败",
	                        type: 'error'
	                      }); 
						return ;
					} 
					if(resobj.code!='0'){
						wdrVM.$message({
	                        message: "接口调用失败",
	                        type: 'error'
	                      }); 
						return ;
					}
				  var customer=response.data.data.clueCustomer;
				  var phone = '';
				  if(customer.phone){
					  phone+=customer.phone;
				  }
				  if(customer.phone2){
					  if(phone){
						  phone+=",";
					  }
					  phone+=customer.phone2;
				  }
				  if(customer.phone3){
					  if(phone){
						  phone+=",";
					  }
					  phone+=customer.phone3;
				  }
				  customer.phone=phone;
				  wdrVM.customer=customer;
				  var messageTime= response.data.data.clueBasic.messageTime;
				  if(null!=messageTime){
					  response.data.data.clueBasic.messageTime=crtTimeFtt1(messageTime);
				  }
				   wdrVM.basic=response.data.data.clueBasic;
     			})
            	
            	
                this.dialogFormVisible = true
            },
            editFun() {
                var rows = this.multipleSelection;
                if(rows.length==0){
                    this.$message({
                        message: '请选择数据进行分发',
                        type: 'warning'
                    });
                    return;
                }else{
                    this.$confirm('确定要按照规则执行自动分发吗?', '提示', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(() => {
                    	var param={};
                        var rows = this.multipleSelection;
                        var ids=[];
                        if(null!=rows&&rows.length>0){
                        	for(var i=0;i<rows.length;i++){
                        		ids.push(rows[i].clueId);	
                        	}
                        }
                        param.idList=ids;
               		  axios.post('/exetend/agendaTaskManager/autoAllocationTask',param).then(function (response) {
           			 if(!response){
           					wdrVM.$message({
      	                        message: "接口调用失败",
      	                        type: 'error'
      	                      }); 
      						return ;
      					}
           				var resobj= response.data;
      					if(!resobj){
      						wdrVM.$message({
      	                        message: "接口调用失败",
      	                        type: 'error'
      	                      }); 
      						return ;
      					} 
      					if(resobj.code!='0'){
      						wdrVM.$message({
      	                        message: "接口调用失败",
      	                        type: 'error'
      	                      }); 
      						return ;
      					}
      					
      				 wdrVM.$message({message:'成功分发'+resobj.data+'条资源',type:'success',duration:2000,onClose:function(){
      						wdrVM.initTableData();
   		        	}});
      			 
           		  	});
                    }).catch(() => {
                        this.$message({
                            type: 'info',
                            message: '已取消操作'
                        });          
                    });
                }                
            },
            number(){
    　　　      this.form.qq=this.form.qq.replace(/[^\.\d]/g,'');
                this.form.qq=this.form.qq.replace('.','');
        　　},
            number1(){
    　　　      this.form.phone=this.form.phone.replace(/[^\.\d]/g,'');
                this.form.phone=this.form.phone.replace('.','');
        　　},
          confirmColumn(){
           	this.dialogChooseList = false;
           	//处理用户选择的列
           	console.info(this.fieldFrom.type);
           	if(this.fieldFrom.type.length==0){
           		this.$message({
                       message: "请至少保留一列",
                       type: 'error'
                     }); 
           		return;
           	}
           	var customerShowColun = [];
           	var customerColumn = this.fieldFrom.type;
           	customerColumn.sort(this.sortNumber);//对选择的列排序
           	var idList=[];
           	for(var i=0;i<customerColumn.length;i++){
           		var curItem = customerColumn[i];
           		var itemArr = curItem.split("_");
           		var obj = {};
           		obj.fieldCode=itemArr[1];
           		obj.displayName=itemArr[2];
           		customerShowColun.push(obj);
           		idList.push(itemArr[3])
           	}
           	this.tableColums = customerShowColun;
           	var param ={};
             param.fieldIdList = idList;
             param.menuCode = "waitDistributResource";
             console.info(param);
             if(idList.length!=0){
                 axios.post('/customfield/customField/saveUserField', param)
                 .then(function (response) {
                 	
                 })
                 .catch(function (error) {
                      console.log(error);
                 });
             }
           },
           initColumn(){
           	//初始化table 列 和 用户自定义列
           	this.allTableColums = fieldList;
           	if(userFieldList.length!=0){
           		var type=[];
               	for(var i=0;i<userFieldList.length;i++){
               		type.push(userFieldList[i].sortNum+'_'+userFieldList[i].fieldCode+'_'+userFieldList[i].displayName+'_'+userFieldList[i].fieldId)
                }
              	this.fieldFrom.type = type;
              	this.confirmColumn();
           	}else{
           		var type=[];
                 	for(var i=0;i<fieldList.length;i++){
                 		type.push(fieldList[i].sortNum+'_'+fieldList[i].fieldCode+'_'+fieldList[i].displayName+'_'+fieldList[i].id)
                	}
	              	this.fieldFrom.type = type;
	              	this.confirmColumn();
           	}
           	
           },
           sortNumber(a,b) {
               //对数组中元素，按照数字 从小到大 排序
               return a.split("_")[0] - b.split("_")[0];
              }

        },
        mounted(){
            document.getElementById('waitDistributResource').style.display = 'block';
            this.initColumn();
        	this.initTableData();
            //初始化媒介
      	   var  param={};
      	   param.groupCode="medium";
            axios.post('/dictionary/DictionaryItem/dicItemsByGroupCode',param).then(function (response) {  
              wdrVM.mediumArry=response.data.data;
           });
            
            //初始资源类别数据
             param={};
           	param.groupCode="clueCategory";
             axios.post('/dictionary/DictionaryItem/dicItemsByGroupCode',param).then(function (response) {  
                wdrVM.categoryArr=response.data.data;
             });
             //初始行业类别
             param={};
             param.groupCode="industryCategory";
              axios.post('/dictionary/DictionaryItem/dicItemsByGroupCode',param).then(function (response) {  
            	  wdrVM.industryCategoryArr=response.data.data;
              }); 
             
        }
    })
    function crtTimeFtt1(val, row) {
        if (val != null) {
            var date = new Date(val);

            var month = (date.getMonth() + 1);
            if(month<10){
                month = "0"+month;
            }
            var day = date.getDate();
            if(day<10){
                day = "0"+day;
            }
            var hour = date.getHours();
            if(hour<10){
                hour = "0"+hour;
            }
            var minu = date.getMinutes();
            if(minu<10){
                minu = "0"+minu;
            }
            var mill = date.getSeconds();
            if(mill<10){
                mill = "0"+mill;
            }
            return date.getFullYear()+''+(month) + ''+day+' '+hour+":"+minu+":"+mill;
        }
    }
 
</script>
</html>