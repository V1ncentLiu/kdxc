<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  xmlns:th="http://www.thymeleaf.org" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<head th:replace="_header_include::frag(~{::title},~{},~{})">
    <title>后台管理系统</title>
    <style>
        button a{color:#fff!important;}
    </style>
</head>
<body>
<div id="clueManage" class="clueManage mainPadding">  
    <el-breadcrumb separator="/" class="elBreadcrumb marginB20">
        <el-breadcrumb-item>Home</el-breadcrumb-item>
        <el-breadcrumb-item>电销中心</el-breadcrumb-item>
        <el-breadcrumb-item><a >待分配新资源</a></el-breadcrumb-item>
    </el-breadcrumb>
    
    <el-row class="marginB10">
    		<el-button type="text" @click="dialogFormVisible = true">选择列</el-button>
    		<shiro:hasPermission name="aggregation:pendingAllocationManager:allocation">
		        <el-button type="primary" @click="toAllocationClue">分配资源</el-button>
		    </shiro:hasPermission>
    		<shiro:hasPermission name="aggregation:pendingAllocationManager:transfer">
		        <el-button type="success" @click="toTransferClue">转移资源</el-button>
		    </shiro:hasPermission>
    		<shiro:hasPermission name="aggregation:pendingAllocationManager:batch">
		        <el-button type="warning" @click="toBatchClue">批量分发</el-button>
		    </shiro:hasPermission>
    		<shiro:hasPermission name="aggregation:pendingAllocationManager:ceo">
		        <el-button type="danger" @click="toCeoClue">副总分发</el-button>
		    </shiro:hasPermission>
	</el-row>
	<el-form :inline="true" :model="clueSearchForm" class="demo-form-inline" ref="clueSearchForm"> 
	    <el-row class="marginB10 greybg padding20" style="padding-bottom: 0;">
	     <el-row>
				  <el-form-item class="formItem" prop="phone">
				    <el-input v-model="clueSearchForm.phone" placeholder="客户手机号" class="input-with-select"></el-input>
				  </el-form-item>
				  <el-form-item class="formItem" prop="cusName">
				    <el-input v-model="clueSearchForm.cusName" placeholder="客户姓名" class="input-with-select"></el-input>
				  </el-form-item>
				  <el-form-item class="formItem"  prop="type">
				    <el-select v-model="clueSearchForm.type" clearable placeholder="资源类型" style="width: 100%;">
				      <el-option
					      v-for="item in typeOptions"
					      :key="item.value"
					      :label="item.name"
					      :value="item.value">
					  </el-option>
				    </el-select>
				  </el-form-item>
				  <el-form-item class="formItem"  prop="category">
				    <el-select v-model="clueSearchForm.category" clearable placeholder="资源类别">
				      <el-option
					      v-for="item in categoryOptions"
					      :key="item.value"
					      :label="item.name"
					      :value="item.value">
					  </el-option>
				    </el-select>
				  </el-form-item>
          <el-form-item class="formItem" label="创建时间：">
  					<el-date-picker value-format="yyyy-MM-dd" v-model="clueSearchForm.startTime" type="datetime" placeholder="选择日期"></el-date-picker>
          </el-form-item>
          <el-form-item class="formItem" label="——">
					   <el-date-picker value-format="yyyy-MM-dd" v-model="clueSearchForm.endTime" type="datetime" placeholder="选择日期"></el-date-picker>
          </el-form-item>
				  <el-form-item class="formItem" prop="messagePoint">
				    <el-input v-model="clueSearchForm.messagePoint" placeholder="留言重点" class="input-with-select"></el-input>
				  </el-form-item>
				  <el-form-item class="formItem" prop="searchWord">
				    <el-input v-model="clueSearchForm.searchWord" placeholder="搜索词" class="input-with-select"></el-input>
				  </el-form-item>
				  <el-form-item class="formItem" prop="address">
				    <el-input v-model="clueSearchForm.address" placeholder="地址" class="input-with-select"></el-input>
				  </el-form-item>
				    <el-button type="primary" @click="searchTable()">搜索</el-button>
				
	        </el-row>
	    </el-row>
  	</el-form>
    <el-row>
        <el-table  ref="multipleTable" tooltip-effect="dark" border @selection-change="handleSelectionChange"
            style="width: 100%"  :data="dataTable" >
            <el-table-column align="center" type="selection" label="全选" width="50"></el-table-column>
            <el-table-column align="center" :key="index" :prop="item.fieldCode" :label="item.displayName" :width="item.width"
	         v-for="(item,key,index) in tableColums" >
	        </el-table-column>
        </el-table>
        <table-pagination :pager="pager" @change="searchTable"></table-pagination>
    </el-row>
      <!-- dialog -->
      <el-dialog  title="分配资源"  :visible.sync="allocationVisible"  width="30%">
        <template>
            <el-form :model="allocationForm" ref="allocationForm" :rules="allocationFormRules">
                <el-form-item label="电销顾问"    :label-width="formLabelWidth"  prop="saleId">
                    <el-select v-model="allocationForm.saleId" placeholder="组内电销员工" style="width: 80%">
                        <el-option v-for="item in saleOptions" 
                        			:key="item.id" 
                        			:label="item.name" 
                        			:value="item.id">
                        </el-option>
                    </el-select>
                </el-form-item>
            </el-form>
            <div slot="footer" class="dialog-footer">
                <el-button type="primary" @click="allocationClue('allocationForm')">提 交</el-button>
                <el-button  @click="allocationVisible = false">取 消</el-button>
            </div>
        </template>
    </el-dialog>
    <!-- dialog -->
      <!-- dialog -->
      <el-dialog  title="转移资源"  :visible.sync="transferVisible"  width="30%">
        <template>
            <el-form :model="transferForm" ref="transferForm" :rules="transferFormRules">
                <el-form-item label="电销总监"    :label-width="formLabelWidth"  prop="id">
                    <el-select v-model="transferForm.id" placeholder="同事业部的组名（总监姓名）" style="width: 80%">
                        <el-option v-for="item in saleGroupOptions" 
                        			:key="item.id" 
                        			:label="item.name" 
                        			:value="item.id">
                        </el-option>
                    </el-select>
                </el-form-item>
            </el-form>
            <div slot="footer" class="dialog-footer">
                <el-button type="primary" @click="transferClue('transferForm')">提 交</el-button>
                <el-button  @click="transferVisible = false">取 消</el-button>
            </div>
        </template>
    </el-dialog>
    <!-- dialog -->
      <!-- dialog -->
      <el-dialog  title="信息流批量分发"  :visible.sync="batchVisible"  width="30%">
        <template>
            <el-form :model="batchForm" ref="batchForm" :rules="batchFormRules">
                <el-form-item label="信息流分配规则"    :label-width="formLabelWidth"  prop="ruleId">
                    <el-select v-model="batchForm.ruleId" style="width: 80%">
                        <el-option v-for="item in ruleOptions" 
                        			:key="item.id" 
                        			:label="item.assignName" 
                        			:value="item.id">
                        </el-option>
                    </el-select>
                </el-form-item>
            </el-form>
            <div slot="footer" class="dialog-footer">
                <el-button type="primary" @click="batchClue('batchForm')">提 交</el-button>
                <el-button  @click="batchVisible = false">取 消</el-button>
            </div>
        </template>
    </el-dialog>
    <!-- dialog -->
      <!-- dialog -->
      <el-dialog  title="副总分发"  :visible.sync="ceoVisible"  width="30%">
        <template>
            <el-form :model="ceoForm" ref="ceoForm" :rules="ceoFormRules">
                <el-form-item label="电销总监"    :label-width="formLabelWidth"  prop="id">
                    <el-select v-model="ceoForm.id" placeholder="同事业部的组名（总监姓名）" @change="getSaleList" style="width: 80%">
                        <el-option v-for="item in orgOptions" 
                        			:key="item.id" 
                        			:label="item.name" 
                        			:value="item.id">
                        </el-option>
                    </el-select>
                </el-form-item>
                <el-form-item label="电销员工"    :label-width="formLabelWidth"  prop="teleSaleId">
                    <el-select v-model="ceoForm.teleSaleId"  style="width: 80%">
                        <el-option v-for="item in teleSaleOptions" 
                        			:key="item.id" 
                        			:label="item.name" 
                        			:value="item.id">
                        </el-option>
                    </el-select>
                </el-form-item>
            </el-form>
            <div slot="footer" class="dialog-footer">
                <el-button type="primary" @click="ceoClue('ceoForm')">提 交</el-button>
                <el-button  @click="ceoVisible = false">取 消</el-button>
            </div>
        </template>
    </el-dialog>
    <!-- dialog -->
    <el-dialog title="自定义列" :visible.sync="dialogFormVisible">
	  <el-form :model="form">
	    
		  <el-form-item label="列名" prop="type">
		    <el-checkbox-group v-model="form.type">
		      <el-checkbox :label="item.sortNum+'_'+item.fieldCode+'_'+item.displayName+'_'+item.id"  name="type" :key="item.fieldCode"  v-for="(item,index) in  allTableColums ">
		          {{item.displayName}}
		      </el-checkbox>
		  
		     </el-checkbox-group>
		  </el-form-item>
	    
	  </el-form>
	  
	  <div slot="footer" class="dialog-footer">
	    <el-button @click="dialogFormVisible = false">取 消</el-button>
	    <el-button type="primary" @click="confirmColumn">确 定</el-button>
	  </div>
	</el-dialog>
</div>
<!-- import common js-->
<div th:include="_footer_include :: #jsLib"></div>
</body>
<script th:inline="javascript">
var orgList=[[${orgList}]];//电销组
var saleList=[[${saleList}]];//电销创业顾问
var saleGroupList=[[${saleGroupList}]];//同事业部下电销组
var ruleList=[[${ruleList}]];//规则
var clueCategoryList=[[${clueCategoryList}]];//资源类别
var clueTypeList=[[${clueTypeList}]];//资源类型
var fieldList=[[${fieldList}]];//自定义字段
var userFieldList=[[${userFieldList}]];//用户自定义字段
var clueVM = new Vue({
        el: '#clueManage',
        data: {
        		clueSearchForm: {
	        		phone: '',
	        		cusName: '',
	        		category: '',
	        		type: '',
	        		startTime: '',
	        		endTime: '',
	        		messagePoint: '',
	        		searchWord: '',
	        		address: ''
	            },
	            allocationForm: {
	            	saleId:''
                },
                transferForm: {
                	id:''
                },
                batchForm: {
                	ruleId:''
                },
                ceoForm: {
                	id:'',
                	teleSaleId:''
                },
                allocationFormRules: {
                	saleId: [
                        { required: true, message: '请选择电销顾问', trigger: 'blur' }
                    ]
                  },
                transferFormRules: {
                	id: [
                        { required: true, message: '请选择电销总监', trigger: 'blur' }
                    ]
                  },
                batchFormRules: {
                	ruleId: [
                        { required: true, message: '请选择分配规则', trigger: 'blur' }
                    ]
                  },
                ceoFormRules: {
                	id: [
                        { required: true, message: '请选择电销总监', trigger: 'blur' }
                    ],
                    teleSaleId: [
                        { required: true, message: '请选择电销员工', trigger: 'blur' }
                    ]
                  },
	            dataTable:[],
	            loading: true,
	             allTableColums:[],
	             tableColums:[],
	             dialogFormVisible: false,
	             form: {
	               type: [],
	             },
	            orgOptions:orgList,
	            saleOptions:saleList,
	            ruleOptions:ruleList,
	            saleGroupOptions:saleGroupList,
	            categoryOptions:clueCategoryList,
	            typeOptions:clueTypeList,
	            teleSaleOptions:[],
	            allocationVisible: false,
	            transferVisible: false,
	            batchVisible: false,
	            ceoVisible: false,
	            pager:{
	                total: 0,
	                currentPage: 1,
	                pageSize: 20,
	            },
	            multipleSelection:[],
                formLabelWidth: '150px',
                formLabelWidth1: '120px',
                
        },
        methods: {
        	searchTable() {
                var param ={};
                param.pageSize = this.pager.pageSize;
                param.pageNum = this.pager.currentPage;
                param.startTime = this.clueSearchForm.startTime;
                param.endTime = this.clueSearchForm.endTime;
                param.messagePoint = this.clueSearchForm.messagePoint;
                param.searchWord = this.clueSearchForm.searchWord;
                param.address = this.clueSearchForm.address;
                param.phone = this.clueSearchForm.phone;
                param.cusName = this.clueSearchForm.cusName;
                param.category = this.clueSearchForm.category;
                param.type = this.clueSearchForm.type;
                console.info(param);
                axios.post('/clue/pendingAllocation/list', param)
                .then(function (response) {
                      var result =  response.data;
                      console.info(result);
                      var table=result.data;
                      var data= table.data;
                      for(var i=0;i<data.length;i++){
                    	  data[i].category=clueVM.transformCategory(data[i].category);
                    	  data[i].type=clueVM.transformType(data[i].type);
                    	  data[i].createTime=clueVM.dateFormat(data[i].createTime);
                    	  data[i].messageTime=clueVM.dateFormat(data[i].messageTime);
                      }
                      clueVM.dataTable= data;
                      clueVM.pager.total =  table.total;
                      clueVM.pager.currentPage = table.currentPage;
                })
                .catch(function (error) {
                     console.log(error);
                });
                
              },
              //选择行
              handleSelectionChange(val) {
                  this.multipleSelection = val;
              },
              handleSizeChange(val) {
                  //下拉框  每页 10,20条切换 调用
                     console.log(`每页 ${val} 条`);
                  this.pageSize = val;
                  this.initTableData(1);
               },
               handleCurrentChange(val) {
                   //点击 页码
                 console.log(`当前页: ${val}`);
                 this.initTableData(val);
               },
               //类别转换方法
               transformCategory(cellValue) {
             	  var text="";
             	  if(clueCategoryList){
 	                  for(var i=0;i<clueCategoryList.length;i++){
 	                		if(cellValue==clueCategoryList[i].value){
 	                			text=clueCategoryList[i].name;
 	                		}
 	                	}
             	  }
                   return text;
               },
               //类行转换方法
               transformType(cellValue) {
             	  var text="";
             	  if(clueTypeList){
 	                  for(var i=0;i<clueTypeList.length;i++){
 	                		if(cellValue==clueTypeList[i].value){
 	                			text=clueTypeList[i].name;
 	                		}
 	                	}
             	  }
                   return text;
               },
               //日期数据格式化方法
               dateFormat( cellValue) {
                 if (cellValue == undefined) {
                    return "";
                 }
                 return moment(cellValue).format("YYYY-MM-DD HH:mm");
               },
               //打开分配资源
               toAllocationClue() {
           	       var rows = this.multipleSelection;
            	   if(rows.length==0){
                       this.$message({
                          message: '请选择数据进行分配',
                          type: 'warning'
                        });
                       return;
                   }
                   this.allocationVisible = true;
               },
               allocationClue(formName){//分配资源
            	   this.$refs[formName].validate((valid) => {
           	          if (valid) {
           	        	 var rows = this.multipleSelection;
                         var rowIds = [];
                         for(var i=0;i<rows.length;i++){
                      	   var curRow = rows[i];
                             rowIds.push(curRow.id);
                         }
                      	  //分配
                      	  var param  = {};
                      	  param.idList=rowIds;
                      	  param.teleSaleId=this.allocationForm.saleId;
                          axios.post('/clue/pendingAllocation/allocationClue',param)
                          .then(function (response) {
                              var data =  response.data;
                              if(data.code=='0'){
                              	clueVM.$message({message:'分配成功',type:'success',duration:1000,onClose:function(){
                              		clueVM.allocationVisible = false;
                              		clueVM.searchTable();
                          	    }});
                              }else{
                              	clueVM.$message({
                                      message: "接口调用失败",
                                      type: 'error'
                                    }); 
                              }
                          })
                          .catch(function (error) {
                            console.log(error);
                          })
                          .then(function () {
                          	
                          });
           	          } else {
           	        	console.log('数据未通过校验！');
           	            return false;
           	          }
           	        });
           	     
                 },// method end
               //打开转移资源
               toTransferClue() {
           	       var rows = this.multipleSelection;
            	   if(rows.length==0){
                       this.$message({
                          message: '请选择数据进行转移',
                          type: 'warning'
                        });
                       return;
                   }
                   this.transferVisible = true;
               },
               transferClue(formName){//转移资源
            	   this.$refs[formName].validate((valid) => {
           	          if (valid) {
           	        	 var rows = this.multipleSelection;
                         var rowIds = [];
                         for(var i=0;i<rows.length;i++){
                      	   var curRow = rows[i];
                             rowIds.push(curRow.id);
                         }
                      	  //转移
                      	  var param  = {};
                      	  param.idList=rowIds;
                      	  var id=this.transferForm.id;
                      	  var idArray=id.split(",");
                      	  param.teleGroupId=idArray[0];
                      	  param.teleDirectorId=idArray[1];
                          axios.post('/clue/pendingAllocation/transferClue',param)
                          .then(function (response) {
                              var data =  response.data;
                              if(data.code=='0'){
                              	clueVM.$message({message:'转移成功',type:'success',duration:1000,onClose:function(){
                              		clueVM.transferVisible = false;
                              		clueVM.searchTable();
                          	    }});
                              }else{
                              	clueVM.$message({
                                      message: "接口调用失败",
                                      type: 'error'
                                    }); 
                              }
                          })
                          .catch(function (error) {
                            console.log(error);
                          })
                          .then(function () {
                          	
                          });
           	          } else {
           	        	console.log('数据未通过校验！');
           	            return false;
           	          }
           	        });
           	     
                 },// method end
               //打开批量分发
               toBatchClue() {
           	       var rows = this.multipleSelection;
            	   if(rows.length==0){
                       this.$message({
                          message: '请选择数据进行分发',
                          type: 'warning'
                        });
                       return;
                   }
                   this.batchVisible = true;
               },
               batchClue(formName){//批量分发
            	   this.$refs[formName].validate((valid) => {
           	          if (valid) {
           	        	 var rows = this.multipleSelection;
                         var rowIds = [];
                         for(var i=0;i<rows.length;i++){
                      	   var curRow = rows[i];
                             rowIds.push(curRow.id);
                         }
                      	  //转移
                      	  var param  = {};
                      	  param.idList=rowIds;
                      	  param.assignId=this.batchForm.ruleId;
                          axios.post('/clue/pendingAllocation/batchClue',param)
                          .then(function (response) {
                              var data =  response.data;
                              if(data.code=='0'){
                              	clueVM.$message({message:'批量分发成功',type:'success',duration:1000,onClose:function(){
                              		clueVM.batchVisible = false;
                              		clueVM.searchTable();
                          	    }});
                              }else{
                              	clueVM.$message({
                                      message: "接口调用失败",
                                      type: 'error'
                                    }); 
                              }
                          })
                          .catch(function (error) {
                            console.log(error);
                          })
                          .then(function () {
                          	
                          });
           	          } else {
           	        	console.log('数据未通过校验！');
           	            return false;
           	          }
           	        });
           	     
                 },// method end
               //打开副总分发
               toCeoClue() {
           	       var rows = this.multipleSelection;
            	   if(rows.length==0){
                       this.$message({
                          message: '请选择数据进行分发',
                          type: 'warning'
                        });
                       return;
                   }
                   this.ceoVisible = true;
               },
               ceoClue(formName){//副总分发
            	   this.$refs[formName].validate((valid) => {
           	          if (valid) {
           	        	var rows = this.multipleSelection;
                        var rowIds = [];
                        for(var i=0;i<rows.length;i++){
                     	   var curRow = rows[i];
                            rowIds.push(curRow.id);
                        }
                     	  var param  = {};
                     	  param.idList=rowIds;
                     	  var id=this.ceoForm.id;
                   	  var idArray=id.split(",");
                   	  param.teleGroupId=idArray[0];
                   	  param.teleDirectorId=idArray[1];
                     	  param.teleSaleId=this.ceoForm.teleSaleId;
                         axios.post('/clue/pendingAllocation/ceoClue',param)
                         .then(function (response) {
                             var data =  response.data;
                             if(data.code=='0'){
                             	clueVM.$message({message:'副总分发成功',type:'success',duration:1000,onClose:function(){
                             		clueVM.ceoVisible = false;
                             		clueVM.searchTable();
                         	    }});
                             }else{
                             	clueVM.$message({
                                     message: "接口调用失败",
                                     type: 'error'
                                   }); 
                             }
                         })
                         .catch(function (error) {
                           console.log(error);
                         })
                         .then(function () {
                         	
                         });
           	          } else {
           	        	console.log('数据未通过校验！');
           	            return false;
           	          }
           	        });
           	      
                 },// method end
                 
              //根据电销组查询电销总监
              getSaleList() {
            	  var param ={};
                  var id = this.ceoForm.id;
            	  var idArray=id.split(",");
                  param.orgId = idArray[0];
                  console.info(param);
                  axios.post('/clue/pendingAllocation/getSaleList', param)
                  .then(function (response) {
                        var result =  response.data;
                        console.info(result);
                        var table=result.data;
                        clueVM.teleSaleOptions= table;
                  })
                  .catch(function (error) {
                       console.log(error);
                  });
              },
              confirmColumn(){
                	this.dialogFormVisible = false;
                	//处理用户选择的列
                	console.info(this.form.type);
                	var customerShowColun = [];
                	var customerColumn = this.form.type;
                	customerColumn.sort(this.sortNumber);//对选择的列排序
                	var idList=[];
                	for(var i=0;i<customerColumn.length;i++){
                		var curItem = customerColumn[i];
                		var itemArr = curItem.split("_");
                		var obj = {};
                		obj.fieldCode=itemArr[1];
                		obj.displayName=itemArr[2];
                		customerShowColun.push(obj);
                		idList.push(itemArr[3])
                	}
                	this.tableColums = customerShowColun;
                	var param ={};
                  param.fieldIdList = idList;
                  param.menuCode = "aggregation:pendingAllocationManager";
                  console.info(param);
                  if(idList.length!=0){
	                  axios.post('/customfield/customField/saveUserField', param)
	                  .then(function (response) {
	                  	
	                  })
	                  .catch(function (error) {
	                       console.log(error);
	                  });
                  }
                },
                initColumn(){
                	//初始化table 列 和 用户自定义列
                	this.allTableColums = fieldList;
                	if(userFieldList.length!=0){
                		var type=[];
                    	for(var i=0;i<userFieldList.length;i++){
                    		type.push(userFieldList[i].sortNum+'_'+userFieldList[i].fieldCode+'_'+userFieldList[i].displayName+'_'+userFieldList[i].fieldId)
	                   	}
	  	              	this.form.type = type;
	  	              	this.confirmColumn();
                	}else{
  	              		this.tableColums = fieldList;
                	}
                	
                },
                sortNumber(a,b) {
                    //对数组中元素，按照数字 从小到大 排序
                    return a.split("_")[0] - b.split("_")[0];
                   }
        },
        created(){
            console.info("create method");
            this.initColumn();
            this.searchTable();
           
        },
        mounted(){
           console.info("mounted method");
        }
    })
    
</script>
</html>