<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  xmlns:th="http://www.thymeleaf.org" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<head th:replace="_header_include::frag(~{::title},~{},~{})">
    <title>后台管理系统</title>
    <style>
        button a{color:#fff!important;}
    </style>
</head>
<body>
<div id="clueManage" class="clueManage mainPadding">  
    <el-breadcrumb separator="/" class="elBreadcrumb marginB20">
        <el-breadcrumb-item>Home</el-breadcrumb-item>
        <el-breadcrumb-item>电销中心</el-breadcrumb-item>
        <el-breadcrumb-item><a >待分配新资源</a></el-breadcrumb-item>
    </el-breadcrumb>
    
    <el-row class="marginB10">
    		<shiro:hasPermission name="aggregation:pendingAllocationManager:allocation">
		        <el-button type="primary" @click="toUpdateClue">分配资源</el-button>
		    </shiro:hasPermission>
    		<shiro:hasPermission name="aggregation:pendingAllocationManager:transfer">
		        <el-button type="primary" >转移资源</el-button>
		    </shiro:hasPermission>
    		<shiro:hasPermission name="aggregation:pendingAllocationManager:batch">
		        <el-button type="primary" >批量分发</el-button>
		    </shiro:hasPermission>
    		<shiro:hasPermission name="aggregation:pendingAllocationManager:ceo">
		        <el-button type="primary" @click="deleteClue">副总分发</el-button>
		    </shiro:hasPermission>
	</el-row>
	<el-form :inline="true" :model="clueSearchForm" class="demo-form-inline" ref="clueSearchForm"> 
	    <el-row class="marginB10 greybg padding20" style="padding-bottom: 0;">
	        <el-row :gutter="20">
	         	<el-col :span="4">
				  <el-form-item class="formItem" prop="phone">
				    <el-input v-model="clueSearchForm.phone" placeholder="客户手机号" class="input-with-select"></el-input>
				  </el-form-item>
				</el-col>
	            <el-col :span="4">
				  <el-form-item class="formItem" prop="cusName">
				    <el-input v-model="clueSearchForm.cusName" placeholder="客户姓名" class="input-with-select"></el-input>
				  </el-form-item>
				</el-col>
				<el-col :span="4">
				  <el-form-item class="formItem"  prop="type" style="width: 100%;">
				    <el-select v-model="clueSearchForm.type" @change="getSaleList" placeholder="资源类型" style="width: 100%;">
				      <el-option
					      v-for="item in typeOptions"
					      :key="item.value"
					      :label="item.name"
					      :value="item.value">
					  </el-option>
				    </el-select>
				  </el-form-item>
				</el-col>
				<el-col :span="4">
				  <el-form-item class="formItem"  prop="category" style="width: 100%;">
				    <el-select v-model="clueSearchForm.category" placeholder="资源类别" style="width: 100%;">
				      <el-option
					      v-for="item in categoryOptions"
					      :key="item.value"
					      :label="item.name"
					      :value="item.value">
					  </el-option>
				    </el-select>
				  </el-form-item>
				</el-col>
	           
	        </el-row>
	        <el-row :gutter="20">
	            <el-col :span="10" >
				  <span class="demonstration">创建时间：</span>
					<el-date-picker value-format="yyyy-MM-dd" v-model="clueSearchForm.startTime" type="date" placeholder="选择日期">
					</el-date-picker>
					<span class="demonstration" style="margin-left: 20px;">--</span>
					<el-date-picker value-format="yyyy-MM-dd" v-model="clueSearchForm.endTime" type="date" placeholder="选择日期">
					</el-date-picker>
				</el-col>
				
	            <el-col :span="4">
				  <el-form-item class="formItem" prop="messagePoint">
				    <el-input v-model="clueSearchForm.messagePoint" placeholder="留言重点" class="input-with-select"></el-input>
				  </el-form-item>
				</el-col>
	            <el-col :span="4">
				  <el-form-item class="formItem" prop="searchWord">
				    <el-input v-model="clueSearchForm.searchWord" placeholder="搜索词" class="input-with-select"></el-input>
				  </el-form-item>
				</el-col>
	            <el-col :span="4">
				  <el-form-item class="formItem" prop="address">
				    <el-input v-model="clueSearchForm.address" placeholder="地址" class="input-with-select"></el-input>
				  </el-form-item>
				</el-col>
				<el-col :span="2">
				    <el-button type="primary" @click="searchTable()">搜索</el-button>
				</el-col>
	        </el-row>
	    </el-row>
  	</el-form>
    <el-row>
        <el-table  ref="multipleTable" tooltip-effect="dark" @selection-change="handleSelectionChange"
            style="width: 100%"  :data="dataTable" >
            留言重点，日期（资源创建日期／导入日期），搜索词，资源项目，资源类别，资源类型，客户姓名，
            手机号，手机号2，手机号3，地址，留言时间（精确到秒），QQ，邮箱，资源专员（创建／导入此资源专员姓名）
            <el-table-column align="center" type="selection" label="全选" width="50"></el-table-column>
            <el-table-column align="center" prop="messagePoint" label="留言重点" ></el-table-column>
            <el-table-column align="center" prop="createTime" label="日期" :formatter="dateFormat"></el-table-column>
            <el-table-column align="center" prop="searchWord" label="搜索词" ></el-table-column>
            <el-table-column align="center" prop="projectName" label="资源项目"></el-table-column>
            <el-table-column align="center" prop="category" label="资源类别" :formatter="transformCategory"></el-table-column>
            <el-table-column align="center" prop="type" label="资源类型" :formatter="transformType"></el-table-column>
            <el-table-column align="center" prop="cusName" label="客户姓名"></el-table-column>
           <el-table-column align="center" prop="phone" label="手机号" ></el-table-column>
           <el-table-column align="center" prop="phone2" label="手机号2" ></el-table-column>
           <el-table-column align="center" prop="phone3" label="手机号3" ></el-table-column>
           <el-table-column align="center" prop="address" label="地址" ></el-table-column>
           <el-table-column align="center" prop="messageTime" label="留言时间" :formatter="dateFormat"></el-table-column>
           <el-table-column align="center" prop="qq" label="QQ" ></el-table-column>
           <el-table-column align="center" prop="email" label="邮箱" ></el-table-column>
           <el-table-column align="center" prop="createUserName" label="资源专员" ></el-table-column>
        </el-table>
        <table-pagination :pager="pager" @change="searchTable"></table-pagination>
    </el-row>
      <!-- dialog -->
    <el-dialog title="编辑邀约来访" :visible.sync="clueFormVisible"  @close="closeAddCustomFieldDialog">
        <el-form :model="clueForm">
            <el-form-item label="地区：" :label-width="formLabelWidth" prop="area">
                <el-select v-model="clueForm.area" placeholder="请选择" style="width: 70%;">
                    <el-option
                        v-for="item in areaOptions"
                        :key="item.value"
                        :label="item.label"
                        :value="item.value">
                    </el-option>
                </el-select>
            </el-form-item>
            <el-form-item label="分公司：" :label-width="formLabelWidth" prop="busCompay">
                <el-select v-model="clueForm.busCompay" placeholder="请选择" style="width: 70%;">
                    <el-option
                        v-for="item in busCompayOptions"
                        :key="item.value"
                        :label="item.label"
                        :value="item.value">
                    </el-option>
                </el-select>
            </el-form-item>
            <el-form-item label="商务总监：" :label-width="formLabelWidth" prop="busDirectorId">
                <el-select v-model="clueForm.busDirectorId" placeholder="请选择" style="width: 70%;">
                    <el-option
                        v-for="item in busDirectorOptions"
                        :key="item.id"
                        :label="item.name"
                        :value="item.id">
                    </el-option>
                </el-select>
            </el-form-item>
            <el-form-item label="品尝项目：" :label-width="formLabelWidth" prop="tasteProjectId">
                <el-select v-model="clueForm.tasteProjectId" multiple placeholder="请选择" style="width: 70%;">
                    <el-option
                        v-for="item in projectOptions"
                        :key="item.id"
                        :label="item.projectName"
                        :value="item.id">
                    </el-option>
                </el-select>
            </el-form-item>
            <el-form-item label="预约时间：" :label-width="formLabelWidth" prop="reserveTime">
                <el-date-picker
                    style="width: 70%;"
                    v-model="clueForm.reserveTime"
                    type="datetime"
                    placeholder="选择日期时间">
                </el-date-picker>
            </el-form-item>
            <el-form-item label="备注：" :label-width="formLabelWidth" prop="remark">
                <el-input type="textarea" :rows="2" v-model="clueForm.remark" style="width: 70%;"></el-input>
            </el-form-item>
        </el-form>
        <div slot="footer" class="dialog-footer">
            <el-button type="primary" @click="saveClue('clueForm')">确 定</el-button>
            <el-button @click="clueFormVisible = false">取 消</el-button>
        </div>
    </el-dialog>
    <!-- dialog -->
    <!-- 跟进记录 -->
    <el-dialog title="跟进记录" :visible.sync="recordDialog">
        <el-table
            ref="singleTable" 
            tooltip-effect="dark"
            style="width: 100%"
            border
            :data="recordTable" 
            >
            <el-table-column align="center" type="index" width="55" label="序号"></el-table-column>
            <el-table-column align="center" prop="callTime" label="拨打时间"></el-table-column>
            <el-table-column align="center" prop="customerStatusName" label="客户状态"></el-table-column>
            <el-table-column align="center" prop="isCall" label="是否接通" :formatter="transformIsCall"></el-table-column>
            <el-table-column align="center" prop="resourceStatus" label="资源有效性" :formatter="transformResource"></el-table-column>
            <el-table-column align="center" prop="invitationStatus" label="是否邀约" :formatter="transformSign"></el-table-column>
            <el-table-column align="center" prop="focusPoint" label="客户关注点"></el-table-column>  
            <el-table-column align="center" prop="visitStatus" label="是否继续回访" :formatter="transformSign"></el-table-column>  
            <el-table-column align="center" prop="nextVisitTime" label="下次回访时间"></el-table-column>  
            <el-table-column align="center" prop="createUserName" label="创建人"></el-table-column>  
        </el-table>
    </el-dialog>
    <!-- 重复手机号资源信息 -->
    <el-dialog title="手机号1233133332重复资源信息" :visible.sync="repeatPhonesDialog">
        <el-table
            ref="singleTable" 
            tooltip-effect="dark"
            style="width: 100%"
            border
            :data="repeatPhonesTable" 
            >
            <el-table-column align="center" type="index" width="55" label="序号"></el-table-column>
            <el-table-column align="center" prop="createDate" label="资源创建时间"></el-table-column>
            <el-table-column align="center" prop="cusPhone" label="联系方式"></el-table-column>
            <el-table-column align="center" prop="teleDirectorName" label="电销总监"></el-table-column>
            <el-table-column align="center" prop="teleSaleName" label="创业顾问"></el-table-column>
            <el-table-column align="center" prop="teleGorupName" label="电销组"></el-table-column>
            <el-table-column align="center" prop="createUserRoleName" label="资源创建人角色"></el-table-column>  
            <el-table-column align="center" prop="createUserName" label="资源创建人"></el-table-column> 
        </el-table>
    </el-dialog>
</div>
<!-- import common js-->
<div th:include="_footer_include :: #jsLib"></div>
</body>
<script th:inline="javascript">
var orgList=[[${orgList}]];//电销组
var saleList=[[${saleList}]];//电销创业顾问
var saleGroupList=[[${saleGroupList}]];//同事业部下电销组
var ruleList=[[${ruleList}]];//规则
var clueCategoryList=[[${clueCategoryList}]];//资源类别
var clueTypeList=[[${clueTypeList}]];//资源类型
var clueVM = new Vue({
        el: '#clueManage',
        data: {
        		clueSearchForm: {
	        		startTime: '',
	        		endTime: '',
	        		teleGorupId: '',
	        		teleSaleId: '',
	        		projectId: '',
	        		cusName: ''
	            },
	            clueForm: {
	            	id:'',
	            	clueName:'',
	            	groupName:'',
                	clueAddress:'',
                    phoneNumber:'',
                    website:''
                },
	            dataTable:[],
	            recordTable:[],
	            repeatPhonesTable:[],
	            teleGorupOptions:orgList,
	            teleSaleOptions:userList,
	            projectOptions:projectList,
	            areaOptions:areaList,
	            busCompayOptions:companyList,
	            busDirectorOptions:busDirectorList,
	            clueFormVisible: false,
	            recordDialog:false,
                repeatPhonesDialog:false,
	            pager:{
	                total: 0,
	                currentPage: 1,
	                pageSize: 20,
	            },
	            multipleSelection:[],
                formLabelWidth: '150px',
                formLabelWidth1: '120px',
                rules: {
                	clueName: [
                      { required: true, message: '公司名称不能为空', trigger: 'blur' }
                    ],
                    groupName: [
                      { required: true, message: '集团名称不能为空', trigger: 'blur' }
                    ],
                    clueAddress: [
                      { required: true, message: '公司地址不能为空', trigger: 'blur' }
                    ]
                  },
        },
        methods: {
        	searchTable() {
                var param ={};
                
                param.pageSize = this.pager.pageSize;
                param.pageNum = this.pager.currentPage;
                param.startTime = this.clueSearchForm.startTime;
                param.endTime = this.clueSearchForm.endTime;
                param.teleGorupId = this.clueSearchForm.teleGorupId;
                param.teleSaleId = this.clueSearchForm.teleSaleId;
                param.tasteProjectId = this.clueSearchForm.projectId;
                param.cusName = this.clueSearchForm.cusName;
                console.info(param);
                axios.post('/clue/clue/list', param)
                .then(function (response) {
                      var result =  response.data;
                      console.info(result);
                      var table=result.data;
                      clueVM.dataTable= table.data;
                      clueVM.pager.total =  table.total;
                      clueVM.pager.currentPage = table.currentPage;
                })
                .catch(function (error) {
                     console.log(error);
                });
                
              },
              //选择行
              handleSelectionChange(val) {
                  this.multipleSelection = val;
              },
              //跳转修改邀约来访页
              toUpdateClue() {
            	  var rows = this.multipleSelection;
                  if(rows.length!=1){
                      this.$message({
                         message: '请选择一条数据进行修改',
                         type: 'warning'
                       });
                      return;
                  }
                  var param={id:rows[0].id};
                  //根据id获取数据
                  axios.post('/clue/clue/getClue',param)
                  .then(function (response) {
                      var data =  response.data;
                      if(data.code=='0'){
                    	  clueVM.clueForm= data.data;
                      }else{
                      	console.error(data);
                      }
                  })
                  .catch(function (error) {
                    console.log(error);
                  })
                  .then(function () {
                  }); 
                  this.clueFormVisible = true;
              	
              },
              handleSizeChange(val) {
                  //下拉框  每页 10,20条切换 调用
                     console.log(`每页 ${val} 条`);
                  this.pageSize = val;
                  this.initTableData(1);
               },
               handleCurrentChange(val) {
                   //点击 页码
                 console.log(`当前页: ${val}`);
                 this.initTableData(val);
               },
               cancelForm(formName) {
            	   if (this.$refs[formName]!==undefined) {
               		this.$refs[formName].resetFields();
               		}
               	   this.clueFormVisible = false;
               },
               closeAddCustomFieldDialog(){//关闭添加自定义字段dialog
	               	if (this.$refs['customMenuForm']!==undefined) {
	               		this.$refs['customMenuForm'].resetFields();
	               	}
               },
               //类别转换方法
               transClassification(row, column, cellValue, index) {
             	  var text="";
             	  if(classificationList){
 	                  for(var i=0;i<classificationList.length;i++){
 	                		if(cellValue==classificationList[i].value){
 	                			text=classificationList[i].name;
 	                		}
 	                	}
             	  }
                   return text;
               },
               //日期数据格式化方法
               dateFormat(row, column, cellValue, index) {
                 if (cellValue == undefined) {
                    return "";
                 }
                 return moment(cellValue).format("YYYY-MM-DD HH:mm:ss");
               },
               saveClue(formName){//保存自定义字段
                  this.$refs[formName].validate((valid) => {
                      if (valid) {
                         var param=clueVM.clueForm;
                         var url="/clue/clue/updateClue";
                        axios.post(url, param)
                        .then(function (response) {
                            var resData = response.data;
                            if(resData.code=='0'){
                            	clueVM.cancelForm(formName);
                            	clueVM.$message({message:'操作成功',type:'success',duration:1000,onClose:function(){
                            		clueVM.searchTable();
                          	    }});
                            }else{
                            	clueVM.$message('操作失败');
                                console.error(resData);
                            }
                        })
                        .catch(function (error) {
                             console.log(error);
                        });
                         
                      } else {
                        return false;
                      }
                    });
                 },// method end
                 deleteClue() {
              	   var rows = this.multipleSelection;
                     if(rows.length==0){
                         this.$message({
                            message: '请选择一条数据进行刪除',
                            type: 'warning'
                          });
                         return;
                     }
                     var rowIds = [];
                     for(var i=0;i<rows.length;i++){
                  	   var curRow = rows[i];
                         rowIds.push(curRow.id);
                     }
                  this.$confirm('确定要删除选中的邀约来访吗？', '提示', {
                      confirmButtonText: '确定',
                      cancelButtonText: '取消',
                      type: 'warning'
                  }).then(() => {
                  	  //删除
                  	var param  = {idList:rowIds};
                      axios.post('/clue/clue/deleteClue',param)
                      .then(function (response) {
                          var data =  response.data;
                          if(data.code=='0'){
                          	clueVM.$message({message:'删除成功',type:'success',duration:1000,onClose:function(){
                          		clueVM.searchTable();
                      	    }});
                          }else{
                          	clueVM.$message({
                                  message: "接口调用失败",
                                  type: 'error'
                                }); 
                          }
                      })
                      .catch(function (error) {
                        console.log(error);
                      })
                      .then(function () {
                      	
                      });
                  }).catch(() => {
                         
                  });
              },//end
              //根据电销组查询电销总监
              getSaleList() {
            	  var param ={};
                  param.orgId = this.clueSearchForm.teleGorupId;
                  console.info(param);
                  axios.post('/clue/clue/getSaleList', param)
                  .then(function (response) {
                        var result =  response.data;
                        console.info(result);
                        var table=result.data;
                        clueVM.teleSaleOptions= table.data;
                  })
                  .catch(function (error) {
                       console.log(error);
                  });
              },
              //查看跟进记录
              recordClick(row) {
            	  var param ={};
                  param.clueId = row.clueId;
                  console.info(param);
                  axios.post('/aggregation/tracking/queryList', param)
                  .then(function (response) {
                        var result =  response.data;
                        console.info(result);
                        var table=result.data;
                        clueVM.recordTable= table.data;
                        clueVM.recordDialog=true;
                  })
                  .catch(function (error) {
                       console.log(error);
                  });
              },
              //查看重复手机号资源
              repeatPhonesClick(row) {
                  var param ={};
                  param.id = row.clueId;
                  param.cusPhone = row.cusPhone;
                  console.info(param);
                  axios.post('/clue/clue/repeatPhonelist', param)
                  .then(function (response) {
                        var result =  response.data;
                        console.info(result);
                        var table=result.data;
                        clueVM.repeatPhonesTable= table.data;
                        clueVM.repeatPhonesDialog=true;
                  })
                  .catch(function (error) {
                       console.log(error);
                  });
              },
        },
        created(){
            console.info("create method");
            this.searchTable();
           
        },
        mounted(){
           console.info("mounted method");
        }
    })
    
</script>
</html>