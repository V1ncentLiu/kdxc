<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  xmlns:th="http://www.thymeleaf.org">
<head th:replace="_header_include::frag(~{::title},~{},~{})">
    <title>后台管理系统</title>
    <style>
        .userManage .leftBox{/*width: 200px;*/height: auto;border:1px solid #ebeef5;min-height: 480px;}
        .userManage .leftTitle{background:#ebeef5;text-indent: 20px;height: 40px;line-height: 40px;}
        .userManage .leftTree{padding:10px;}
        .userManage .rightTitle{background:#ebeef5;text-indent: 20px;height: 40px;line-height: 40px;}
    </style>
</head>
<body>
<div id="userManage" class="userManage mainPadding" style="display: none;">  
    <el-breadcrumb separator="/" class="elBreadcrumb marginB20">
        <el-breadcrumb-item>Home</el-breadcrumb-item>
        <el-breadcrumb-item>系统管理</el-breadcrumb-item>
        <el-breadcrumb-item>用户管理</el-breadcrumb-item>
    </el-breadcrumb>
	<el-row :gutter="20">
 		编辑用户
 	</el-row>
    <el-row :gutter="20">
        <el-form :model="form" :rules="rules" ref="form">
            <el-row>
                <el-col :span="8">
                    <el-form-item label="姓名：" :label-width="formLabelWidth1" prop="name">
                        <el-input v-model="form.name" maxlength="30" autocomplete="off"></el-input>
                    </el-form-item>
                </el-col>
                <el-col :span="8" :offset="4">
                    <el-form-item label="登录用户名：" :label-width="formLabelWidth1" prop="username">
                        <el-input v-model="form.username" maxlength="30" autocomplete="off" :disabled="true"></el-input>
                    </el-form-item>
                </el-col>
            </el-row>
            <el-row>
                <el-col :span="8">
                    <el-form-item label="手机号：" :label-width="formLabelWidth1" prop="phone">
                        <el-input v-model="form.phone" maxlength="11" autocomplete="off"></el-input>
                    </el-form-item>
                </el-col>
                <el-col :span="8" :offset="4">
                    <el-form-item label="所属角色：" :label-width="formLabelWidth1" prop="roleName">
                        <!-- <el-row>
                            <el-col :span="14"> -->
                                <el-input v-model="form.roleName" autocomplete="off" style="width: 65%"></el-input>                                
                            <!-- </el-col>
                            <el-col :span="10"> -->
                                <el-button style="width: 35%" class="pull-right" type="primary" @click="dialogFormChooseRole = true">选择角色</el-button>
                            <!-- </el-col>    
                        </el-row> -->
                    </el-form-item>
                </el-col>
            </el-row>
            <el-row>
                <el-col :span="8">
                    <el-form-item label="所属组织：" :label-width="formLabelWidth1" prop="orgName">
                        <el-row>
                            <!-- <el-col :span="14"> -->
                                <el-input v-model="form.orgName" autocomplete="off" style="width: 65%;"></el-input>                                
                            <!-- </el-col>
                            <el-col :span="10"> -->
                                <el-button style="width: 35%;" class="pull-right" type="primary" @click="dialogFormChooseOrg = true">选择组织</el-button>
                            <!-- </el-col> -->    
                        </el-row>
                    </el-form-item>
                </el-col>
                <el-col :span="8" :offset="4">
                    <el-form-item label="用户状态：" :label-width="formLabelWidth1" prop="status">
                        <el-select v-model="form.status" placeholder="请选择" style="width: 100%;">
                            <el-option
                                v-for="item in statusOptions"
                                :key="item.value"
                                :label="item.label"
                                :value="item.value">
                            </el-option>
                        </el-select>
                    </el-form-item>
                </el-col>
            </el-row>
            <!--<el-row v-show="isShow">-->
                <!--<el-col :span="6">-->
                    <!--<el-form-item  label="用户资源处理：" :label-width="formLabelWidth1">-->
                        <!--<el-radio v-model="statusRadio" label="0">不带资源走</el-radio>-->
                        <!--<el-radio v-model="statusRadio" label="1">带资源走</el-radio>-->
                    <!--</el-form-item>-->
                <!--</el-col>-->
            <!--</el-row>-->
            <el-row style="margin-top: 10px;">
                <el-col :span="8" :offset="9">
                    <el-form-item>
                        <el-button type="primary" @click="onSubmit('form')">提交</el-button>
                        <el-button @click="goBack()">取消</el-button>
                    </el-form-item>
                </el-col>
            </el-row>
        </el-form>
    </el-row>

    <el-dialog title="选择角色" :visible.sync="dialogFormChooseRole"s>
        <el-form :model="form">
            <el-table 
            ref="multipleTable"
            tooltip-effect="dark"
            style="width: 100%"
            border
            :data="dataTableRole"
            highlight-current-row
            @current-change="handleCurrentChange"
            >
            <el-table-column align="center" width="55" label="选择">
                <template scope="scope">
                    <el-radio :label="scope.row.id" v-model="tableRadio"  @change="selectRole(scope.row.id,scope.row.roleName)">&nbsp;</el-radio>
                </template>
            </el-table-column>
            <el-table-column align="center" prop="roleName" label="角色名称"></el-table-column>
            <el-table-column align="center" prop="description" label="角色描述"></el-table-column>
        </el-table>
        </el-form>        
    </el-dialog>
    <el-dialog title="选择组织" :visible.sync="dialogFormChooseOrg" append-to-body>
        <el-form :model="form">
            <el-tree
                :data="dataTree"              
                :default-expanded-keys="expandedKeys"
                ref="tree"
                highlight-current
                @node-click="clickOrgNode"
                class="leftTree">
            </el-tree>
        </el-form>        
    </el-dialog>
</div>
<!-- import common js-->
<div th:include="_footer_include :: #jsLib"></div>
</body>
<script th:inline="javascript">
var orgData=[[${orgData}]];

var expandedKeys =[];//默认展开节点
for(var i=0;i<orgData.length;i++){
	var curNode = orgData[i];
	expandedKeys.push(curNode.id);
	var childs = curNode.children;
	if(childs){
		for(var j=0;j<childs.length;j++){
			var curChildNode = childs[j];
			expandedKeys.push(curChildNode.id);
		}
	}
	
}
var roleList=[[${roleList}]];//当前字段所属的菜单组
var user=[[${user}]];//当前字段所属的菜单组
var updateUserVm= new Vue({
        el: '#userManage',
        data: function() {
            return {
                statusRadio:'0',
                isShow:false,
                tableRadio:user.roleList[0].id,
                dialogFormChooseRole: false,
                dialogFormChooseOrg: false,
                form: {
                	name: user.name,
                    username: user.username,
                    phone: user.phone,
                    roleId: user.roleList[0].id,
                    roleName: user.roleList[0].roleName,
                    orgId: user.orgId,
                    orgName: user.orgName,
                    status: user.status
                },
                rules: {
                	name: [
                      { required: true, message: '姓名不能为空', trigger: 'blur' },
                      {  max: 30, message: '最大30个字符', trigger: 'blur' },
                      { validator:function(rule,value,callback){
                            if(/^[A-Za-z0-9\u4e00-\u9fa5]+$/.test(value) == false){
                               callback(new Error("请输入汉字、字母或数字"));
                            }else{
                               callback();
                            } 
                            callback();                              
                        }, trigger: 'change'}
                    ],
                    username: [
                      { required: true, message: '登录用户名不能为空', trigger: 'blur' },
                      {  max: 30, message: '最大30个字符', trigger: 'blur' }
                    ],
                    phone: [
                      { required: true, message: '手机号不能为空', trigger: 'change' },
                      {  max: 30, message: '最大30个字符', trigger: 'blur' },
                      { validator:function(rule,value,callback){                 
                            if(/^1[34578]\d{9}$/.test(value) == false){
                                callback(new Error("请输入正确格式的手机号"));
                            }else{
                                callback();
                            }                       
                            callback();                      
                        }, trigger: 'change'}
                    ],
                    password: [
                      { required: true, message: '密码不能为空', trigger: 'change' },
                      { min:6 , max: 30, message: '最大30个字符', trigger: 'blur' },
                      { validator:function(rule,value,callback){
                            if(/^[A-Za-z0-9]+$/.test(value) == false){
                                callback(new Error("请输入数字和字母"));
                            }else{
                                callback();
                            } 
                            callback();                              
                        }, trigger: 'change'}
                    ],
                    orgName: [
                      { required: true, message: '组织不能为空', trigger: 'change' }
                    ],
                    status: [
                      { required: true, message: '状态不能为空', trigger: 'change' }
                    ],
                    roleName: [
                      { required: true, message: '角色不能为空', trigger: 'change' }
                    ]
                  },
                formLabelWidth: '250px',
                formLabelWidth1: '120px',
                expandedKeys:expandedKeys,//树形结构  默认展开的
                dataTree: orgData,
                dataTableRole:roleList,
                statusOptions: [{
                    value: 1,
                    label: '启用'
                }, {
                    value: 2,
                    label: '禁用'
                },{
                    value: 3,
                    label: '锁定'
                }]
            }        	  
        },
        methods: {
            //row-click    当某一行被点击时会触发该事件 row, event, column
            showRow(row){
            //赋值给radio
                this.radio = this.dataTableRole.indexOf(row);
            },
            /* urrent-change    当表格的当前行发生变化的时候会触发该事件，如果要高亮当前行，请打开表格的 highlight-current-row 属性    currentRow, oldCurrentRow */
            handleCurrentChange(val,index) {
                this.currentRow = val;
                this.$emit('data',val.pkg);
            },
            getCurrentRow(val){
                console.log(val)
            },
          //选择角色
            selectRole(id,name){
            	updateUserVm.form.roleId=id;
            	updateUserVm.form.roleName=name;
            	updateUserVm.dialogFormChooseRole=false;
            },
            //选择机构
            clickOrgNode(data,node,obj){//点击左侧节点
                	updateUserVm.form.orgId=data.id;
                	updateUserVm.form.orgName=data.label;
                	updateUserVm.dialogFormChooseOrg=false;
                	updateUserVm.isShow=true;
            },
            //返回
            goBack(){//点击左侧节点
            	document.location.href='/user/userManager/initUserList';
            },
            onSubmit(formName) {
            	 this.$refs[formName].validate((valid) => {
          	       if (valid) {
       	             var formData = updateUserVm.form;
       	             var param={};
       	             param.id= user.id;
       	             param.name= formData.name;
       	             param.username= formData.username;
       	             param.password = formData.password;
       	             param.phone = formData.phone;
       	             param.status = formData.status;
       	             param.orgId = formData.orgId;
       	             console.info(param);
       	             var roleList=new Array();
       	          	 roleList.push(formData.roleId);
       	             param.roleList=roleList;
       	            axios.post("/user/userManager/updateUser", param)
       	            .then(function (response) {
       	            	console.info(response);
       	            	var data =response.data;
       	            	if(data.code!="0"){
       	            		updateUserVm.$message('修改失败');
       	            	}else{
       	            		updateUserVm.$message('修改成功');
       	                	document.location.href='/user/userManager/initUserList';
       	            	}
       	            })
       	            .catch(function (error) {
       	                 console.log(error);
       	            });
       	             
          	          } else {
          	        	console.log('数据未通过校验！');
          	            return false;
          	          }
          	        });
            }
        },
        mounted(){
            document.getElementById('userManage').style.display = 'block';
        }
    })
</script>
</html>