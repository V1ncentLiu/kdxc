<!DOCTYPE html>
<html>
<head th:include="_header_include::frag(~{::title},~{::style},~{})">
    <title>资源释放领取规则管理</title>
    <style type="text/css">
        .el-input__inner{height: 32px;line-height:32px;width: 150px;}
        #tableBox{border-collapse:collapse;border:1px solid #eaecf3;width: 100%}
        #tableBox th{background:#ecedf2; border:1px solid #eaecf3;padding: 12px 0;text-align: center;}
        #tableBox td{border:1px solid #eaecf3;padding: 14px 0;text-align: center;}
        #tableBox td .el-form-item{margin-bottom: 2px}
        #tableBox .el-form-item__error{top: 100%;left: -50%;width: 200%;}
        .selectIpt .el-input__inner{width: 200px;}
        /*不显示input的number样式*/
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
        }
        input[type="number"]{
            -moz-appearance: textfield;
        }
        .el-form--inline .el-form-item__label{}
        .el-form-item{margin-bottom: 15px;}
        .ladderListTable .line{line-height: 35px;}
        .leftLine{border-left: 5px solid #5c6be8;line-height: 20px;text-indent: 10px;margin-bottom: 20px;}
    </style>
</head>
<body>
<div id="releaseRule" class="releaseRule mainPadding" style="display: none;"> 
    <el-breadcrumb separator="/" class="elBreadcrumb marginB20">
        <el-breadcrumb-item>Home</el-breadcrumb-item>
        <el-breadcrumb-item>业务设置</el-breadcrumb-item>
        <el-breadcrumb-item>自动匹配模型配置</el-breadcrumb-item>
    </el-breadcrumb> 
    
    <el-row class="mainWhiteBg">
        <el-form :model="form" :rules="rules" ref="form" class="padding20" :inline="true">
            <el-row>
                <el-form-item label="选择业务线：" prop="bussinessLine"> 
                    <el-select v-model="form.bussinessLine" filterable placeholder="">
                        <el-option
                            v-for="item in options"
                            :key="item.value"
                            :label="item.name"
                            :value="item.value">
                        </el-option>
                    </el-select>
                </el-form-item>
                <span style="line-height: 35px;">配置模型</span>
            </el-row>
            <div class="fs14 marginB20 leftLine">餐盟业务线匹配模型：</div>
            <el-row  class="marginB20">
                <el-form-item label="新员工是按照创建账号起" style="margin-bottom: 0" prop="createDay">    
                    <el-input v-model="form.createDay" placeholder="请输入正整数" type="number" min="0"></el-input>
                </el-form-item>
                <el-form-item label="天内为新员工。" style="margin-bottom: 0"></el-form-item>
            </el-row>
            <el-row  class="marginB20">
                <el-form-item label="新员工入职" style="margin-bottom: 0" prop="disDay">    
                    <el-input v-model="form.disDay" placeholder="请输入正整数" type="number" min="0"></el-input>
                </el-form-item>
                <el-form-item label="天后可以分发资源。" style="margin-bottom: 0"></el-form-item>
            </el-row>
            <div class="fs14 marginB20 leftLine">顾问与资源阶段匹配设置：</div>
            <el-table
                ref="multipleTable"
                tooltip-effect="dark"
                style="width: 100%"
                border
                :data="form.ladderList"
                class="ladderListTable"
            >
                <el-table-column align="center" type="index" label="序号" width="55"></el-table-column>
                <el-table-column align="center" prop="ruleName" label="顾问阶梯" width="100">
                    <template slot-scope="scope">
                        {{scope.row.ladder}}阶梯
                    </template>
                </el-table-column>
                <el-table-column align="center" prop="srangeStart" label="分数值范围">
                    <template slot-scope="scope">
                        <el-form-item :prop="'ladderList.' + scope.$index + '.srangeStart'" :rules='rules.srangeStart'>
                            <el-input v-model="scope.row.srangeStart"></el-input>
                        </el-form-item>
                        <span class="line">——</span>
                        <el-form-item :prop="'ladderList.' + scope.$index + '.srangeEnd'" :rules='rules.srangeEnd'>
                            <el-input v-model="scope.row.srangeEnd"></el-input>
                        </el-form-item>
                    </template>
                </el-table-column>
                <el-table-column align="center" prop="limit" label="每日分配上限">
                    <template slot-scope="scope">
                        <el-form-item :prop="'ladderList.' + scope.$index + '.limit'" :rules='rules.limit'>
                            <el-input v-model="scope.row.limit" placeholder="0-100以内整数" maxLength="3" type="number" min="0" max="100"></el-input>
                        </el-form-item>
                        
                    </template>
                </el-table-column>
                <el-table-column align="center" prop="startTime" label="资源阶梯" width="100">
                    <template slot-scope="scope">
                        {{scope.row.ladder}}阶梯
                    </template>
                </el-table-column>
                <el-table-column align="center" prop="startTime" label="分数值范围">
                    <template slot-scope="scope">
                        <el-form-item :prop="'ladderList.' + scope.$index + '.clueSrangeStart'" :rules='rules.clueSrangeStart'>
                            <el-input v-model="scope.row.clueSrangeStart" placeholder="0-100以内整数" maxLength="3" type="number" min="0" max="100"></el-input>
                        </el-form-item>
                        <span class="line">——</span>
                        <el-form-item :prop="'ladderList.' + scope.$index + '.clueSrangeEnd'" :rules='rules.clueSrangeEnd'>
                            <el-input v-model="scope.row.clueSrangeEnd" placeholder="0-100以内整数" maxLength="3" type="number" min="0" max="100"></el-input>
                        </el-form-item>
                    </template>
                </el-table-column>
            </el-table>     
            <div class="padding20 f-tac">     
                <el-button type="primary" @click="submitForm('form')" :disabled="clueRuleSubmitBtnDiabled">提交</el-button>
                <el-button @click="cancel">取 消</el-button>
            </div> 
        </el-form> 
    </el-row>
</div>
</body>
<!-- import Vue before Element -->
<div th:include="_footer_include :: #jsLib"></div>
<script th:inline="javascript">
    var optionsObj = [[${businessLineList}]];
</script>
<script>
    var releaseRuleVM=new Vue({
        el: '#releaseRule',
        data: function() {
            return { 
            	clueRuleSubmitBtnDiabled:false,
                isAddAble:true,
                isShow:false,  
                form: { 
                    bussinessLine:'',
                    createDay:'',
                    disDay:'',
                    ladderList:[{
                        srangeStart:1,
                        srangeEnd:2,
                        clueSrangeStart:3,
                        clueSrangeEnd:4,
                        ladder:1,
                        limit:10
                    },{
                        srangeStart:2,
                        srangeEnd:3,
                        clueSrangeStart:4,
                        clueSrangeEnd:5,
                        ladder:2,
                        limit:10
                    },{
                        srangeStart:3,
                        srangeEnd:4,
                        clueSrangeStart:5,
                        clueSrangeEnd:6,
                        ladder:3,
                        limit:10
                    },{
                        srangeStart:4,
                        srangeEnd:5,
                        clueSrangeStart:6,
                        clueSrangeEnd:7,
                        ladder:4,
                        limit:10
                    },{
                        srangeStart:5,
                        srangeEnd:6,
                        clueSrangeStart:7,
                        clueSrangeEnd:8,
                        ladder:5,
                        limit:10
                    }] 
                },                
                rules:{
                    bussinessLine: [
                        { required: true, message: '请选择业务线', trigger: 'blur' }
                    ],
                    createDay: [
                        { required: true, message: '请输入正整数', trigger: 'blur' }
                    ],
                    disDay: [
                        { required: true, message: '请输入正整数', trigger: 'blur' }
                    ],
                    srangeStart: [
                        { required: true, message: '请输入顾问分数值范围', trigger: 'blur' }
                    ],
                    srangeEnd: [
                        { required: true, message: '请输入顾问分数值范围', trigger: 'blur' }
                    ],
                    limit: [
                        { required: true, message: '请输入每日分配上限', trigger: 'blur' }
                    ],
                    clueSrangeStart: [
                        { required: true, message: '请输入资源分数值范围', trigger: 'blur' }
                    ],
                    clueSrangeEnd: [
                        { required: true, message: '请输入资源分数值范围', trigger: 'blur' }
                    ]
                },
                options: optionsObj,
            }             
        },
        methods: {
            submitForm(form) {
                this.$refs[form].validate((valid) => {
                    if (valid) { 
                        var param = {};
                        var form = this.form;
                         
                        axios.post('/cluerule/clueRule/insertAndUpdateClueRule',param)
                        .then(function (response) {
                            var data =  response.data
                            if(data.code=='0'){
                               var resData = data.data;
                                
                               releaseRuleVM.$message({message:'操作成功',type:'success',duration:2000,onClose:function(){
                            	   //releaseRuleVM.initClueRule();
                                   releaseRuleVM.clueRuleSubmitBtnDiabled=false;
                            	   location.reload();
                            	   
                               }});  ;  
                            }else{
                            	releaseRuleVM.$message({message:data.msg,type:'error'});
                                releaseRuleVM.clueRuleSubmitBtnDiabled=false;
                                // console.error(data);
                            }
                        
                        })
                        .catch(function (error) {
                            releaseRuleVM.clueRuleSubmitBtnDiabled=false;
                            console.log(error);
                        });
                        

                    } else {
                        console.log('error submit!!');
                        this.clueRuleSubmitBtnDiabled=false;
                        return false;
                    }
                });
            },
            number(){
		    　　　      this.form.customerPhone=this.form.customerPhone.replace(/[^\.\d]/g,'');
		                this.form.customerPhone=this.form.customerPhone.replace('.','');
		        　　},
              removeDomain(item) {
		        	
        	   var id = item.id;
                if(!id){
                	 var index = this.form.domains.indexOf(item)
                     if (index !== -1) {
                         this.form.domains.splice(index, 1)
                     }
                    return;
                }
               
          
              
                var param={};
                param.id=id;
                axios.post('/cluerule/clueRule/deleteTeleDirectorRuleById', param)
                .then(function (response) {
                    var resData = response.data;
                    if(resData.code=='0'){
                    	releaseRuleVM.$message({message:'刪除成功',type:'success',duration:2000,onClose:function(){
                    		releaseRuleVM.initClueRule();
                          }});                     
                    }else{
                    	releaseRuleVM.$message({message:resData.msg,type:'error'});
                        console.error(resData);
                    }
                
                })
                .catch(function (error) {
                     console.log(error);
                });
             },
            addDomain() {
                this.form.domains.push({
                	teleDirectorId:'',
                	limitNum: '',
                	businessLine: businessLine,
                    key: Date.now()
                });
            },
            addDomains(){
                this.isShow=true
            },
            cancel(){//取消
            	location.reload();
            },
            checked6Change(value){
                if(value==false){
                    releaseRuleVM.isShow=false
                    releaseRuleVM.isAddAble=true//按钮不可点击
                }else{
                    releaseRuleVM.isAddAble=false//按钮可点击
                }
            },
            initClueRule(){
            	
            	 axios.post('/cluerule/clueRule/queryAllClueRule',null)
                 .then(function (response) {
                     var data =  response.data;
                     if(data.code=='0'){
                        var resData = data.data;
                        //春节规则
                        var festivalRule = resData.festivalRule;
                        if(festivalRule){
                        	releaseRuleVM.form.id10=festivalRule.id;
                        	releaseRuleVM.form.startTime=festivalRule.startTime;
                        	releaseRuleVM.form.endTime=festivalRule.endTime;
                        	releaseRuleVM.checked1=festivalRule.isEnabled==0?false:true;
                        }
                         //电销顾问资源未签约上限
                         var unSignLimitRule = resData.teleUnsignLimitRule;
                         if (unSignLimitRule) {
                             releaseRuleVM.form.id12 = unSignLimitRule.id;
                             releaseRuleVM.checked9 = unSignLimitRule.isEnabled == 0 ? false : true;
                             releaseRuleVM.form.number22 = unSignLimitRule.limitNum;
                         }
                        //自动释放规则
                        var autoReleRuleList = resData.autoReleRuleList;
                        for(var i=0;i<autoReleRuleList.length;i++){
                        	var autoReleRule = autoReleRuleList[i];
                        	if(i==0){
                        		releaseRuleVM.checked2=autoReleRule.isEnabled==0?false:true;
                        		releaseRuleVM.form.number13=autoReleRule.remindTime;
                        	}
                        	if(autoReleRule.customerStatus==1){//未联系
                        		releaseRuleVM.form.id1=autoReleRule.id;
                        		releaseRuleVM.form.number1=autoReleRule.timeoutRelease;
                        		releaseRuleVM.form.number2=autoReleRule.retentionTimes;
                        		releaseRuleVM.form.number3=autoReleRule.retentionDay;
                        		releaseRuleVM.form.remindValue1=autoReleRule.isReleaseRemind;
                        		if(autoReleRule.isReleaseRemind==1){
                        			releaseRuleVM.checked3=true;
                        		}
                        		
                        	}else if(autoReleRule.customerStatus==2){//gen jin
                        		releaseRuleVM.form.id2=autoReleRule.id;
                                releaseRuleVM.form.number4=autoReleRule.timeoutRelease;
                                releaseRuleVM.form.number5=autoReleRule.retentionTimes;
                                releaseRuleVM.form.number6=autoReleRule.retentionDay;
                                releaseRuleVM.form.remindValue2=autoReleRule.isReleaseRemind;
                                if(autoReleRule.isReleaseRemind==1){
                                    releaseRuleVM.checked3=true;
                                }
                        	}else if(autoReleRule.customerStatus==5){//未到访
                        		releaseRuleVM.form.id3=autoReleRule.id;
                                releaseRuleVM.form.number7=autoReleRule.timeoutRelease;
                                releaseRuleVM.form.number8=autoReleRule.retentionTimes;
                                releaseRuleVM.form.number9=autoReleRule.retentionDay;
                                releaseRuleVM.form.remindValue3=autoReleRule.isReleaseRemind;
                                if(autoReleRule.isReleaseRemind==1){
                                    releaseRuleVM.checked3=true;
                                }
                        	}else if(autoReleRule.customerStatus==6){//到访未到访
                        		releaseRuleVM.form.id4=autoReleRule.id;
                                releaseRuleVM.form.number10=autoReleRule.timeoutRelease;
                                releaseRuleVM.form.number11=autoReleRule.retentionTimes;
                                releaseRuleVM.form.number12=autoReleRule.retentionDay;
                                releaseRuleVM.form.remindValue4=autoReleRule.isReleaseRemind;
                                if(autoReleRule.isReleaseRemind==1){
                                    releaseRuleVM.checked3=true;
                                }
                        	}else if(autoReleRule.customerStatus==4){//yao yue
                        		releaseRuleVM.form.id11=autoReleRule.id;
                                releaseRuleVM.form.number19=autoReleRule.timeoutRelease;
                                releaseRuleVM.form.number20=autoReleRule.retentionTimes;
                                releaseRuleVM.form.number21=autoReleRule.retentionDay;
                                releaseRuleVM.form.remindValue5=autoReleRule.isReleaseRemind;
                                if(autoReleRule.isReleaseRemind==1){
                                    releaseRuleVM.checked3=true;
                                }
                        	}
                        	
                        }
                        //强制回收
                        var forceRecycleRuleList =  resData.forceRecycleRuleList;
                        for(var i=0;i<forceRecycleRuleList.length;i++){
                        	var forceRecycleRule = forceRecycleRuleList[i];
                        	var type = forceRecycleRule.recycleType;
                        	if(type==1){
                        		releaseRuleVM.form.id5=forceRecycleRule.id;
                        		releaseRuleVM.checked4=forceRecycleRule.isEnabled==0?false:true;
                        		releaseRuleVM.form.number14=forceRecycleRule.days;
                        		
                        	}else if(type==2){
                        		releaseRuleVM.form.id6=forceRecycleRule.id;
                                releaseRuleVM.checked5=forceRecycleRule.isEnabled==0?false:true;
                                releaseRuleVM.form.number15=forceRecycleRule.days;
                        	}
                        	if(forceRecycleRule.remindTime){
                                //提醒时间
                                if(!releaseRuleVM.form.number13){
                                    releaseRuleVM.form.number13 = forceRecycleRule.remindTime;
                                }
                            }
                        }
                        //公有池
                        var publicPoolReceiveRuleList = resData.publicPoolReceiveRuleList;
                        for(var i=0;i<publicPoolReceiveRuleList.length;i++){
                        	var publicPoolRule = publicPoolReceiveRuleList[i];
                        	var type = publicPoolRule.type;
                        	if(type==1){
                        		releaseRuleVM.form.id7=publicPoolRule.id;
                        		releaseRuleVM.form.number16=publicPoolRule.limitNum;
                        		releaseRuleVM.checked6=publicPoolRule.isEnabled==0?false:true;
                        		releaseRuleVM.isAddAble=publicPoolRule.isEnabled==0?true:false;
                        		releaseRuleVM.isShow=publicPoolRule.isEnabled==0?false:true;
                        		 var teleDirectorReceiveRuleList = resData.teleDirectorReceiveRuleList;
                        		 releaseRuleVM.form.domains = teleDirectorReceiveRuleList;
                        	}else if(type==2){
                        		releaseRuleVM.form.id8=publicPoolRule.id;
                                releaseRuleVM.form.number17=publicPoolRule.limitNum;
                                releaseRuleVM.checked7=publicPoolRule.isEnabled==0?false:true;
                        	}else if(type==3){
                        		releaseRuleVM.form.id9=publicPoolRule.id;
                                releaseRuleVM.form.number18=publicPoolRule.limitNum;
                                releaseRuleVM.checked8=publicPoolRule.isEnabled==0?false:true;
                        	}
                        	
                        }
                        
                         
                     }else{
                    	 releaseRuleVM.$message({message:data.msg,type:'error'});
                         console.error(data);
                     }
                 
                 })
                 .catch(function (error) {
                      console.log(error);
                 });
            }
            
        },
        mounted(){
            document.getElementById('releaseRule').style.display = 'block';
        },
        created(){
        	this.initClueRule();
        }
    })
</script>
</html>