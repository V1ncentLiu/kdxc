<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <!-- import CSS -->
    <link rel="stylesheet" href="css/element-ui.css">
    <link rel="stylesheet" href="css/base.css">
    <style>
        .role-table {
            border: 1px solid #e0e0e0;
            border-bottom: none;
            padding: 0;
            position: relative;
            background: #efefef;
        }
        .role-table ul{background:#fff;}
        .header {
            height: 50px;
            line-height: 50px;
            border-bottom: 1px solid #e7e7e7;
            background: #F8F8F9;
            text-align: center;
            font-size: 16px;
        }

        .vertical-line {
            width: 1px;
            height: 100%;
            background: #ddd;
            position: absolute;
            left: 30%;
            top: 0
        }
        .vertical-line1 {
            width: 1px;
            height: 100%;
            background: #ddd;
            position: absolute;
            left: 80%;
            top: 0
        }

        .left {
            width: 28%;
            float: left;
            user-select: none;
            cursor: pointer;
            padding:20px 0;
            padding-left: 2%;
        }
        .header .left{padding:0;width: 30%;}
        .one {
            padding-left: 20px;
        }

        .right {
            width: 48%;
            float: left;
            padding:20px 0;
            padding-left: 2%;
        }
        .header .right{padding:0;width: 50%;}
        .handle{
            width: 20%;
            float: left;
            text-align: center;
            margin-top: 15px;
        }
        .header .handle{margin: 0;}
        .item-icon {
            margin-left: -5px;
            padding: 5px;
        }

        .line {
            clear: both;
            width: 100%;
            height: 1px;
            background: #e0e0e0;
        }
        [v-cloak] {
            display: none;
        }
    </style>
</head>
<body>
<div id="addRole" class="mainPadding">  
    <el-breadcrumb separator="/" class="elBreadcrumb marginB20">
        <el-breadcrumb-item>Home</el-breadcrumb-item>
        <el-breadcrumb-item>系统管理</el-breadcrumb-item>
        <el-breadcrumb-item><a href="JavaScript:void(0)" data-url="roleManagePage.html">角色管理</a></el-breadcrumb-item>
    </el-breadcrumb>
    <div class="fs16 marginB20"><div class="titleBorderL">添加角色</div></div>
    <el-form :model="addRoleValidateForm" :rules="rules" ref="addRoleValidateForm" label-width="100px" class="demo-ruleForm">
        <el-form-item
            label="角色名称："
            prop="roleName"
            style="width:400px;">
            <el-input v-model="addRoleValidateForm.roleName" autocomplete="off"></el-input>
        </el-form-item>
        <el-form-item label="访问IP限制：">
            <el-radio v-model="addRoleValidateForm.visitLimitRadio" label="0">开放访问</el-radio>
            <el-radio v-model="addRoleValidateForm.visitLimitRadio" label="1">限制IP访问</el-radio>
            <el-button type="primary" size="medium" class="marginL20" @click="dialogFormChooseIP = true">选择访问IP包</el-button>
            <!-- <el-button type="primary" size="medium" class="marginL20" @click="dialogFormSetting = true">设置</el-button> -->
        </el-form-item>
        <div class="fs16 marginB20"><div class="titleBorderL">已选访问IP包</div></div>
        <el-row>
            <el-table 
                style="width: 100%"
                border
                :data="ipListTable" 
                >
                <el-table-column align="center" prop="num" label="序号" width="55"></el-table-column>
                <el-table-column align="center" prop="name" label="IP包名"></el-table-column>
                <el-table-column align="center" prop="address" label="IP地址"></el-table-column>
                <el-table-column align="center" label="操作">
                    <template slot-scope="scope">
                        <el-button
                            @click.native.prevent="deleteRow(scope.$index, ipListTable)"
                            type="text">
                            删除
                        </el-button>
                    </template>
                </el-table-column>
            </el-table>
        </el-row>
        <div class="fs16 marginB20 paddingT20"><div class="titleBorderL">设定每个模块的权限</div></div>
       
        <!-- 树形表格 -->
        <ul class="role-table col-xs-offset-2 col-md-offset-1 col-sm-offset-2 marginB20">
            <li class="header">
                <div class="left">全选&nbsp;&nbsp;&nbsp;&nbsp;模块菜单</div>
                <div class="right">操作权限</div>
                <div class="handle">数据权限</div>
            </li>
            <div class="vertical-line"></div>
            <div class="vertical-line1"></div>
            <li  v-for="(item,index) in dataList" :key="item.id">
                <div class="left"  @click="fold(item)">
                    <i :class="{'el-icon-caret-right':item.folded,'el-icon-caret-bottom':!item.folded}" v-cloak v-if="item.second" class="item-icon"></i>                    
                    <el-checkbox @click.native="handleOneCheckAll($event,item)" v-cloak v-if="!item.second" :indeterminate="item.isIndeterminate" v-model="item.checkAll"> {{item.title}}</el-checkbox>
                    <span v-if="item.second" v-cloak>{{item.title}}</span>
                </div>
                <div class="right">                   
                    <el-checkbox v-if="item.second" :indeterminate="item.isIndeterminate" @change="checkSecondAll(item)" v-model="item.firstCheckAll"></el-checkbox>
                    <el-checkbox-group v-model="item.checkedCities" @change="handleOneCheckedCitiesChange(item)" v-else>
                    <el-checkbox  v-for="m in item.list" :label="m.id" :key="m.id" v-cloak> {{m.name}}</el-checkbox>
                    </el-checkbox-group>
                </div>
                <div class="line"></div>
                <ul v-show="item.second&&!item.folded">
                    <li v-for="(second,cur) in item.second" :key="second.id">
                        <div class="left">
                            <el-checkbox   v-model="second.checkAll" @change="handleCheckAllChange($event,item,second)" v-cloak>
                                {{second.title}}
                            </el-checkbox>
                        </div>
                        <div class="right">
                            <el-checkbox-group v-model="second.checkedCities" @change="handleCheckedCitiesChange(item,second)">
                                <el-checkbox v-for="p in second.list" :label="p.id" :key="p.id" v-cloak >
                                    {{p.name}}
                                </el-checkbox>
                            </el-checkbox-group>
                        </div>
                        <div class="handle">
                            <el-button type="primary" size="small" class="marginL20" @click="dialogFormSetting = true">设置</el-button>
                        </div> 
                        <div class="line"></div>                        
                    </li>
                </ul>
            </li>
        </ul>
        <el-form-item style="text-align: center;">
            <el-button type="primary" @click="submitForm('addRoleValidateForm')">提交</el-button>
            <el-button>取消</el-button>
        </el-form-item>
    </el-form>
    
    <!-- dialog -->
    <el-dialog title="选择IP包" :visible.sync="dialogFormChooseIP">
        <el-form :model="chooseIpform" :rules="rulesChooseIp" ref="chooseIpform">
            <el-row class="marginB10 greybg padding20">
                <el-row :gutter="20">
                    <el-col :span="6">
                        <el-input v-model="chooseIpform.searchIpBag" placeholder="输入IP包名查询"></el-input>
                    </el-col>
                    <el-col :span="6">
                        <el-input v-model="chooseIpform.searchHasIp" placeholder="输入包含IP查询"></el-input>
                    </el-col>
                    <el-col :span="2">
                        <el-button type="primary" size="medium" icon="el-icon-search">搜索</el-button>
                    </el-col>
                </el-row>
            </el-row>
            <el-table 
                tooltip-effect="dark"
                style="width: 100%"
                border
                :data="dataTableIP" 
                class="marginB10">
                <el-table-column align="center" v-model="chooseIpform.type" prop="num" type="selection" name="type" width="55"></el-table-column>
                <el-table-column align="center" prop="ipName" label="IP包名" width="155"></el-table-column>
                <el-table-column align="center" prop="ipAddress" label="IP地址"></el-table-column>
            </el-table>
            <el-form-item class="f-tac">
                <el-button type="primary" @click="submitForm('chooseIpform')">提交</el-button>
                <el-button @click="dialogFormChooseIP = false">取消</el-button>
            </el-form-item>
        </el-form>        
    </el-dialog>

    <el-dialog title="选择数据权限" :visible.sync="dialogFormSetting">
        <el-form :model="chooseLimitform" ref="chooseLimitform">
            <el-row class="marginB20">
                <el-checkbox-group v-model="chooseLimitCheck">
                    <el-checkbox v-for="field in fields" :label="field" :key="field" style="margin-left: 0;margin-right: 10px;margin-bottom: 10px;">{{field}}</el-checkbox>
                </el-checkbox-group>
            </el-row>            
            <el-form-item class="f-tac">
                <el-button type="primary" @click="submitForm('chooseLimitform')">提交</el-button>
                <el-button @click="dialogFormSetting = false">取消</el-button>
            </el-form-item>
        </el-form>        
    </el-dialog>
</div>
</body>
<!-- import Vue before Element -->
<script src="js/vue.js"></script>
<script src="js/vue-router.js"></script>
<!-- import JavaScript -->
<script src="js/element-ui.js"></script>
<script src="js/jquery-3.2.1.min.js"></script>
<script>
    var  fieldOptions = ['阶段', '创建日期', '编码', '资源项目','搜索词','广告位','媒介','电销总监','电销组'];
    new Vue({
        el: '#addRole',
        data: function() {
            return {
                chooseLimitCheck: fieldOptions,//默认选中
                fields: fieldOptions,
                dataList: [
                    {
                        title: "系统管理",
                        id: "1",
                        second: [
                            {
                                title: "用户管理",
                                id: "11",
                                list: [
                                    {
                                        name: "增",
                                        id: "10001"
                                    },
                                    {
                                        name: "删",
                                        id: "10002"
                                    },
                                    {
                                        name: "查",
                                        id: "10003"
                                    }
                                ],
                                checkedCities: []
                            },
                            {
                                title: "会员等级",
                                id: "12",
                                list: [
                                    {
                                        name: "新增",
                                        id: "10004"
                                    },
                                    {
                                        name: "修改",
                                        id: "10005"
                                    },
                                    {
                                        name: "删除",
                                        id: "10006"
                                    }

                                ],
                                checkedCities: []
                            }
                        ]
                    },
                    {
                        title: "菜品管理",
                        id: "2",
                        second: [
                            {
                                title: "菜品列表",
                                id: "21",
                                list: [
                                    {
                                        name: "新增",
                                        id: "10007"
                                    },
                                    {
                                        name: "修改",
                                        id: "10008"
                                    }
                                ],
                                checkedCities: []
                            },
                            {
                                title: "会员等级",
                                id: "22",
                                list: [
                                    {
                                        name: "浏览",
                                        id: "10009"
                                    },
                                    {
                                        name: "新增",
                                        id: "10010"
                                    },
                                    {
                                        name: "修改",
                                        id: "10011"
                                    },
                                    {
                                        name: "删除",
                                        id: "10012"
                                    }
                                ],
                                checkedCities: []
                            }
                        ]
                    }
                ],
                addRoleValidateForm: {
                    roleName: '',
                    visitLimitRadio:'0'
                },
                rules:{
                    roleName:[{ required: true, message: '角色名称不能为空'}]
                },
                chooseIpform: {
                    searchIpBag: '',
                    searchHasIp:'',
                    type:[]
                },
                rulesChooseIp:{
                    type:[{ type: 'array', required: true, message: '请至少选择一个IP包', trigger: 'change' }]
                },
                chooseLimitform:{

                },
                searchInput:'',
                ipListTable: [
                    {
                        num:'1',
                        name:'IP包1',
                        address:'192.168.1.1'
                    }, {
                        num:'2',
                        name:'IP包2',
                        address:'192.168.1.2'
                    }, {
                        num:'3',
                        name:'IP包3',
                        address:'192.168.1.3'
                    }
                ],
                dataTableIP: [
                    {
                        ipName:'IP包1',
                        ipAddress:'192.168.1.1 | 192.168.1.2'
                    }, {
                        ipName:'IP包2',
                        ipAddress:'192.168.1.3'
                    }, {
                        ipName:'IP包3',
                        ipAddress:'192.168.1.4 | 192.168.1.5'
                    }, {
                        ipName:'IP包4',
                        ipAddress:'192.168.1.6'
                }],
                multipleSelection: [],
                dialogFormChooseIP: false,
                dialogFormSetting: false,
                form: {
                    name: '',
                    remark: '',
                    delivery: false,
                    type: []
                },
                formLabelWidth: '120px',
                currentPage: 1//默认第一页
            }             
        },
        methods: {
            submitForm(formName) {
                this.$refs[formName].validate((valid) => {
                    if (valid) {
                        alert('submit!');
                    } else {
                        console.log('error submit!!');
                        return false;
                    }
                });
            },
            resetForm(formName) {
                this.$refs[formName].resetFields();
            },
            handleClick(row) {
                console.log(row);
            },
            handleSelectionChange(val) {
                this.multipleSelection = val;
            },
            // 删除
            deleteFun() {
                this.$confirm('删除后此角色信息将不存在，确认删除吗？', '消息提醒', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                    type: 'warning'
                }).then(() => {
                    this.$message({
                        type: 'success',
                        message: '删除成功!'
                    });
                }).catch(() => {
                    this.$message({
                        type: 'info',
                        message: '已取消删除'
                    });          
                });
            },
            // 分页
            handleSizeChange(val) {
                console.log(`每页 ${val} 条`);
            },
            handleCurrentChange(val) {
                console.log(`当前页: ${val}`);
            },
            deleteRow(index, rows) {
                rows.splice(index, 1);
            },
            fold: function (item) {
                if (typeof item.folded === "undefined") {
                    this.$set(item, "folded", true);
                } else {
                    item.folded = !item.folded;
                }
            },
            // 全选一项
            handleCheckAllChange(event, item, second) {
                console.log(event)
                console.log(item)
                console.log(second)
                var arr = [];
                for (var a = 0; a < second.list.length; a++) {
                    arr.push(second.list[a].id)
                }
                if (typeof second.checkedCities === "undefined") {
                    this.$set(second, "checkedCities", arr);
                }
                second.checkedCities = event.target.checked ? arr : [];
                // if (typeof second === "undefined") {
                //     this.$set(second, "isIndeterminate", false)
                // }
                // second.isIndeterminate = false;
                if (typeof second.checkAll === "undefined") {
                    this.$set(second, "checkAll", true);
                }
                if (typeof item.isIndeterminate === "undefined") {
                    this.$set(item, "isIndeterminate", true);
                }
                for (var a = 0; a < item.second.length; a++) {
                    if (!item.second[a].checkAll) {
                        item.isIndeterminate = true;
                        for (var a = 0; a < item.second.length; a++) {
                            if (item.second[a].checkAll) {
                                break
                            } else {
                                item.isIndeterminate = false;
                                item.firstCheckAll = false;
                            }
                        }
                        break
                    } else {
                        item.isIndeterminate = false;
                        item.firstCheckAll = true;
                    }
                }

            },
            // 单选
            handleCheckedCitiesChange(item, second) {
                var checkedCount = second.checkedCities.length;
                if (typeof second.checkAll === "undefined") {
                    this.$set(second, "checkAll", false);
                }
                if (typeof second.isIndeterminate === "undefined") {
                    this.$set(second, "isIndeterminate", false);
                }
                if (typeof item.isIndeterminate === "undefined") {
                    this.$set(item, "isIndeterminate", true);
                }
                second.isIndeterminate = checkedCount > 0 && checkedCount < second.list.length;
                second.checkAll = checkedCount === second.list.length;
                if (checkedCount === 0) {
                    second.isIndeterminate = false
                }
                for (var a = 0; a < item.second.length; a++) {
                    if (!item.second[a].checkAll) {
                        item.isIndeterminate = true;
                        for (var b = 0; b < item.second.length; b++) {
                            if (item.second[b].checkedCities.length > 0) {
                                break
                            } else {
                                item.isIndeterminate = false;
                                item.firstCheckAll = false;
                            }
                        }
                        break
                    } else {
                        item.isIndeterminate = false;
                        item.firstCheckAll = true;
                    }
                }

            },
            // 点击所有
            checkSecondAll: function (item) {
                if (typeof item.firstCheckAll === "undefined") {
                    this.$set(item, "firstCheckAll", true);
                }
                for (var a = 0; a < item.second.length; a++) {
                    this.checkItemAll(item.firstCheckAll, item.second[a])
                }
                item.isIndeterminate=false
            },
            checkItemAll: function (flag, item) {
                var arr = [];
                for (var a = 0; a < item.list.length; a++) {
                    arr.push(item.list[a].id)
                }
                if (typeof item.checkedCities === "undefined") {
                    this.$set(item, "checkedCities", arr);
                }
                item.checkedCities = flag ? arr : [];
                item.checkAll = flag;
            },
            
            // 没有二级菜单
            handleOneCheckedCitiesChange:function (item) {
                var checkedCount = item.checkedCities.length;
                if (typeof item.isIndeterminate === "undefined") {
                    this.$set(item, "isIndeterminate", false);
                }
                if (typeof item.checkAll === "undefined") {
                    this.$set(item, "checkAll", false);
                }
                item.isIndeterminate = checkedCount > 0 && checkedCount < item.list.length;
                item.checkAll = checkedCount === item.list.length;
            },
            handleOneCheckAll:function (event,item) {
                var arr = [];
                for (var a = 0; a < item.list.length; a++) {
                    arr.push(item.list[a].id)
                }

                item.checkedCities = event.target.checked ? arr : [];
            }
        }
    })
</script>
</html>