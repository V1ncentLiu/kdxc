<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  xmlns:th="http://www.thymeleaf.org" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<head th:replace="_header_include::frag(~{::title},~{},~{})">
    <title>后台管理系统</title>
    <style>
        button a{color:#fff!important;}
    </style>
</head>
<body>
<div id="userManage" class="userManage mainPadding" style="display: none;">  
    <el-breadcrumb separator="/" class="elBreadcrumb marginB20">
        <el-breadcrumb-item>Home</el-breadcrumb-item>
        <el-breadcrumb-item>系统管理</el-breadcrumb-item>
        <el-breadcrumb-item><a >任务管理</a></el-breadcrumb-item>
    </el-breadcrumb>
    
    <el-row class="marginB10">
    		<shiro:hasPermission name="sys:scheduleManager:add">
		        <el-button type="primary" @click="toAddUser"><i class="el-icon-plus"></i>增加任务</el-button>
		    </shiro:hasPermission>
	</el-row>
    <el-row>
        <el-table  ref="multipleTable" tooltip-effect="dark" border @selection-change="handleSelectionChange"
            style="width: 100%"  :data="dataTable"  class="marginB20">
            <!-- <el-table-column align="center" type="selection" width="55"></el-table-column> -->
            <!-- <el-table-column prop="date" label="全选" width="180"></el-table-column> -->
            <el-table-column align="center" prop="jobName" label="任务名称"></el-table-column>
            <el-table-column align="center" prop="groupId" label="任务组ID"></el-table-column>
            <el-table-column align="center" prop="cronExpression" label="时间格式"></el-table-column>
            <el-table-column align="center" prop="url" label="地址URL"></el-table-column>
            <el-table-column align="center" prop="method" label="方法（GET/POST）" :formatter="transformMethod"></el-table-column>
           <el-table-column align="center" prop="params" label="参数JSON格式" ></el-table-column>
            <el-table-column align="center" prop="jobState" label="任务状态" :formatter="transformStatus"></el-table-column>
            <el-table-column align="center" label="操作" width="250">
                <template slot-scope="scope">
	                <div v-if="scope.row.jobState == 1  || scope.row.jobState == 0">
		            	<shiro:hasPermission name="sys:scheduleManager:edit">
	                    <el-button  @click="updateStatus(scope.row.jobId,scope.row.jobName,1,'停止')" type="warning"  size="small">
	                     		   停止
	                    </el-button>
		                </shiro:hasPermission>
					</div>
	                <div v-else-if="scope.row.jobState == 2">
            			<shiro:hasPermission name="sys:scheduleManager:edit">
		                    <el-button @click="updateStatus(scope.row.jobId,scope.row.jobName,2,'启动')" type="primary"  size="small">
		                     		   启动
		                    </el-button>
		                    <el-button @click="toUpdateUser(scope.row.jobId)" type="success"  size="small">
		                     		   修改
		                    </el-button>
		                </shiro:hasPermission>
		                <shiro:hasPermission name="sys:scheduleManager:delete">
		                    <el-button @click="updateStatus(scope.row.jobId,scope.row.jobName,3,'删除')" type="danger"  size="small">
		                     		   删除
		                    </el-button>
	                    </shiro:hasPermission>
					</div>
                </template>
            </el-table-column>
        </el-table>
        <table-pagination :pager="pager" @change="searchTable"></table-pagination>
    </el-row>
    
</div>
<!-- import common js-->
<div th:include="_footer_include :: #jsLib"></div>
</body>
<script th:inline="javascript">
var userVM = new Vue({
        el: '#userManage',
        data: {
	            dataTable:[],
	            pager:{
	                total: 0,
	                currentPage: 1,
	                pageSize: 20,
	            },
	            multipleSelection:[],
                formLabelWidth: '150px',
                formLabelWidth1: '120px'
        },
        methods: {
        	searchTable() {
                var param ={};
                
                param.pageSize = this.pager.pageSize;
                param.pageNum = this.pager.currentPage;
                console.info(param);
                axios.post('/schedule/scheduleManager/list', param)
                .then(function (response) {
                      var result =  response.data;
                      console.info(result);
                      var table=result.data;
                      userVM.dataTable= table.data;
                      userVM.pager.total =  table.total;
                      userVM.pager.currentPage = table.currentPage;
                })
                .catch(function (error) {
                     console.log(error);
                });
                
              },
              //选择行
              handleSelectionChange(val) {
                  this.multipleSelection = val;
              },
              //跳转任务用户页
              toAddUser() {
            	  document.location.href='/schedule/scheduleManager/initCreateSchedule';
              },
              //跳转修改任务页
              toUpdateUser(id) {
            	  document.location.href='/schedule/scheduleManager/initCreateSchedule?id='+id;
              },
              //修改状态
              updateStatus(id,name,status,msg) {
            	  this.$confirm('确定要'+msg+'【'+name+'】任务吗？', '提示', {
                      confirmButtonText: '确定',
                      cancelButtonText: '取消',
                      type: 'warning'
                  }).then(() => {
                	  var param = {};
                	  param.jobId=id;
                	  param.type=status;
                	  axios.post('/schedule/scheduleManager/setStatus', param)
                      .then(function (response) {
                            var result =  response.data;
                            if(result.code=="0"){
                            	userVM.$message.success(msg+"成功");
                            	userVM.searchTable();
                            }else{
                            	userVM.$message.error(msg+"失败");
                            }
                      })
                      .catch(function (error) {
                           console.log(error);
                      });
                   
                  }).catch(() => {
                      this.$message({
                          type: 'info',
                          message: '已取消'+msg
                      });          
                  });
            	 
              },
              //状态转换方法
              transformStatus(row, column, cellValue, index) {
            	  var text="";
                  if(cellValue=="1" ||cellValue=="0" ){
                	  text="启动"
                  }else if(cellValue=="2"){
                	  text="停止"
                  }
                  return text;
              },
              //状态转换方法
              transformMethod(row, column, cellValue, index) {
            	  var text="";
                  if(cellValue=="2"){
                	  text="GET"
                  }else if(cellValue=="1"){
                	  text="POST"
                  }
                  return text;
              },
              handleSizeChange(val) {
                  //下拉框  每页 10,20条切换 调用
                     console.log(`每页 ${val} 条`);
                  this.pageSize = val;
                  this.initTableData(1);
               },
               handleCurrentChange(val) {
                   //点击 页码
                 console.log(`当前页: ${val}`);
                 this.initTableData(val);
               }
        },
        created(){
            console.info("create method");
            this.searchTable();
           
        },
        mounted(){
           console.info("mounted method");
           document.getElementById('userManage').style.display = 'block';
        }
    })
    
</script>
</html>