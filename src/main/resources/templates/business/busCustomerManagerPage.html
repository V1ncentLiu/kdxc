<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  xmlns:th="http://www.thymeleaf.org" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<head th:replace="_header_include::frag(~{::title},~{},~{})">
    <title>后台管理系统</title>
    <style>
        button a{color:#fff!important;}
        .lineFeed { width: 230px; word-break:break-all; word-wrap: break-word; text-align:center; color: #c0c4cc; cursor:not-allowed; }
    </style>
</head>
<body>
<div id="clueManage" class="clueManage mainPadding">  
    <el-breadcrumb separator="/" class="elBreadcrumb marginB20">
        <el-breadcrumb-item>Home</el-breadcrumb-item>
        <el-breadcrumb-item>商务管理</el-breadcrumb-item>
        <el-breadcrumb-item><a >客户管理</a></el-breadcrumb-item>
    </el-breadcrumb>
    
    <el-row class="marginB10">
    		<shiro:hasPermission name="business:busCustomerManager:allocation">
		        <el-button type="primary" @click="toAllocationClue">分发资源</el-button>
		    </shiro:hasPermission>
    		<shiro:hasPermission name="business:busCustomerManager:allocation">
		        <el-button type="success" @click="toTransferClue">外调经理</el-button>
		    </shiro:hasPermission>
		    <shiro:hasPermission name="business:busCustomerManager:cancelVisit">
		         <el-button type="success" @click="notVisit">标记未到访</el-button>
		    </shiro:hasPermission>
	</el-row>
	<el-form :inline="true" :model="searchForm" class="demo-form-inline" ref="searchForm"> 
	    <el-row class="greybg padding20" style="padding-bottom: 0;">
			<el-form-item class="formItem"  prop="visitStatus">
				<el-select v-model="searchForm.visitStatus" clearable  placeholder="到访状态">
					<!-- <el-option  label="全部"  value=""> </el-option> -->
					<el-option
					  	v-for="item in visitStatusOptions"
					  	:key="item.value"
					  	:label="item.name"
					  	:value="item.value">
					</el-option>
				</el-select>
			</el-form-item>
			<el-form-item class="formItem"  prop="isSign">
			    <el-select v-model="searchForm.isSign" clearable placeholder="签约状态">
			        <el-option
				       v-for="item in isSignOptions"
				       :key="item.value"
				       :label="item.name"
				       :value="item.value">
				    </el-option>
			    </el-select>
			</el-form-item>		    	
			<el-form-item class="formItem"  prop="teleGorupId">
				<el-select v-model="searchForm.teleGorupId" clearable @change="getSaleList" placeholder="电销组">
				    <el-option
					    v-for="item in teleGorupOptions"
					    :key="item.id"
					    :label="item.name"
					    :value="item.id">
					</el-option>
				</el-select>
			</el-form-item>
			<el-form-item class="formItem"  prop="teleSaleId">
				<el-select v-model="searchForm.teleSaleId" clearable placeholder="创业顾问">
				    <el-option
					      v-for="item in teleSaleOptions"
					      :key="item.id"
					      :label="item.name"
					      :value="item.id">
					</el-option>
				</el-select>
			</el-form-item>
			<el-form-item class="formItem"  prop="tasteProjectId">
				<el-select v-model="searchForm.tasteProjectId" clearable placeholder="考察项目">
				    <el-option
				      v-for="item in projectOptions"
				      :key="item.id"
				      :label="item.projectName"
				      :value="item.id">
				    </el-option>
			    </el-select>
			</el-form-item>
	  		<el-form-item class="formItem"  prop="province">
			    <el-select v-model="searchForm.province" clearable  placeholder="开店省份">
			      <el-option
				      v-for="item in provinceOptions"
				      :key="item.name"
				      :label="item.name"
				      :value="item.name">
				  </el-option>
			    </el-select>
			</el-form-item>
			<el-form-item class="formItem"  prop="isView">
			    <el-select v-model="searchForm.isView" clearable placeholder="客户读取状态">
			      <el-option
				      v-for="item in isViewOptions"
				      :key="item.value"
				      :label="item.name"
				      :value="item.value">
				  </el-option>
			    </el-select>
			</el-form-item>
			<el-form-item class="formItem"  prop="busGroupId">
				<el-select v-model="searchForm.busGroupId" clearable @change="getBusSaleList(1)" placeholder="商务组">
				    <el-option
					    v-for="item in busGroupOptions"
					    :key="item.id"
					    :label="item.name"
					    :value="item.id">
					</el-option>
				</el-select>
			</el-form-item>
			<el-form-item class="formItem"  prop="busDirectorId">
				<el-select v-model="searchForm.busDirectorId" clearable  placeholder="商务总监">
				    <el-option
					    v-for="item in busDirectorOptions"
					    :key="item.id"
					    :label="item.name"
					    :value="item.id">
					</el-option>
				</el-select>
			</el-form-item>
			<el-form-item class="formItem"  prop="busSaleId">
				<el-select v-model="searchForm.busSaleId" clearable placeholder="商务经理">
				    <el-option
					      v-for="item in busSaleOptions"
					      :key="item.id"
					      :label="item.name"
					      :value="item.id">
					</el-option>
				</el-select>
			</el-form-item>
			<el-form-item class="formItem" prop="cusName">
				<el-input v-model="searchForm.cusName" placeholder="请输入客户姓名" class="input-with-select"></el-input>
			</el-form-item>		    
	        <el-form-item class="formItem" label="提交邀约时间：">
	  			<el-date-picker  v-model="searchForm.startTime" format="yyyy-MM-dd HH:mm"  type="datetime" placeholder="选择日期"></el-date-picker>
	        </el-form-item>
	        <el-form-item class="formItem" label="——">
				<el-date-picker  v-model="searchForm.endTime" format="yyyy-MM-dd HH:mm"  type="datetime" placeholder="选择日期"></el-date-picker>
	        </el-form-item>
	        <el-form-item class="formItem" label="邀约来访时间：">
	  			<el-date-picker  v-model="searchForm.startReserveTime" format="yyyy-MM-dd HH:mm"  type="datetime" placeholder="选择日期"></el-date-picker>
	        </el-form-item>
	        <el-form-item class="formItem" label="——">
				<el-date-picker  v-model="searchForm.endReserveTime" format="yyyy-MM-dd HH:mm"  type="datetime" placeholder="选择日期"></el-date-picker>
	        </el-form-item>
	        <el-form-item class="formItem" label="接受客户时间：">
	  			<el-date-picker  v-model="searchForm.startAllocationTime" format="yyyy-MM-dd HH:mm"  type="datetime" placeholder="选择日期"></el-date-picker>
	        </el-form-item>
	        <el-form-item class="formItem" label="——">
				<el-date-picker  v-model="searchForm.endAllocationTime" format="yyyy-MM-dd HH:mm"  type="datetime" placeholder="选择日期"></el-date-picker>
	        </el-form-item>
			<el-button type="primary" @click="searchTable()">搜索</el-button>
	    </el-row>
  	</el-form>
    <el-row>
        <el-table  ref="multipleTable" tooltip-effect="dark" border @row-dblclick="showCustomerDetail" @selection-change="handleSelectionChange"
            style="width: 100%"  :data="dataTable" @sort-change="sort_change">
           <el-table-column align="center" type="selection" label="全选" width="55"></el-table-column>
           <el-table-column align="center" type="index" width="55" label="序号"></el-table-column>
           <el-table-column align="center" prop="reserveTime" sortable label="邀约来访时间" :formatter="dateFormat" width="170"></el-table-column>
           <el-table-column align="center" prop="cusName" label="客户姓名" ></el-table-column>
           <el-table-column align="center" prop="visitStatus" label="到访状态" :formatter="transformVisit"></el-table-column>
           <el-table-column align="center" prop="isSign" label="签约单" :formatter="transformSign"></el-table-column>
           <el-table-column align="center" prop="isView" label="读取客户状态" :formatter="transformView" width="120"></el-table-column>
           <el-table-column align="center" prop="appiontmentCreateTime" sortable label="提交邀约时间" :formatter="dateFormat" width="170"></el-table-column>
           <el-table-column align="center" prop="allocateTime" sortable label="接受客户时间" :formatter="dateFormat" width="170"></el-table-column>
           <el-table-column align="center" prop="visit" label="到访情况" width="100">
	               <template slot-scope="scope">
		               <div v-if="scope.row.visitStatus === 0">
		                   <el-button  type="text" @click="showNotVisitReason(scope.row)" size="small">未到访（原因）</el-button>
	                    </div>
		               <div v-else-if="scope.row.visitStatus > 0">
		                   <el-button  type="text" @click="showVisitRecord(scope.row)" size="small">点击查看</el-button>
	                   </div>
                   </template>
	       </el-table-column>
           <el-table-column align="center" prop="sign" label="签约单" >
	               <template slot-scope="scope">
		               <div v-if="scope.row.signId != null && scope.row.signId != ''">
		                   <el-button  type="text" @click="toSignPage(scope.row)" size="small">点击查看</el-button>
	                    </div>
		               <div v-else>
	                   </div>
                   </template>
	       </el-table-column>
           <el-table-column align="center" prop="busAreaName" label="商务大区"></el-table-column>
           <el-table-column align="center" prop="busGroupName" label="商务组"></el-table-column>
           <el-table-column align="center" prop="busDirectorName" label="商务总监"></el-table-column>
           <el-table-column align="center" prop="busSaleName" label="商务经理"></el-table-column>
           <el-table-column align="center" prop="teleGorupName" label="电销组"></el-table-column>
           <el-table-column align="center" prop="teleDirectorName" label="电销总监"></el-table-column>
           <el-table-column align="center" prop="teleSaleName" label="电销员工"></el-table-column>
           <el-table-column align="center" prop="teleProjectId" label="电销组项目" :formatter="transformProject" width="100"></el-table-column>
           <el-table-column align="center" prop="tasteProjectId" label="品尝项目" :formatter="transformProject"></el-table-column>
           <el-table-column align="center" prop="signShopType" label="签约店型" :formatter="transformShop"></el-table-column>
           <el-table-column align="center" prop="province" label="开店省份" ></el-table-column>
           <el-table-column align="center" prop="city" label="开店城市" ></el-table-column>
           <el-table-column align="center" prop="district" label="开店区／县" width="120"></el-table-column>
           <el-table-column align="center" prop="sex" label="客户性别" :formatter="transformSex"></el-table-column>
           <el-table-column align="center" prop="age" label="客户年龄" ></el-table-column>
           <el-table-column align="center" prop="partnerType" label="合伙人" :formatter="transformPartner"></el-table-column>
           <el-table-column align="center" prop="hasExperience" label="餐饮经验" :formatter="transformExperience"></el-table-column>
           <el-table-column align="center" prop="hasAddress" label="选址情况" :formatter="transformAddress"></el-table-column>
           <el-table-column align="center" prop="advanceAmount" label="预投金额" :formatter="transformUssm"></el-table-column>
           <el-table-column align="center" prop="purInProject" label="意向项目" :formatter="transformPurProject" ></el-table-column>
           <el-table-column align="center" prop="area" label="店面面积" :formatter="transformArea"></el-table-column>
        </el-table>
        <table-pagination :pager="pager" @change="searchTable"></table-pagination>
    </el-row>
      <!-- dialog -->
      <el-dialog  title="分发资源"  :visible.sync="allocationVisible"  width="30%">
        <template>
            <el-form :model="allocationForm" ref="allocationForm" :rules="allocationFormRules">
                <el-form-item >
                   	{{allocationForm.message}}
                </el-form-item>
                <el-form-item label="商务经理"    :label-width="formLabelWidth"  prop="saleId">
                    <el-select v-model="allocationForm.saleId" placeholder="组内商务经理姓名" style="width: 100%">
                        <el-option v-for="item in saleOptions" 
                        			:key="item.id" 
                        			:label="item.name" 
                        			:value="item.id">
                        </el-option>
                    </el-select>
                </el-form-item>
                <el-form-item label="备注"    :label-width="formLabelWidth"  prop="remark">
                   	<el-input type="textarea" v-model="allocationForm.remark" class="input-with-select" maxLength="200" placeholder="输入分发备注"></el-input>
                </el-form-item>
            </el-form>
            <div slot="footer" class="dialog-footer">
                <el-button type="primary" @click="allocationClue('allocationForm')">提 交</el-button>
                <el-button  @click="allocationVisible = false">取 消</el-button>
            </div>
        </template>
    </el-dialog>
    <!-- dialog -->
      <!-- dialog -->
      <el-dialog  title="外调经理"  :visible.sync="transferVisible"  width="30%">
        <template>
            <el-form :model="transferForm" ref="transferForm" :rules="transferFormRules">
            	<el-form-item >
                   	{{transferForm.message}}
                </el-form-item>
                <el-form-item label="商务经理"    :label-width="formLabelWidth"  prop="saleId">
                    <el-select v-model="transferForm.saleId" placeholder="外调经理姓名（所属大区-所属组）" style="width: 100%">
                        <el-option v-for="item in allSaleOptions" 
                        			:key="item.id" 
                        			:label="item.name" 
                        			:value="item.id">
                        </el-option>
                    </el-select>
                </el-form-item>
                <el-form-item label="备注"    :label-width="formLabelWidth"  prop="remark">
			    	<el-input type="textarea" v-model="transferForm.remark" class="input-with-select" maxLength="200" placeholder="输入外调备注"></el-input>
                </el-form-item>
            </el-form>
            <div slot="footer" class="dialog-footer">
                <el-button type="primary" @click="transferClue('transferForm')">提 交</el-button>
                <el-button  @click="transferVisible = false">取 消</el-button>
            </div>
        </template>
    </el-dialog>
    <!-- dialog -->
     <!--未到访原因-->
    <el-dialog title="未到访原因" :visible.sync="notVisitdDialogVisible"  width="50%">
        <template>
            <el-form :model="notVisitFlag" ref="notVisitFlag">
                <el-form-item label=""  :required="true" >
                	<div class="lineFeed">{{notVisitFlag.str}}</div>
                    <!-- <el-button type="text" disabled style="color: #1e2746">{{notVisitFlag.str}}</el-button> -->
                </el-form-item>
            </el-form>
        </template>
    </el-dialog>
    <!--
        到访记录展示  这个需要放到一个单独的页面中
     -->
    <el-dialog :title="cusTitleName+'客户到访记录'" :visible.sync="showVisitAduitDialogVisible"  width="70%">
        <template>
            <div v-show="showVisitAduitDatas.oneShow">
                <el-button size="mini"  type="text" style = "color: #1e2746">首次到访</el-button>
                <el-table :data="showVisitAduitDatas.one" style="width: 100%" tooltip-effect="dark"  ref="multipleTable">
                    <el-table-column prop="customerName" label="客户姓名"   align="center"></el-table-column>
                    <el-table-column prop="projectName" label="考察项目"   align="center"></el-table-column>
                    <el-table-column prop="companyName" label="考察公司"   align="center"></el-table-column>
                    <el-table-column prop="vistitTime" label="到访时间" :formatter="dateFormat" align="center"></el-table-column>
                    <el-table-column prop="signProvince" label="预签约省份"   align="center"></el-table-column>
                    <el-table-column prop="signCity" label="预签约市"   align="center"></el-table-column>
                    <el-table-column prop="signDistrict" label="预签约区/县"   align="center"></el-table-column>
                    <el-table-column prop="vistitStoreTypeName" label="到访店铺类型"   align="center"></el-table-column>
                    <el-table-column prop="visitType" label="到访类型"   align="center">
                        <template slot-scope="scope">
                            <div v-if="scope.row.status === 1">
                                预约来访
                            </div>
                            <div v-else-if="scope.row.status === 2">
                                慕名来访
                            </div>
                            <div v-else-if="scope.row.status === 3">
                                临时来访
                            </div>
                        </template>
                    </el-table-column>
                    <el-table-column prop="visitCity" label="到访城市"   align="center"></el-table-column>
                    <el-table-column prop="visitPeopleNum" label="到访人数"   align="center"></el-table-column>
                    <el-table-column prop="createTime" label="创建时间"   align="center"></el-table-column>
                    <el-table-column prop="isSign" label="是否签约"   align="center">
                        <template slot-scope="scope">
                            <div v-if="scope.row.isSign === 0">
                                否
                            </div>
                            <div v-else-if="scope.row.isSign ===1">
                                是
                            </div>
                        </template>
                    </el-table-column>
                    <el-table-column prop="status" label="到访有效性"   align="center">
                        <template slot-scope="scope">
                            <div v-if="scope.row.status === 1">
                                审核中
                            </div>
                            <div v-else-if="scope.row.status ===2">
                                有效
                            </div>
                        </template>
                    </el-table-column>
                </el-table>
                <el-button v-show="showVisitAduitDatas.oneNotSignShow" size="mini"  type="text" style = "color: #1e2746">未签约原因：{{showVisitAduitDatas.oneNotSignReason}}</el-button><br>
                <el-button v-show="showVisitAduitDatas.oneRebutShow" size="mini"  type="text" style = "color:red">驳回原因：{{showVisitAduitDatas.oneRebutReason}}</el-button>
            </div>
            <br>
            <div v-show="showVisitAduitDatas.twoShow">
                <el-button size="mini"  type="text" style = "color: #1e2746">2次到访</el-button>
                <el-table :data="showVisitAduitDatas.two" style="width: 100%" tooltip-effect="dark"  ref="multipleTable">
                    <el-table-column prop="customerName" label="客户姓名"   align="center"></el-table-column>
                    <el-table-column prop="projectName" label="考察项目"   align="center"></el-table-column>
                    <el-table-column prop="companyName" label="考察公司"   align="center"></el-table-column>
                    <el-table-column prop="vistitTime" label="到访时间" :formatter="dateFormat" align="center"></el-table-column>
                    <el-table-column prop="signProvince" label="预签约省份"   align="center"></el-table-column>
                    <el-table-column prop="signCity" label="预签约市"   align="center"></el-table-column>
                    <el-table-column prop="signDistrict" label="预签约区/县"   align="center"></el-table-column>
                    <el-table-column prop="vistitStoreTypeName" label="到访店铺类型"   align="center"></el-table-column>
                    <el-table-column prop="visitType" label="到访类型"   align="center">
                        <template slot-scope="scope">
                            <div v-if="scope.row.status === 1">
                                预约来访
                            </div>
                            <div v-else-if="scope.row.status === 2">
                                慕名来访
                            </div>
                            <div v-else-if="scope.row.status === 3">
                                临时来访
                            </div>
                        </template>
                    </el-table-column>
                    <el-table-column prop="visitCity" label="到访城市"   align="center"></el-table-column>
                    <el-table-column prop="visitPeopleNum" label="到访人数"   align="center"></el-table-column>
                    <el-table-column prop="createTime" label="创建时间"   align="center"></el-table-column>
                    <el-table-column prop="isSign" label="是否签约"   align="center">
                        <template slot-scope="scope">
                            <div v-if="scope.row.isSign === 0">
                                否
                            </div>
                            <div v-else-if="scope.row.isSign ===1">
                                是
                            </div>
                        </template>
                    </el-table-column>
                    <el-table-column prop="status" label="到访有效性"   align="center">
                        <template slot-scope="scope">
                            <div v-if="scope.row.status === 1">
                                审核中
                            </div>
                            <div v-else-if="scope.row.status ===2">
                                有效
                            </div>
                        </template>
                    </el-table-column>
                </el-table>
                <el-button  v-show="showVisitAduitDatas.twoNotSignShow" size="mini"  type="text" style = "color: #1e2746">未签约原因：{{showVisitAduitDatas.twoNotSignReason}}</el-button><br>
                <el-button v-show="showVisitAduitDatas.twoRebutShow"  size="mini"  type="text" style = "color: red">驳回原因：{{showVisitAduitDatas.twoRebutReason}}</el-button>
            </div>
            <br>
            <div v-show="showVisitAduitDatas.threeShow">
                <el-button size="mini"  type="text" style = "color: #1e2746">多次到访</el-button>
                <el-table :data="showVisitAduitDatas.three" style="width: 100%" tooltip-effect="dark"  ref="multipleTable">
                    <el-table-column prop="customerName" label="客户姓名"   align="center"></el-table-column>
                    <el-table-column prop="projectName" label="考察项目"   align="center"></el-table-column>
                    <el-table-column prop="companyName" label="考察公司"   align="center"></el-table-column>
                    <el-table-column prop="vistitTime" label="到访时间" :formatter="dateFormat" align="center"></el-table-column>
                    <el-table-column prop="signProvince" label="预签约省份"   align="center"></el-table-column>
                    <el-table-column prop="signCity" label="预签约市"   align="center"></el-table-column>
                    <el-table-column prop="signDistrict" label="预签约区/县"   align="center"></el-table-column>
                    <el-table-column prop="vistitStoreTypeName" label="到访店铺类型"   align="center"></el-table-column>
                    <el-table-column prop="visitType" label="到访类型"   align="center">
                        <template slot-scope="scope">
                            <div v-if="scope.row.status === 1">
                                预约来访
                            </div>
                            <div v-else-if="scope.row.status === 2">
                                慕名来访
                            </div>
                            <div v-else-if="scope.row.status === 3">
                                临时来访
                            </div>
                        </template>
                    </el-table-column>
                    <el-table-column prop="visitCity" label="到访城市"   align="center"></el-table-column>
                    <el-table-column prop="visitPeopleNum" label="到访人数"   align="center"></el-table-column>
                    <el-table-column prop="createTime" label="创建时间"   align="center"></el-table-column>
                    <el-table-column prop="isSign" label="是否签约"   align="center">
                        <template slot-scope="scope">
                            <div v-if="scope.row.isSign === 0">
                                否
                            </div>
                            <div v-else-if="scope.row.isSign ===1">
                                是
                            </div>
                        </template>
                    </el-table-column>
                    <el-table-column prop="status" label="到访有效性"   align="center">
                        <template slot-scope="scope">
                            <div v-if="scope.row.status === 1">
                                审核中
                            </div>
                            <div v-else-if="scope.row.status ===2">
                                有效
                            </div>
                        </template>
                    </el-table-column>
                </el-table>
                <el-button v-show="showVisitAduitDatas.threeNotSignShow" size="mini"  type="text" style = "color: #1e2746">未签约原因：{{showVisitAduitDatas.threeNotSignReason}}</el-button><br>
                <el-button v-show="showVisitAduitDatas.threeRebutShow"  size="mini"  type="text" style = "color: red">驳回原因：{{showVisitAduitDatas.threeRebutReason}}</el-button>
            </div>
        </template>
    </el-dialog>
        <!--标记未到访-->
    <el-dialog title="提示" :visible.sync="notVisitFlagDialogVisible"  width="30%">
        <template>
            <el-form :model="notVisitFlag" ref="notVisitFlag" :rules="notVisitFlagRules">
                <el-form-item>
                    <!--<el-button type="text" disabled style="color: #1e2746; width:100px; word-wrap:break-word; word-break:normal;">{{notVisitFlag.str}}</el-button>-->
                    <span style="margin-left: 80px;display:block;color: #1e2746; width:90%; word-wrap:break-word; word-break:normal;">{{notVisitFlag.str}}</span>
                </el-form-item>
                <el-form-item label="未到访原因" :label-width="formLabelWidth"  prop="notVisitReason" >
                    <el-input type="textarea" v-model="notVisitFlag.notVisitReason"  maxlength="100" :rows="3" placeholder="请输入内容(限制100字)"></el-input>
                </el-form-item>
            </el-form>
            <div slot="footer" class="dialog-footer">
                <el-button type="primary" @click="saveNotVisit">确定</el-button>
                <el-button  @click="notVisitFlagDialogVisible = false">取消</el-button>
            </div>
        </template>
    </el-dialog>
</div>
<!-- import common js-->
<div th:include="_footer_include :: #jsLib"></div>
</body>
<script th:inline="javascript">
var busSaleGroupList=[[${busSaleGroupList}]];//搜索商务组
var busDirectorList=[[${busDirectorList}]];//搜索商务总监
var busSaleList=[[${busSaleList}]];//分发商务经理
var allSaleList=[[${allSaleList}]];//所有商务经理
var teleSaleGroupList=[[${teleSaleGroupList}]];//电销组
var projectList=[[${projectList}]];//项目
var provinceList=[[${provinceList}]];//省份
var optionAddressList=[[${optionAddressList}]];//选址情况
var partnerList=[[${partnerList}]];//合伙人
var cateringExperienceList=[[${cateringExperienceList}]];//餐饮经验
var shopTyleList=[[${shopTyleList}]];//签约店型
var storefrontAreaList=[[${storefrontAreaList}]];//店铺面积
var ussmList=[[${ussmList}]];//投资金额

var customerVM = new Vue({
        el: '#clueManage',
        data: {
        		cusTitleName:'',//到访情况-点击查看-title客户名称
        		searchForm: {
        			visitStatus: '',
        			isSign: '',
	        		teleGorupId: '',
	        		teleSaleId: '',
	        		tasteProjectId: '',
	        		province: '',
	        		isView: '',
	        		busGroupId: '',
	        		busDirectorId: '',
	        		busSaleId: '',
	        		cusName: '',
	        		startTime: '',
	        		endTime: '',
	        		startReserveTime: '',
	        		endReserveTime: '',
	        		startAllocationTime: '',
	        		endAllocationTime: '',
	        		sortField: '',
	        		sortType: ''
	            },
	            allocationForm: {
	            	saleId:'',
	            	remark:'',
	            	message:''
                },
                transferForm: {
	            	saleId:'',
	            	remark:'',
	            	message:''
                },
                notVisitFlag:{
                    str:"",
                    clueIds:[],
                    notVisitReason:""
                },
                showVisitAduitDatas:{
                    one:[],
                    two:[],
                    three:[],
                    oneNotSignReason:"",
                    twoNotSignReason:"",
                    threeNotSignReason:"",
                    oneRebutReason:"",
                    twoRebutReason:"",
                    threeRebutReason:"",
                    oneShow:true,
                    twoShow:false,
                    threeShow:false,

                    oneRebutShow:false,
                    twoRebutShow:false,
                    threeRebutShow:false,
                    oneNotSignShow:true,
                    twoNotSignShow:false,
                    threeNotSignShow:false
                },
	            dataTable:[],
	            saleOptions:busSaleList,
	            allSaleOptions:allSaleList,
	            busGroupOptions:busSaleGroupList,
	            busDirectorOptions:busDirectorList,
	            busSaleOptions:busSaleList,
	            teleGorupOptions:teleSaleGroupList,
	            teleSaleOptions:[],
	            projectOptions:projectList,
	            provinceOptions:provinceList,
	            notVisitFlagDialogVisible:false,
	            visitStatusOptions:[{
	            	value:-1,
	            	name:"待处理"
	            },{
	            	value:0,
	            	name:"未到访"
	            },{
	            	value:1,
	            	name:"首次到访"
	            },{
	            	value:2,
	            	name:"二次到访"
	            },{
	            	value:3,
	            	name:"多次到访"
	            }],
	            isSignOptions:[{
	            	value:0,
	            	name:"未签约"
	            },{
	            	value:1,
	            	name:"已签约"
	            }],
	            isViewOptions:[{
	            	value:0,
	            	name:"未读"
	            },{
	            	value:1,
	            	name:"已读"
	            }],
	            
	            allocationVisible: false,
	            transferVisible: false,
	            notVisitdDialogVisible:false,
	            showVisitAduitDialogVisible:false,
	            pager:{
	                total: 0,
	                currentPage: 1,
	                pageSize: 20,
	            },
	            allocationFormRules: {
	            	saleId: [
	                    { required: true, message: '请选择商务经理', trigger: 'change' }
	                ]
	              },
	            transferFormRules: {
	            	saleId: [
	                    { required: true, message: '请选择商务经理', trigger: 'change' }
	                ]
	              },
	            multipleSelection:[],
                formLabelWidth: '150px',
                formLabelWidth1: '120px',
        },
        methods: {
        	searchTable() {
                var startTime = this.searchForm.startTime;
                var endTime = this.searchForm.endTime;
                var startReserveTime = this.searchForm.startReserveTime;
                var endReserveTime = this.searchForm.endReserveTime;
                var startAllocationTime = this.searchForm.startAllocationTime;
                var endAllocationTime = this.searchForm.endAllocationTime;
                var vilad=false;
                if(startTime&&endTime&&startTime> endTime){
                	vilad=true;
                }
                if(startReserveTime&&endReserveTime&&startReserveTime> endReserveTime){
                	vilad=true;
                }
                if(startAllocationTime&&endAllocationTime&&startAllocationTime> endAllocationTime){
                	vilad=true;
                }
                if(vilad){
                	this.$message({
                        message: '开始时间不能大于结束时间',
                        type: 'warning'
                      });
                    return;
                }
                var param = this.searchForm;
                param.pageSize = this.pager.pageSize;
                param.pageNum = this.pager.currentPage;
                param.sortField = this.searchForm.sortField;
                param.sortType = this.searchForm.sortType;
                console.info(param);
                axios.post('/business/busCustomerManager/list', param)
                .then(function (response) {
                      var result =  response.data;
                      console.info(result);
                      var table=result.data;
                      customerVM.dataTable= table.data;
                      customerVM.pager.total =  table.total;
                      customerVM.pager.currentPage = table.currentPage;
                })
                .catch(function (error) {
                     console.log(error);
                });
                
              },
              notVisit(){
                  var rows = customerVM.multipleSelection;
                  if(rows.length==0){
                      this.$message({message: '请选择数据', type: 'warning'});
                      return false;
                  }else{
                      var names = "";
                      var rowIds = [];
                      debugger;
                   for(var i=0;i<rows.length;i++){
                        if(rows[i].visitStatus==0||rows[i].visitStatus==1||rows[i].visitStatus==2||rows[i].visitStatus==3){
                              this.$message({message: '勾选数据中，包含了已到访或是已标记的客户', type: 'warning'});
                              return false;
                          }
                          names = names + '【'+rows[i].cusName+'】'; 
                          rowIds.push(rows[i].clueId);
                      } 
                      var str = '确定要将此'+names+'标记为未到访吗?';
                      this.notVisitFlag.clueIds = rowIds;
                      this.notVisitFlag.str  = str;
                      this.notVisitFlag.notVisitReason = "";
                      this.notVisitFlagDialogVisible = true;
                  }
              },
              saveNotVisit(){
                  var param = this.notVisitFlag;
                  // 设置 clueid
                  this.$refs['notVisitFlag'].validate((valid) => {
                      if (valid) {
                          axios.post("/aggregation/businessMyCustomer/notVisit", param)
                              .then(function (response) {
                                  if (response.data.code == 0) {
                                	   customerVM.$message({type: 'success', message: '标记成功!',duration:2000,onClose:function(){
                                    	  customerVM.pager.pageNum = 1
                                    	  customerVM.searchTable();
                                    	  customerVM.notVisitFlagDialogVisible = false;
                                    	 // customerVM.addVisitRecord.clueId = "";
                                          }});
                                  } else {
                                	  customerVM.$message.error(response.data.msg);
                                  }
                              }).catch(function (error) {console.log(error);});
                      } else {return false;}
                  });
              },
              //选择行
              handleSelectionChange(val) {
                  this.multipleSelection = val;
              },
              handleSizeChange(val) {
                  //下拉框  每页 10,20条切换 调用
                     console.log(`每页 ${val} 条`);
                  this.pageSize = val;
                  this.initTableData(1);
               },
               handleCurrentChange(val) {
                   //点击 页码
                 console.log(`当前页: ${val}`);
                 this.initTableData(val);
               },
               //品尝项目转换方法
               transformProject(row, column, cellValue, index) {
            	   var text="";
              	   if(projectList&&cellValue){
	            	   var array=cellValue.split(",");
	                   for(var i=0;i<array.length;i++){
	                	   for(var j=0;j<projectList.length;j++){
	 	                		if(array[i]==projectList[j].id){
	 	                			if(i==0){
		 	                			text=projectList[j].projectName;
	 	                			}else{
		 	                			text=text+","+projectList[j].projectName;
	 	                			}
	 	                		}
	 	                	}
	                	}
              	    }else{
              	    	text=row.purOutProject;
              	    }
                    return text;
               },
             //意向项目转换方法
               transformPurProject(row, column, cellValue, index) {
            	   var text="";
            	   if(cellValue){
	            	   if(projectList){
	  	                  for(var i=0;i<projectList.length;i++){
	  	                		if(cellValue==projectList[i].value){
	  	                			text=projectList[i].name;
	  	                		}
	  	                	}
	              	  }
            	   }else{
             	    	text=row.purOutProject;
             	   }
                   return text;
               },
               //性别转换方法
               transformSex(row, column, cellValue, index) {
                 var text="";
                 if(cellValue=="1"){
                   text="男"
                 }else if(cellValue=="2"){
                   text="女"
                 }
                 return text;
               },
               //到访状态转换方法
               transformVisit(row, column, cellValue, index) {
                 var text="";
                 if(cellValue=="-1"){
                   text="待处理"
                 }else if(cellValue=="0"){
                   text="未到访"
                 }else if(cellValue=="1"){
                   text="首次到访"
                 }else if(cellValue=="2"){
                   text="二次到访"
                 }else if(cellValue=="3"){
                   text="多次到访（"+row.visitNum+"次）"
                 }
                 return text;
               },
               //签约状态转换方法
               transformSign(row, column, cellValue, index) {
                 var text="";
                 if(cellValue=="0"){
                   text="未签约"
                 }else if(cellValue=="1"){
                   text="已签约"
                 }
                 return text;
               },
               //读取状态转换方法
               transformView(row, column, cellValue, index) {
                 var text="";
                 if(cellValue=="0"){
                   text="未读"
                 }else if(cellValue=="1"){
                   text="已读"
                 }
                 return text;
               },
               //签约店型转换方法
               transformShop(row, column, cellValue, index) {
             	  var text="";
             	  if(shopTyleList){
 	                  for(var i=0;i<shopTyleList.length;i++){
 	                		if(cellValue==shopTyleList[i].value){
 	                			text=shopTyleList[i].name;
 	                		}
 	                	}
             	  }
                   return text;
               },
               //合伙人转换方法
               transformPartner(row, column, cellValue, index) {
             	  var text="";
             	  if(partnerList){
 	                  for(var i=0;i<partnerList.length;i++){
 	                		if(cellValue==partnerList[i].value){
 	                			text=partnerList[i].name;
 	                		}
 	                	}
             	  }
                   return text;
               },
               //选址情况转换方法
               transformAddress(row, column, cellValue, index) {
             	  var text="";
             	  if(optionAddressList){
 	                  for(var i=0;i<optionAddressList.length;i++){
 	                		if(cellValue==optionAddressList[i].value){
 	                			text=optionAddressList[i].name;
 	                		}
 	                	}
             	  }
                   return text;
               },
               //餐饮经验转换方法
               transformExperience(row, column, cellValue, index) {
             	  var text="";
             	  if(cateringExperienceList){
 	                  for(var i=0;i<cateringExperienceList.length;i++){
 	                		if(cellValue==cateringExperienceList[i].value){
 	                			text=cateringExperienceList[i].name;
 	                		}
 	                	}
             	  }
                   return text;
               },
             //店铺面积转换方法
               transformArea(row, column, cellValue, index) {
             	  var text="";
             	  if(storefrontAreaList){
 	                  for(var i=0;i<storefrontAreaList.length;i++){
 	                		if(cellValue==storefrontAreaList[i].value){
 	                			text=storefrontAreaList[i].name;
 	                		}
 	                	}
             	  }
                   return text;
               },
               //投资金额转换方法
               transformUssm(row, column, cellValue, index) {
             	  var text="";
             	  if(ussmList){
 	                  for(var i=0;i<ussmList.length;i++){
 	                		if(cellValue==ussmList[i].value){
 	                			text=ussmList[i].name;
 	                		}
 	                	}
             	  }
                   return text;
               },
               //日期数据格式化方法
               dateFormat( row, column, cellValue, index) {
                 if (cellValue == undefined) {
                    return "";
                 }
                 return moment(cellValue).format("YYYY-MM-DD HH:mm:ss");
               },
               //打开分发资源
               toAllocationClue() {
            	   this.allocationForm.message="";
           	       var rows = this.multipleSelection;
            	   if(rows.length==0){
                       this.$message({
                          message: '请选择一条数据进行分发',
                          type: 'warning'
                        });
                       return;
                   }
            	   var text="";
            	   for(var i=0;i<rows.length;i++){
                   	   var curRow = rows[i];
                       if(curRow.busSaleId){
                    	   text+="当前选择“"+curRow.cusName+"”已有之前服务商务经理"+curRow.busSaleName+",";
                       }
                   }
            	   if(text!=""){
	                   text+="请确认后分发客户。";
	                   this.allocationForm.message=text;
                   }
            	   
                   this.allocationVisible = true;
               },
               allocationClue(formName){//分发资源
            	   this.$refs[formName].validate((valid) => {
         	          if (valid) {
         	        	 var rows = this.multipleSelection;
      	           	   var idList = [];
      	               var clueIdList = [];
      	               for(var i=0;i<rows.length;i++){
      	            	   var curRow = rows[i];
      	            			idList.push(curRow.id);
      	            			clueIdList.push(curRow.clueId);
      	               }
      	            	  //外调
      	            	  var param  = {};
      	            	  param.type=1;
	      	           	  param.idList=idList;
	      	           	  param.clueIdList=clueIdList;
                     	  param.busSaleId=this.allocationForm.saleId;
                     	  param.remark=this.allocationForm.remark;
                        axios.post('/business/busAllocation/busAllocationClue',param)
                         .then(function (response) {
                             var data =  response.data;
                             if(data.code=='0'){
                             	customerVM.$message({message:'分发成功',type:'success',duration:1000,onClose:function(){
                             		customerVM.allocationVisible = false;
                             		customerVM.searchTable();
                         	    }});
                             }else{
                             	customerVM.$message({
                                     message: "接口调用失败",
                                     type: 'error'
                                   }); 
                             }
                         })
                         .catch(function (error) {
                           console.log(error);
                         })
                         .then(function () {
                         	
                         });
         	          } else {
         	            console.log('error submit!!');
         	            return false;
         	          }
         	    });
           	     
                 },// method end
               //打开外调经理
               toTransferClue() {
           	       var rows = this.multipleSelection;
            	   if(rows.length==0){
                       this.$message({
                          message: '请选择一条数据进行外调',
                          type: 'warning'
                        });
                       return;
                   }
            	   var text="";
            	   for(var i=0;i<rows.length;i++){
                   	   var curRow = rows[i];
                       if(curRow.busSaleId){
                    	   text+="当前选择“"+curRow.cusName+"”已有之前服务商务经理"+curRow.busSaleName+",";
                       }
                   }
            	   if(text!=""){
	                   text+="请确认后分发客户。";
	                   this.allocationForm.message=text;
                   }
                   this.transferVisible = true;
               },
               transferClue(formName){//外调经理
            	   this.$refs[formName].validate((valid) => {
         	          if (valid) {
         	        	 var rows = this.multipleSelection;
                         var idList = [];
                         var clueIdList = [];
                         for(var i=0;i<rows.length;i++){
                      	   var curRow = rows[i];
                      			idList.push(curRow.id);
                      			clueIdList.push(curRow.clueId);
                         }
                      	  //外调
                      	  var param  = {};
                      	  param.type=2;
                     	  param.idList=idList;
                     	  param.clueIdList=clueIdList;
                     	  param.busSaleId=this.transferForm.saleId;
                     	  param.remark=this.transferForm.remark;
                         axios.post('/business/busAllocation/busAllocationClue',param)
                          .then(function (response) {
                              var data =  response.data;
                              if(data.code=='0'){
                              	customerVM.$message({message:'外调成功',type:'success',duration:1000,onClose:function(){
                              		customerVM.transferVisible = false;
                              		customerVM.searchTable();
                          	    }});
                              }else{
                              	customerVM.$message({
                                      message: "接口调用失败",
                                      type: 'error'
                                    }); 
                              }
                          })
                          .catch(function (error) {
                            console.log(error);
                          })
                          .then(function () {
                          	
                          });
         	          } else {
         	            console.log('error submit!!');
         	            return false;
         	          }
            	   });
                 },// method end
                 showNotVisitReason(row){
                     // 展示未到访原因
                     var param={};
                     param.id = row.clueId;
                     axios.post('/aggregation/businessMyCustomer/notVisitReason',param).then(function (response) {
                         customerVM.notVisitdDialogVisible = true;
                         console.log(response)
                         customerVM.notVisitFlag.str = response.data.data.notVisitReason
                     });
                 },
                 // 展示到访记录
                 showVisitRecord(row){
                	 this.cusTitleName = row.cusName;
                	 this.showVisitAduitDialogVisible = true;
                     var param = {};
                     axios.post('/busVisitRecord/queryList',param).then(function (response) {
                         if(null===response||response.data==null||response.data.code!='0'){
                             if(response.data.code!='0'){
                                 customerVM.$message({message: response.data.msg, type: 'warning'});
                             }
                             return false;
                         }else{
                             //customerVM.showVisitAduitDatas.visitTableData =response.data.data;
                             // customerVM.showVisitAduitDatas.visitStatus = row.visitStatus
                             // if(response.data.data.length>0){
                             //     customerVM.showVisitAduitDatas.notSignReason = response.data.data[0].notSignReason
                             // }
                             var dataList = response.data.data;
                             // 首次到访
                             var first = [];
                             if(dataList.length>=1){
                                 first.push(dataList[dataList.length-1])
                                 customerVM.showVisitAduitDatas.one = first;
                                 if(!first[0].notSignReason){
                                     customerVM.showVisitAduitDatas.oneNotSignReason = first[0].notSignReason;
                                     customerVM.showVisitAduitDatas.oneNotSignShow = true;
                                 }
                                 if(!first[0].rebutReason){
                                     customerVM.showVisitAduitDatas.oneRebutReason = first[0].rebutReason;
                                     customerVM.showVisitAduitDatas.oneRebutShow = true;
                                 }
                             }

                             // 二次到访
                             var two = [];
                             if(dataList.length>=2){
                                 two.push(dataList[dataList.length-2])
                                 customerVM.showVisitAduitDatas.two = two;
                                 customerVM.showVisitAduitDatas.twoShow = true;
                                 if(!first[0].notSignReason){
                                     customerVM.showVisitAduitDatas.twoNotSignReason = two[0].notSignReason;
                                     customerVM.showVisitAduitDatas.twoNotSignShow = true;
                                 }
                                 if(!first[0].rebutReason){
                                     customerVM.showVisitAduitDatas.twoRebutReason = two[0].rebutReason;
                                     customerVM.showVisitAduitDatas.twoRebutShow = true;
                                 }

                             }
                             // 多次到访
                             var three = []
                             if(dataList.length>=3){
                                 three = dataList.slice(0,dataList.length-2)
                                 customerVM.showVisitAduitDatas.three = three;
                                 customerVM.showVisitAduitDatas.threeShow = true;
                                 if(!first[0].notSignReason){
                                     customerVM.showVisitAduitDatas.threeNotSignReason = three[0].notSignReason;
                                     customerVM.showVisitAduitDatas.threeNotSignShow = true;
                                 }
                                 if(!first[0].rebutReason){
                                     customerVM.showVisitAduitDatas.threeRebutReason = three[0].rebutReason;
                                     customerVM.showVisitAduitDatas.threeRebutShow = true;
                                 }

                             }
                         //
                         }

                     })
                 },
                 toSignPage(row){  // 进入签约单明细  能够 新增付款
                     window.location.href='/businesssign/visitRecordPage?readyOnly=1&clueId='+row.clueId+"&signId="+row.signId;
                 },
                 showCustomerDetail(row, column){ // 客户详情
                	 window.location.href='/bus/BusinessCustomer/viewCustomerInfo?clueId='+row.clueId;
                 },
              //根据电销组查询电销总监
              getSaleList() {
            	  var param ={};
                  param.orgId = this.searchForm.teleGorupId;
                  console.info(param);
                  axios.post('/business/busAllocation/getSaleList', param)
                  .then(function (response) {
                        var result =  response.data;
                        console.info(result);
                        var table=result.data;
                        customerVM.teleSaleOptions= table;
                  })
                  .catch(function (error) {
                       console.log(error);
                  });
              },
              //根据商务组查询商务经理
              getBusSaleList() {
            	  var param ={};
	              param.orgId = this.searchForm.busGroupId;
                  console.info(param);
                  axios.post('/business/busCustomerManager/getSaleList', param)
                  .then(function (response) {
                        var result =  response.data;
                        console.info(result);
                        var table=result.data;
                        customerVM.busSaleOptions= table;
                  })
                  .catch(function (error) {
                       console.log(error);
                  });
              },
              //排序
              sort_change(column) {
            	  var sortField="";
            	  var sortType="";
                  if (column.prop === 'appiontmentCreateTime') {
                	  sortField="a.createTime";
                  } else if (column.prop === 'reserveTime') {
                	  sortField="a.reserveTime";
                  } else if (column.prop === 'allocateTime') {
                	  sortField="a.allocateTime";
                  }
                  if (column.order === 'descending') {
                  	sortType="desc";
                  } else if (column.order === 'ascending') {
                  	sortType="asc";
                  }
                  this.searchForm.sortField=sortField;
                  this.searchForm.sortType=sortType;
                  this.searchTable();
                }
        },
        created(){
            console.info("create method");
            this.searchTable();
           
        },
        mounted(){
           console.info("mounted method");
        }
    })
    
</script>
</html>