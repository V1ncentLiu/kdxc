<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  xmlns:th="http://www.thymeleaf.org">
<head th:replace="_header_include::frag(~{::title},~{::link},~{})">
    <title>后台管理系统</title>
    <link rel="stylesheet" th:href="@{/css/custom/homepage/index.css}">
</head>
<body>
<div id="Loading">
    <div class="loader-inner ball-beat">
        <div></div>
        <div></div>
        <div></div>
    </div>
</div>
<div id="app">
    <el-container style="height: 100%;">
        <!-- 头部 -->
        <el-header class="elHeader">        
            <div class="logoimg f-fl">
                <!-- <img src="../static/images/logoimg.png" alt=""> -->
                <img th:src="@{/images/logoimg.png}" alt="">
            </div>   
            <div class="f-fr">
                <el-button type="primary" @click="openLoginClientDialog" class="f-fl headerBtn"><i class="el-icon-service" style="margin-right: 5px;"></i>{{callTitle}}</el-button>
                <el-button type="primary" @click="openOutboundDialog" class="f-fl headerBtn"><i class="el-icon-phone-outline" style="margin-right: 5px;"></i>主动外呼</el-button>
                <el-button type="primary" class="messageBtn f-fl" @click="openMessageCenter">消息中心<em class="redcolor" id="messageCount"></em></el-button>
                <!-- <i class="iconfont icon-touxiang headerImg f-fl"></i> -->
                <img th:src="@{/images/headIco.png}" alt="" class="headIco">
                <!-- 下拉 -->
                <el-dropdown class="elDropdown f-fr" trigger="click"  @command="handleCommand">
                    <div class="elDropdownBtn">
                        <span>{{user.name}}— 在线</span> 
                        <i class="el-icon-caret-bottom"></i>
                    </div>            
                    <el-dropdown-menu slot="dropdown">
                        <el-dropdown-item command="modifyPwd">修改密码</el-dropdown-item>
                        <el-dropdown-item command="logout">退出登录</el-dropdown-item>
                    </el-dropdown-menu>
                </el-dropdown>
            </div>
        </el-header>
        <el-container>
            <span  @click="toogleClick" :class="{'iconopenBox':isActive,'iconopenBox active':!isActive}">
                <i  :class="{'iconfont el-icon-arrow-left':isActive,'iconfont el-icon-arrow-right':!isActive}"></i>
            </span>
            <!-- 左侧菜单 -->
            <el-aside width="" class="elAside">
                <el-menu 
                    class="el-menu-vertical-demo" 
                    @open="handleOpen" 
                    @close="handleClose" 
                    :collapse="isCollapse" 
                    :default-openeds="defaultOpeneds"
                    :default-active="defaultActive"
                    background-color="rgb(26, 83, 161)" 
                    text-color="#fff">   
                    
                    <!-- foreach menuList start -->
                      <el-submenu :index="index+''" :key="index"  v-for="(item,index) in items">
                        <template slot="title">
                            <!-- <i class="iconfont icon-menu1"></i> -->
                            <i :class="'fa fa-lg '+ item.iconName"></i>
                            <span slot="title">{{item.name}}</span>
                        </template>
                        
                        
                        <el-menu-item  class="menu" :key="index+subIndex" :data-url="subItem.url" :index="index+'-'+subIndex" @click="menuClick(subItem.url)" 
                                v-for="(subItem,subIndex) in item.subList">
                                       <i :class="'fa fa-lg '+ subItem.iconName"></i>  {{subItem.name}}
                        </el-menu-item>
                    </el-submenu> 
                    
                    <!-- foreach menuList end -->
                                      
                </el-menu>
            </el-aside>
            <!-- 右侧内容区 -->
            <el-main class="elMain">
                <iframe  :src="initUrl" id="iframeBox" ref="iframeBox" name='iframe' frameborder="0" width="100%" height="100%">
                    <p>Your browser does not support iframes.</p>
                </iframe>
            </el-main>
        </el-container>
    </el-container>
    
     <!-- 修改密码 dialog start -->
     <el-dialog title="修改密码" :visible.sync="dialogModifyPwdVisible" @close="closeModifyPwdDialog">
        <el-form :model="modifyForm" ref="modifyForm" :rules="modifyFormRules">
            <el-form-item label="当前密码：" :label-width="formLabelWidth" prop="oldPassword">
                <el-input type="password" v-model="modifyForm.oldPassword" autocomplete="off" maxlength="30"></el-input>
            </el-form-item>
            <el-form-item label="新密码：" :label-width="formLabelWidth" prop="newPassword">
                <el-input  type="password" v-model="modifyForm.newPassword" autocomplete="off"  maxlength="30"></el-input>
            </el-form-item>
            <el-form-item label="确认密码：" :label-width="formLabelWidth" prop="confirmPwd">
                <el-input type="password" v-model="modifyForm.confirmPwd" autocomplete="off"  maxlength="30"></el-input>
            </el-form-item>
        </el-form>
        <div slot="footer" class="dialog-footer" center="true">
            <el-button type="primary" @click="saveModifyForm('modifyForm')">保存</el-button>
            <el-button @click="cancelModifyForm('modifyForm')">取 消</el-button>
        </div>
    </el-dialog>
 <!-- 修改密码 dialog end -->
 <!-- 退出登录 dialog start -->
	 <el-dialog title="提示" :visible.sync="dialogLogoutVisible" width="30%">
	  <span>确认退出系统吗？</span>
	  <span slot="footer" class="dialog-footer">
	    <el-button type="primary" @click="confirmLogout">确认</el-button>
	  </span>
</el-dialog>
 <!-- 退出登录 dialog start -->
 
 <!-- 呼叫中心登录 dialog start -->
     <el-dialog title="呼叫中心" :visible.sync="dialogLoginClientVisible" class="callCenterDialog" :close-on-click-modal="false">
     	<el-button type="text" icon="el-icon-minus" class="minDialog" @click="handleMin"></el-button>
        <el-form :model="loginClientForm" ref="loginClientForm" :rules="loginClientForm.clientType==1?trClientFormRules:qimoClientFormRules">
            <el-form-item label="选择呼叫中心：" :label-width="formLabelWidth" prop="clientType">
                <el-select v-model="loginClientForm.clientType" placeholder="请选择" value-key="value" @change="changeClientType" style="width: 60%;">
                    <el-option
                        v-for="item in clientTypeOptions"
                        :key="item.value"
                        :label="item.label"
                        :value="item.value">
                    </el-option>
                </el-select>
            </el-form-item>
            <template v-if="loginClientForm.clientType==1">
	            <el-form-item label="坐席号：" :label-width="formLabelWidth" prop="cno">
	                <el-input   v-model="loginClientForm.cno" autocomplete="off"  maxlength="10" style="width: 60%;" @keyup.native="cnoNumber"></el-input>
	            </el-form-item>
	             <el-form-item label="绑定电话：" :label-width="formLabelWidth" prop="bindPhone">
	                <el-input   v-model="loginClientForm.bindPhone" autocomplete="off"  maxlength="11" style="width: 60%;" @keyup.native="bindPhoneNumber"></el-input>
	            </el-form-item>
            </template>
            <template v-if="loginClientForm.clientType==2">
                <el-form-item label="登录坐席：" :label-width="formLabelWidth" prop="loginClient">
                    <el-input   v-model="loginClientForm.loginClient" autocomplete="off"  maxlength="10" style="width: 60%;"></el-input>
                </el-form-item>
            </template>
            <el-form-item label="绑定类型：" :label-width="formLabelWidth" prop="bindPhoneType">
               <el-select v-model="loginClientForm.bindPhoneType" placeholder="请选择" value-key="value" style="width: 60%;">
                   <el-option
                       v-for="item in bindPhoneTypeOptions"
                       :key="item.value"
                       :label="item.label"
                       :value="item.value">
                   </el-option>
               </el-select>
            </el-form-item>
            
        </el-form>
        <div slot="footer" class="dialog-footer" center="true">
            <el-button type="primary" @click="loginClient('loginClientForm')">登录</el-button>
            <el-button @click="cancelLoginClientForm('loginClientForm')">取 消</el-button>
        </div>
    </el-dialog>
 <!-- 呼叫中心登录  dialog end -->
 
 <!-- 呼叫中心退出dialog start -->
     <el-dialog title="呼叫中心" :visible.sync="dialogLogoutClientVisible" class="callCenterDialog" :close-on-click-modal="false">
     <el-button type="text" icon="el-icon-minus" class="minDialog" @click="logoutMin"></el-button>
        <el-form :model="loginClientForm" ref="logoutClientForm" :rules="loginClientForm.clientType==1?trClientFormRules:qimoClientFormRules">
             <span v-if="loginClientForm.clientType==1">已登录天润呼叫中心</span>
             <span v-if="loginClientForm.clientType==2">已登录七陌呼叫中心</span>
            
            <template v-if="loginClientForm.clientType==1">
                <el-form-item label="坐席号：" :label-width="formLabelWidth" prop="cno">
                    {{loginClientForm.cno}}
                </el-form-item>
                 <el-form-item label="绑定电话：" :label-width="formLabelWidth" prop="bindPhone">
                    {{loginClientForm.bindPhone}}
                </el-form-item>
            </template>
            <template v-if="loginClientForm.clientType==2">
                <el-form-item label="登录坐席：" :label-width="formLabelWidth" prop="loginClient">
                    {{loginClientForm.loginClient}}
                </el-form-item>
            </template>
            <el-form-item label="绑定类型：" :label-width="formLabelWidth" prop="bindPhoneType">
                <span v-if="loginClientForm.bindPhoneType==1">普通电话</span>
                <span v-if="loginClientForm.bindPhoneType==2">手机外显</span>
            </el-form-item>
            
        </el-form>
        <div slot="footer" class="dialog-footer" center="true">
            <el-button type="primary" @click="logoutClient('loginClientForm')">退出</el-button>
        </div>
    </el-dialog>
 <!-- 呼叫中心退出  dialog end -->
  <!--外呼 dialog start -->
     <el-dialog :visible.sync="dialogOutboundVisible" :close-on-click-modal="false" class="callCenterDialog1" @close="closeOutboundDialog">
        <el-button type="text" icon="el-icon-minus" class="minDialog1" @click="outboundMin"></el-button>
        <el-form>
             <el-form-item  :label-width="formLabelWidth">
                 <el-input style="float: left;width: 60%;margin-right: 10px;" autocomplete="off"  maxlength="11" v-model="outboundInputPhone"></el-input>
                 <el-button type="primary" icon="fa fa-phone" @click="clickOutbound"></el-button>
             </el-form-item>
        </el-form>
           <!--  <input  type="hidden" id="outboundCallStartTime"/> -->
            <div id="outboundCallTimeDiv"> 本次通话时长：<span id="outboundCallTime"></span></div> 
        
    </el-dialog>
 <!-- 外呼 dialog end -->
 <!-- 外呼 dialog start 其他页面使用 -->
	 <el-dialog  title="提示" :visible.sync="tmOutboundCallDialogVisible" width="30%" :close-on-click-modal="false" center @close="closeTmOutboundDialog" >
	    <div id="tmOutboundCallTimeDiv"> 本次通话时长：<span id="tmOutboundCallTime"></span></div> 
	   
	</el-dialog>
 
 <!-- 外呼 dialog end 其他页面使用 -->
</div>

<div id="anndialog">
    <template>
        <el-dialog
                title="公告通知"
                :visible.sync="anndialogVisible" width="60%">
                <el-table
                        :data="AnnDialogTableData"
                        style="width: 100%">
                    <template v-for="(col ,index) in cols">
                        <el-table-column :prop="col.prop" :label="col.label" header-align="center">
                            <template slot-scope="scope">
                                <span style="white-space: pre-wrap">{{scope.row.content_ }}</span>
                            </template>
                        </el-table-column>
                    </template>
                </el-table>
            <span slot="footer" class="dialog-footer" >
                <el-button type="primary" @click="updateStatusAnn">我知道了</el-button>
            </span>
        </el-dialog>
    </template>
</div>


<div id="bussdialog">
    <template>
        <el-dialog
                title="消息提醒"
                :visible.sync="bussdialogVisible" width="60%">
            <el-table
                    :data="bussDialogTableData"
                    style="width: 100%">
                <template v-for="(col ,index) in cols">
                    <el-table-column :prop="col.prop" :label="col.label" header-align="center">
                        <template slot-scope="scope">
                            <span style="white-space: pre-wrap">{{scope.row.content_ }}</span>
                        </template>
                    </el-table-column>
                </template>
            </el-table>
            <span slot="footer" class="dialog-footer" >
            <el-button type="primary" @click="updateStatusAnn">我知道了</el-button>
        </span>
        </el-dialog>
    </template>
</div>
</body>
<!-- import common js-->
<div th:include="_footer_include :: #jsLib"></div>
<script th:inline="javascript">
    var menuList=[[${menuList}]];//menu list 
    var user=[[${user}]];
    var isUpdatePassword=[[${isUpdatePassword}]];
    var showMenuUrl = menuList[0].subList[0].url;//进首页默认展示页面
    var enterpriseId = [[${enterpriseId}]];
    var token = [[${token}]];
    var accountId = [[${user.id}]];
</script>
<style>
    .el-dialog__footer {
        text-align: center;
    }
    
    /* 最小化按钮 */
    /* .el-dialog__wrapper.callCenterDialog { border:1px solid red; } */
    	.el-dialog__wrapper.callCenterDialog  button.el-dialog__headerbtn { display:none!important; }
    	.minDialog { position: absolute; top:12px; right: 20px; background:#fff; }
    	/* .el-dialog__wrapper.callCenterDialog1  button.el-dialog__headerbtn { display:none!important; } */
        .minDialog1 { position: absolute; top:12px; right:50px; background:#fff; }
</style>

<script>
    var annDialogVm = new Vue({
        el: '#anndialog',
        data:{
            anndialogVisible:false,
            id:"1084034513090117632",
            annRevid:"",
            AnnDialogTableData:[],
            cols:[]
        },
        methods:{
             updateStatusAnn(){
                 var param = {};
                 param.ids = this.annRevid;
                 axios.post('/annReceive/batchUpdate', param)
                     .then(function (response) {
                         annDialogVm.$message({type: 'success', message: '更新完成!',duration:2000,onClose:function(){
                                 homePageVM.messageCount();
                         }});
                     }).catch(function (error) {console.log(error);});
                 annDialogVm.anndialogVisible = false;
             }
            ,initDialogData(){
                var param = {};
                param.id = this.id;
                axios.post('/ann/queryOneAnn', param)
                    .then(function (response) {
                        console.log(response.data)
                        if(response.data.code==0){
                            console.log( response.data.data)
                            annDialogVm.AnnDialogTableData = [{content_:response.data.data.content}]
                            annDialogVm.cols =[{ label: response.data.data.title, prop: "content_", type: "normal" }];
                        }
                    })
                    .catch(function (error) {
                        console.log(error);
                    });
            },
            showOutVisiable:function(){
            }
        }
    });


    var bussDialogVm = new Vue({
        el: '#bussdialog',
        data:{
            bussdialogVisible:false,
            title:"",
            content:"",
            bussRevid:"",
            bussDialogTableData:[],
            cols:[]
        },
        methods:{
            updateStatusAnn(){
                var param = {};
                param.ids = this.bussRevid;
                axios.post('/bussReceive/batchUpdate', param)
                    .then(function (response) {
                        bussDialogVm.$message({type: 'success', message: '更新完成!',duration:2000,onClose:function(){
                                homePageVM.messageCount();
                            }});
                    }).catch(function (error) {console.log(error);});
                bussDialogVm.anndialogVisible = false;
            }
            ,initDialogData(){
                bussDialogVm.AnnDialogTableData = [{content_:this.content}]
                bussDialogVm.cols =[{ label: this.title, prop: "content_", type: "normal" }];
            },
            showOutVisiable:function(){
            }
        }
    });

</script>

<script th:src="@{/js/custom/homepage/index.js?v=1.0.2}"></script>
<script th:src="@{/js/rabbitmq/stomp.js}"></script>
<script th:src="@{/js/rabbitmq/sockjs.js}"></script>



<script type="text/javascript">
    var client;
    var ws_url = '[[${wsUrlHttp}]]';
    var ws_url_https = '[[${wsUrlHttps}]]';
    var mqUserName = '[[${mqUserName}]]';
    var mqPassword = '[[${mqPassword}]]';
    var userId = '[[${userId}]]'

    // var sessionid = '[[${sessionid}]]'
    console.log(userId)
    var urlpath = window.location.href;
    //判断访问地址是否为htts协议
    if(urlpath.indexOf("https://")!=-1){
        ws_url=ws_url_https;
    }
    var ws=null ;
    var numberopt=0;
    function connectMQ() {
        console.log(ws_url+'/ws')
        if (location.search == '?ws') {
            ws = new WebSocket(ws_url+'/ws');
        } else {
            ws = new SockJS(ws_url+'/stomp');
        }
        client = Stomp.over(ws);
        client.heartbeat.outgoing = 30000;//客户端会发送心跳每30000ms
        client.heartbeat.incoming = 0;
        var sessionid='[[${session.sessionid}]]';
        var on_connect = function(x) {
            //只有在登录的时候才能够接收到消息，其他的别的时候是接收不到消息提醒的。
            client.subscribe("/topic/#."+userId, function(data) {
                var msg = data.body;
                console.log("=============================")
                console.log(msg)
                if(msg.indexOf("announce") != -1){
                    var annid = msg.split(",")[1];
                    var annRevid = msg.split(",")[2];
                    homePageVM.messageCount();

                    annDialogVm.id = annid;
                    annDialogVm.annRevid =annRevid
                    console.log(annDialogVm.id)
                    annDialogVm.anndialogVisible=true;
                    annDialogVm.initDialogData();
                }else   if(msg.indexOf("business") != -1){
                    var bussRevid = msg.split(",")[1];
                    var title = msg.split(",")[2];
                    var ccontent = msg.split(",")[3];
                    homePageVM.messageCount();
                    bussDialogVm.id = bussRevid;
                    bussDialogVm.annRevid =annRevid
                    console.log(annDialogVm.id)
                    bussDialogVm.bussdialogVisible=true;
                    bussDialogVm.initDialogData();
                }
            });
            
            client.subscribe("/topic/"+sessionid, function(data) {
            	document.location.href = "/index/logout?type=1";
            });
        };

        var on_error =  function(data) {
            console.log('error');
            if(data.body){data = data.body;}
            //链接一段时间后：链接会断开，断开后自动重连
            if(numberopt==0 && data.indexOf("Whoops! Lost connection")==0) {
                connectMQ();
                // numberopt=1;
                // var param = {"data" : data};
                //$.ajax({type: 'POST', url:rootPath+"/management/index/webSocketLog", contentType : 'application/json', data : JSON.stringify(param), dataType:"json", cache: false, success: function(result){},});
            }
        };
        client.connect(mqUserName, mqPassword, on_connect, on_error, '/');
    }
    connectMQ();
</script>

<!-- <script th:src="@{/js/custom/call/cti-link.js?v=1.0.0}"></script> -->
<script type="text/javascript" src="//agent-gateway-2.cticloud.cn/js/agent/v10/cti-link.js"></script>
<script th:src="@{/js/custom/call/md5.js?v=1.0.0}"></script>
<script th:src="@{/js/custom/call/toolbar.js?v=1.0.1}"></script>
<script th:src="@{/js/custom/call/toolbarIframe.js?v=1.0.1}"></script>
<script th:src="@{/js/custom/call/timer.js?v=1.0.1}"></script>
<script th:src="@{/js/custom/call/rtCall.js?v=1.0.0}"></script> 
</html>