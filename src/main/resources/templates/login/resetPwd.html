<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  xmlns:th="http://www.thymeleaf.org">
<head th:include="_header_include::frag(~{::title},~{},~{})">
    <title>后台管理系统</title>
    <link rel="stylesheet" th:href="@{/css/custom/login/login.css}">
</head>
<body>
    <div id="Loading">
        <div class="loader-inner ball-beat">
            <div></div>
            <div></div>
            <div></div>
        </div>
    </div>
    <div id="loginbox" class="loginbox">
            <div class="control-group normal_text">忘记密码</div>
            <el-form :model="resetPwdForm" :rules="rules" ref="resetPwdForm" label-width="100px" class="demo-resetPwdForm" >
                        <el-row>
                            <el-col :span="4">
                                <span class="ico"><img src="../images/loginIco01.jpg" alt=""></span>
                            </el-col>
                            <el-col :span="20">
                             <el-form-item  prop="phoneInput">
                                <el-input v-model="resetPwdForm.phoneInput" placeholder="输入已注册手机号"></el-input>
                             </el-form-item>
                            </el-col>
                        </el-row>
                            <el-row>
                                <el-col :span="7">
                                    <span class="ico"><img src="../images/loginIco03.jpg" alt=""></span>
                                </el-col>
                                <el-col :span="17">
                                	<el-form-item  prop="codeInput">
                                    	<el-input v-model="resetPwdForm.codeInput" placeholder="输入验证码"></el-input>
                                	</el-form-item>
                                </el-col>
                            </el-row>
                        <el-button type="primary" class="codeBtn" @click="sendCode('resetPwdForm','2');">获取语音验证码</el-button>
            <div class="control-group">
                <div class="codeTip">
                    未收到验证码，使用<span class="link"><a id="msgHref" type="submit" @click="sendCode('resetPwdForm','1');">短信验证码</a></span>
                </div>              
            </div>
                        <el-row>
                            <el-col :span="4">
                                <span class="ico"><img src="../images/loginIco02.jpg" alt=""></span>
                            </el-col>
                            <el-col :span="20">
                             	<el-form-item  prop="pswInput1">
                                	<el-input v-model="resetPwdForm.pswInput1" placeholder="新密码（8-20位，数字和字母组合）"></el-input>
                            	</el-form-item>
                            </el-col>
                        </el-row>
                        <el-row>
                            <el-col :span="4">
                                <span class="ico"><img src="../images/loginIco02.jpg" alt=""></span>
                            </el-col>
                            <el-col :span="20">
                             	<el-form-item  prop="pswInput2">
                                	<el-input v-model="resetPwdForm.pswInput2" placeholder="确认新密码"></el-input>
                            	</el-form-item>
                            </el-col>
                        </el-row>
               </el-form>
            <div class="control-group">
                <!-- 提示语 -->
                <div class="tipBox">
                    <div class="tipCntBox" id="errorSpan"></div>
                </div>              
                <!-- 提示语结束 -->
                <div class="loginBtnBox">
                    <el-button type="primary" class="loginBtn" @click="submitForm('resetPwdForm')">提&nbsp;&nbsp;交</el-button>
                    <el-button type="primary" class="loginBtn" @click="toLogin()">取&nbsp;&nbsp;消</el-button>
                </div>
            </div>
    </div>
</body>
<!-- import common js-->
<div th:include="_footer_include :: #jsLib"></div>
<script>
var vm =  new Vue({
        el: '#loginbox',
        data: {
        	resetPwdForm: {
            	phoneInput: '',
                codeInput:'',
                pswInput1:'',
                pswInput2:''
            },
            rules: {
            	phoneInput: [
                  { required: true, message: '手机号不能为空', trigger: 'blur' },
                  {  max: 11, message: '最大11个字符', trigger: 'blur' }
                ],
                pswInput1: [
                  { required: true, message: '密码不能为空', trigger: 'change' },
                  {  max: 30, message: '最大30个字符', trigger: 'blur' }
                ],
                pswInput2: [
                  { required: true, message: '密码不能为空', trigger: 'change' },
                  {  max: 30, message: '最大30个字符', trigger: 'blur' }
                ],
                codeInput: [
                  { required: true, message: '验证码不能为空', trigger: 'change' },
                  {  max: 6, message: '最大6个字符', trigger: 'blur' }
                ],
              },         
        },
        
        methods: {
        	submitForm(formName) {
       	        this.$refs[formName].validate((valid) => {
       	          if (valid) {
    	             var formData = vm.resetPwdForm;
    	             if(formData.pswInput1!=formData.pswInput2){
    	            	$("#errorSpan").text("新密码与确认密码要保持一致");
 	            		$("#errorSpan").show();
 	            		return;
    	             }
    	             var param={};
    	             param.phone= formData.phoneInput;
    	             param.oldPassword = formData.pswInput1;
    	             param.code = formData.codeInput;
    	             console.info(param);
    	             
    	            axios.post("/login/updatePassword", param)
    	            .then(function (response) {
    	            	console.info(response);
    	            	var data =response.data;
    	            	if(data.code!="0"){
    	            		$("#errorSpan").text(data.msg);
    	            		$("#errorSpan").show();
    	            	}else{
    	                	vm.$message('登录成功');
    	                	document.location.href='/login';
    	            	}
    	            })
    	            .catch(function (error) {
    	                 console.log(error);
    	            });
    	             
       	          } else {
       	        	console.log('数据未通过校验！');
       	            return false;
       	          }
       	        });
       	      },
       	   	  sendCode(formName,type) {
       	    	var valid=true;
	       	  	this.$refs[formName].validateField(["phoneInput"],(error) => {
	    	      if (error) {
	    	    	  valid=false;
	       	      }
   	            });
	       	 	if (valid) {
	    		    var formData = vm.resetPwdForm;
		            var param={};
		            param.phone= formData.phoneInput;
		            param.type = type;
		            console.info(param);
		            axios.post("/login/sendmsgPwd", param)
		 	           .then(function (response) {
		 	           		console.info(response);
		 	            	var data =response.data;
		 	            	var msg="";
	 	            		if(data.code=="0"){
		 	            		if(type=="1"){
		 	            			msg="发送短信验证成功";
		 	            		}else{
		 	            			msg="请注意接听语音来电获取验证码！";
		 	            		}
		 	            	}else {
	    						msg=data.msg;
	    					}
	 	            		$("#errorSpan").text(msg);
	 	            		$("#errorSpan").show();
		 	            })
		 	            .catch(function (error) {
		 	                 console.log(error);
		 	            });
	       	     }else {
	   	        	console.log('数据未通过校验！');
	   	            return false;
	   	          }
       	      },
       	   	  toLogin() {
       	    	document.location.href='/login';
       	      }
        },
        created() {  
            document.body.removeChild(document.getElementById('Loading'));
            
        }
    })
</script>
</html>